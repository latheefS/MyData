create or replace PACKAGE "XXMX_AR_CUSTOMERS_PKG" 
     --
     /*
     *****************************************************************************
     **
     **                 Copyright (c) 2024 Version 1
     **
     **                           Millennium House,
     **                           Millennium Walkway,
     **                           Dublin 1
     **                           D01 F5P8
     **
     **                           All rights reserved.
     **
     *****************************************************************************
     **
     **
     ** FILENAME  :  XXMX_AR_CUSTOMERS_PKG.sql
     **
     ** FILEPATH  :  $XXMX_TOP/install/sql
     **
     ** VERSION   :  1.0
     **
     ** EXECUTE
     ** IN SCHEMA :  APPS
     **
     ** AUTHORS   :  Ian S. Vickerstaff
     **
     ** PURPOSE   :  This script installs the package for the Maximise AR Customers
     **              Data Migration.
     **
     ** NOTES     :
     **
     ******************************************************************************
     **
     ** PRE-REQUISITIES
     ** ---------------
     **
     ** If this script is to be executed as part of an installation script, ensure
     ** that the installation script performs the following tasks prior to calling
     ** this script.
     **
     ** Task  Description
     ** ----  ---------------------------------------------------------------------
     ** 1.    Run the installation script to create all necessary database objects
     **       and Concurrent definitions:
     **
     **            $XXMX_TOP/install/sql/xxmx_ar_trx_stg_dbi.sql
     **            $XXMX_TOP/install/sql/xxmx_ar_trx_xfm_dbi.sql
     **
     ** If this script is not to be executed as part of an installation script,
     ** ensure that the tasks above are, or have been, performed prior to executing
     ** this script.
     **
     ******************************************************************************
     **
     ** CALLING INSTALLATION SCRIPTS
     ** ----------------------------
     **
     ** The following installation scripts call this script:
     **
     ** File Path                                     File Name
     ** --------------------------------------------  ------------------------------
     ** N/A                                           N/A
     **
     ******************************************************************************
     **
     ** CALLED INSTALLATION SCRIPTS
     ** ---------------------------
     **
     ** The following installation scripts are called by this script:
     **
     ** File Path                                    File Name
     ** -------------------------------------------  ------------------------------
     ** N/A                                          N/A
     **
     ******************************************************************************
     **
     ** PARAMETERS
     ** ----------
     **
     ** Parameter                       IN OUT  Type
     ** -----------------------------  ------  ------------------------------------
     ** [parameter_name]                IN OUT
     **
     ******************************************************************************
     **
     ** [previous_filename] HISTORY
     ** -----------------------------
     **
     **   Vsn  Change Date  Changed By          Change Description
     ** -----  -----------  ------------------  -----------------------------------
     ** [ 1.0  DD-Mon-YYYY  Change Author       Created.                          ]
     **
     ******************************************************************************
     **
     ** xxcust_common_pkg.sql HISTORY
     ** ------------------------------------
     **
     **   Vsn  Change Date  Changed By          Change Description
     ** -----  -----------  ------------------  -----------------------------------
     **   1.0  09-JUL-2020  Ian S. Vickerstaff  Created for Maximise.
     **   2.0  12-Apr-2024  Shireesha TR        Added Citco changes     
     **   3.0  24-Apr-2024  Shireesha TR        Added Citco Changes   
     ******************************************************************************
     ******************************************************************************
     */

    AS
    --
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_parties_stg >----------------------------
    -- ------------------------------------------------------------------------------
    --
    PROCEDURE hz_parties_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_party_sites_stg >-----------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_party_sites_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_party_site_uses_stg >------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_party_site_uses_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- -------------------------------< hz_cust_accounts_stg >--------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_cust_accounts_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_cust_acct_sites_stg >--------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_cust_acct_sites_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hzr_account_site_uses_stg >----------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_account_site_uses_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_customer_profiles_stg >-------------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_customer_profiles_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_locations_stg >-------------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_locations_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_relationships_stg >---------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_relationships_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_cust_acct_contact_stg >----------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_cust_acct_contact_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_org_contacts_stg >-------------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_org_contacts_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_contact_roles_stg >--------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_contact_roles_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_contact_points_stg >-------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_contact_points_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_person_language_stg >----------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_person_language_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_party_classifs_stg >-------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_party_classifs_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_role_resps_stg >-------------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_role_resps_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                         );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_cust_acct_relate_stg >----------------------
    -- -----------------------------------------------------------------------------
    PROCEDURE hz_cust_acct_relate_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< ra_cust_rcpt_methods_stg >-------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE ra_cust_rcpt_methods_stg
                        (
                         pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity                  IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< ar_cust_banks_stg >-----------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE ar_cust_banks_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        );
         --
         --
         --******************
         --** PROCEDURE: stg_main
         --******************
         PROCEDURE stg_main
                        (
                         pt_i_ClientCode                 IN      xxmx_client_config_parameters.client_code%TYPE
                        ,pt_i_MigrationSetName           IN      xxmx_migration_headers.migration_set_name%TYPE
                        );
         --
         --
         --*******************
         --** PROCEDURE: purge
         --*******************
         --
         PROCEDURE purge
                       (
                         pt_i_ClientCode                 IN      xxmx_client_config_parameters.client_code%TYPE
                        ,pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                       );
         --
         --
    END xxmx_ar_customers_pkg;
/
--
create or replace PACKAGE BODY "XXMX_AR_CUSTOMERS_PKG" 
    AS
     /*
     **********************
     ** Global Declarations
     **********************
     */
     --
     /* Maximise Integration Globals */
     --
     /* Global Constants for use in all xxmx_utilities_pkg Procedure/Function Calls within this package */
     --
     gcv_PackageName                           CONSTANT VARCHAR2(30)                                 := 'xxmx_ar_customers_pkg';
     gct_ApplicationSuite                      CONSTANT xxmx_module_messages.application_suite%TYPE  := 'FIN';
     gct_Application                           CONSTANT xxmx_module_messages.application%TYPE        := 'AR';
     gct_StgSchema                             CONSTANT VARCHAR2(10)                                 := 'xxmx_stg';
     gct_XfmSchema                             CONSTANT VARCHAR2(10)                                 := 'xxmx_xfm';
     gct_CoreSchema                            CONSTANT VARCHAR2(10)                                 := 'xxmx_core';
     gcv_BusinessEntity                        CONSTANT xxmx_migration_metadata.business_entity%TYPE := 'CUSTOMERS';
     gct_OrigSystem                            CONSTANT VARCHAR2(10)                                 := 'ORACLER12';
     --
     /* Global Progress Indicator Variable for use in all Procedures/Functions within this package */
     --
     gvv_ProgressIndicator                              VARCHAR2(100);
     --
     /* Global Variables for receiving Status/Messages from certain Procedure/Function Calls (e.g. xxmx_utilities_pkg.clear_messages */
     --
     gvv_ReturnStatus                                   VARCHAR2(1);
     gvt_ReturnMessage                                  xxmx_module_messages.module_message%TYPE;
     --
     /* Global Variables for Exception Handlers */
     --
     gvt_Severity                                       xxmx_module_messages.severity%TYPE;
     gvt_ModuleMessage                                  xxmx_module_messages.module_message%TYPE;
     gvt_OracleError                                    xxmx_module_messages.oracle_error%TYPE;
     --
     /* Global Variables for Exception Handlers */
     --
     gvt_MigrationSetName                               xxmx_migration_headers.migration_set_name%TYPE;
     --
     /* Global constants and variables for dynamic SQL usage */
     --
     gcv_SQLSpace                             CONSTANT  VARCHAR2(1) := ' ';
     gvv_SQLAction                                      VARCHAR2(20);
     gvv_SQLTableClause                                 VARCHAR2(100);
     gvv_SQLColumnList                                  VARCHAR2(4000);
     gvv_SQLValuesList                                  VARCHAR2(4000);
     gvv_SQLWhereClause                                 VARCHAR2(4000);
     gvv_SQLStatement                                   VARCHAR2(32000);
     gvv_SQLResult                                      VARCHAR2(4000);
     --
     /* Global variables for holding table row counts */
     --
     gvn_RowCount                                       NUMBER;
     --
         PROCEDURE hz_parties_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
        IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_parties
              -- WITH clause gets BUSINESS, PERSON, PARTY_RELATIONSHIP entries for every party involved
              -- with sites/accounts in the selection criteria.
              -- First part are parties used by accounts
              -- Second Part are parties used by sites, which include party relationships
              -- Third and Fourth parts add any parties involved in party relationships with the accounts party
            CURSOR hz_parties_cur
            IS
                 WITH selection
                AS (
                      select distinct account_party_id party_id
                      from   XXMX_CUSTOMER_SCOPE_TEMP_STG
                    UNION
                      select distinct site_party_id party_id
                      from   XXMX_CUSTOMER_SCOPE_TEMP_STG
                    UNION
                      select distinct subject_id party_id
                      from   XXMX_CUSTOMER_SCOPE_TEMP_STG selection,
                             apps.hz_relationships@MXDM_NVIS_EXTRACT  hr
                      where  hr.object_id          = selection.account_party_id
                      and    hr.object_table_name  = 'HZ_PARTIES'
                      AND    hr.status             = 'A'
                      and    hr.subject_table_name = 'HZ_PARTIES'
                      and    directional_flag      = 'F'
                      and    (hr.end_date is null or hr.end_date >= trunc(sysdate))
                    UNION
                      select distinct object_id party_id
                      from   XXMX_CUSTOMER_SCOPE_TEMP_STG selection,
                             apps.hz_relationships@MXDM_NVIS_EXTRACT  hr
                      where  hr.subject_id         = selection.account_party_id
                      and    hr.object_table_name  = 'HZ_PARTIES'
                      AND    hr.status             = 'A'
                      and    hr.subject_table_name = 'HZ_PARTIES'
                      and    directional_flag      = 'F'
                      and    (hr.end_date is null or hr.end_date >= trunc(sysdate))
                   )
                SELECT
                        gct_OrigSystem                                                                                               party_orig_system
                       ,selection.party_id                                                                                           party_orig_system_reference
                       ,NULL                                                                                                         insert_update_flag
                       ,hp.party_type                                                                                                party_type
                       ,hp.party_number                                                                                              party_number
                       ,hp.salutation                                                                                                salutation
                       ,(
                         SELECT hpua.party_usage_code
                         FROM   apps.hz_party_usg_assignments@MXDM_NVIS_EXTRACT hpua
                         WHERE  1 = 1
                         AND    hpua.party_id          = hp.party_id
                         AND    hpua.party_usage_code  = 'CUSTOMER'
                         AND    hpua.status_flag       = 'A'
                         AND    TRUNC(SYSDATE)        >= hpua.effective_start_date
                         AND    TRUNC(SYSDATE)        <= NVL(hpua.effective_end_date, SYSDATE + 1)
                        )                                                                                                            party_usage_code
                       ,hp.jgzz_fiscal_code                                                                                          jgzz_fiscal_code
                       ,CASE WHEN hp.party_type != 'PERSON'
                             THEN hp.party_name
                             ELSE ''  END                                                                                            organization_name
                       ,hp.duns_number_c                                                                                             duns_number_c
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN hp.person_first_name
                             ELSE ''  END                                                                                            person_first_name
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN hp.person_last_name
                             ELSE ''  END                                                                                            person_last_name
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN ''
                             ELSE ''  END                                                                                            person_last_name_prefix
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN hp.person_previous_last_name
                             ELSE ''  END                                                                                            person_second_last_name
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN hp.person_middle_name
                             ELSE ''  END                                                                                            person_middle_name
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN hp.person_name_suffix
                             ELSE ''  END                                                                                            person_name_suffix
                       ,CASE WHEN hp.party_type = 'PERSON'
                             THEN hp.person_pre_name_adjunct
                             ELSE ''  END                                                                                            person_title
                       ,hp.attribute_category                                                                                        attribute_category
                       ,NULL                                                                                                         attribute1
                       ,NULL                                                                                                         attribute2
                       ,NULL                                                                                                         attribute3
                       ,NULL                                                                                                         attribute4
                       ,NULL                                                                                                         attribute5
                       ,NULL                                                                                                         attribute6
                       ,NULL                                                                                                         attribute7
                       ,NULL                                                                                                         attribute8
                       ,NULL                                                                                                         attribute9
                       ,NULL                                                                                                         attribute10
                       ,NULL                                                                                                         attribute11
                       ,NULL                                                                                                         attribute12
                       ,NULL                                                                                                         attribute13
                       ,NULL                                                                                                         attribute14
                       ,NULL                                                                                                         attribute15
                       ,NULL                                                                                                         attribute16
                       ,NULL                                                                                                         attribute17
                       ,NULL                                                                                                         attribute18
                       ,NULL                                                                                                         attribute19
                       ,NULL                                                                                                         attribute20
                       ,NULL                                                                                                         attribute21
                       ,NULL                                                                                                         attribute22
                       ,NULL                                                                                                         attribute23
                       ,NULL                                                                                                         attribute24
                       ,NULL                                                                                                         attribute25
                       ,NULL                                                                                                         attribute26
                       ,NULL                                                                                                         attribute27
                       ,NULL                                                                                                         attribute28
                       ,NULL                                                                                                         attribute29
                       ,NULL                                                                                                         attribute30
                       ,NULL                                                                                                         load_request_id
                FROM   selection,
                       apps.hz_parties@MXDM_NVIS_EXTRACT        hp
                WHERE  hp.party_id   = selection.party_id;
                --
             --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
              TYPE hz_parties_tt IS TABLE OF hz_parties_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
              --
              cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_parties_stg';
              ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
              ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_parties_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --
              hz_parties_tbl                     hz_parties_tt;
              --
              --
              --*************************
              --** Exception Declarations
              --*************************
              --
              --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
              --** before raising this exception.
              --
              e_ModuleError                   EXCEPTION;
              --
              --
     --** END Declarations
     --
     --
     BEGIN
          --
          --
          gvv_ProgressIndicator := '0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          --
          --
          --** DSF 28/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => 'Procedure "'
                                                ||gcv_PackageName
                                                ||'.'
                                                ||cv_ProcOrFuncName
                                                ||'" initiated.'
                    ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
                gvv_ProgressIndicator :='0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "HZ_PARTIES":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
                --
                --
                OPEN hz_parties_cur;
                --
                --
                LOOP
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    FETCH hz_parties_cur
                    BULK COLLECT
                    INTO hz_parties_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN    hz_parties_tbl.COUNT = 0;
                    --
                    gvv_ProgressIndicator := '0080';
                    --
                    FORALL i IN 1..hz_parties_tbl.count
                    --
                    --
                    INSERT
                    INTO xxmx_hz_parties_stg
                      (
                         migration_set_id
                        ,migration_set_name
                        ,migration_status
                        ,party_orig_system
                        ,party_orig_system_reference
                        ,insert_update_flag
                        ,party_type
                        ,party_number
                        ,salutation
                        ,party_usage_code
                        ,jgzz_fiscal_code
                        ,organization_name
                        ,duns_number_c
                        ,person_first_name
                        ,person_last_name
                        ,person_last_name_prefix
                        ,person_second_last_name
                        ,person_middle_name
                        ,person_name_suffix
                        ,person_title
                        ,attribute_category
                        ,attribute1
                        ,attribute2
                        ,attribute3
                        ,attribute4
                        ,attribute5
                        ,attribute6
                        ,attribute7
                        ,attribute8
                        ,attribute9
                        ,attribute10
                        ,attribute11
                        ,attribute12
                        ,attribute13
                        ,attribute14
                        ,attribute15
                        ,attribute16
                        ,attribute17
                        ,attribute18
                        ,attribute19
                        ,attribute20
                        ,attribute21
                        ,attribute22
                        ,attribute23
                        ,attribute24
                        ,attribute25
                        ,attribute26
                        ,attribute27
                        ,attribute28
                        ,attribute29
                        ,attribute30
                        ,load_request_id
                        --,creation_date
                        --,created_by
                        --,last_update_date
                        --,last_updated_by
                      ) VALUES (
                                      pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                     ,gvt_MigrationSetName                               --migration_set_name
                                     ,'EXTRACTED'                                       --MIGRATION_STATUS
                                     ,hz_parties_tbl(i).party_orig_system
                                     ,hz_parties_tbl(i).party_orig_system_reference
                                     ,hz_parties_tbl(i).insert_update_flag
                                     ,hz_parties_tbl(i).party_type
                                     ,hz_parties_tbl(i).party_number
                                     ,hz_parties_tbl(i).salutation
                                     ,hz_parties_tbl(i).party_usage_code
                                     ,hz_parties_tbl(i).jgzz_fiscal_code
                                     ,hz_parties_tbl(i).organization_name
                                     ,hz_parties_tbl(i).duns_number_c
                                     ,hz_parties_tbl(i).person_first_name
                                     ,hz_parties_tbl(i).person_last_name
                                     ,hz_parties_tbl(i).person_last_name_prefix
                                     ,hz_parties_tbl(i).person_second_last_name
                                     ,hz_parties_tbl(i).person_middle_name
                                     ,hz_parties_tbl(i).person_name_suffix
                                     ,hz_parties_tbl(i).person_title
                                     ,hz_parties_tbl(i).attribute_category
                                     ,hz_parties_tbl(i).attribute1
                                     ,hz_parties_tbl(i).attribute2
                                     ,hz_parties_tbl(i).attribute3
                                     ,hz_parties_tbl(i).attribute4
                                     ,hz_parties_tbl(i).attribute5
                                     ,hz_parties_tbl(i).attribute6
                                     ,hz_parties_tbl(i).attribute7
                                     ,hz_parties_tbl(i).attribute8
                                     ,hz_parties_tbl(i).attribute9
                                     ,hz_parties_tbl(i).attribute10
                                     ,hz_parties_tbl(i).attribute11
                                     ,hz_parties_tbl(i).attribute12
                                     ,hz_parties_tbl(i).attribute13
                                     ,hz_parties_tbl(i).attribute14
                                     ,hz_parties_tbl(i).attribute15
                                     ,hz_parties_tbl(i).attribute16
                                     ,hz_parties_tbl(i).attribute17
                                     ,hz_parties_tbl(i).attribute18
                                     ,hz_parties_tbl(i).attribute19
                                     ,hz_parties_tbl(i).attribute20
                                     ,hz_parties_tbl(i).attribute21
                                     ,hz_parties_tbl(i).attribute22
                                     ,hz_parties_tbl(i).attribute23
                                     ,hz_parties_tbl(i).attribute24
                                     ,hz_parties_tbl(i).attribute25
                                     ,hz_parties_tbl(i).attribute26
                                     ,hz_parties_tbl(i).attribute27
                                     ,hz_parties_tbl(i).attribute28
                                     ,hz_parties_tbl(i).attribute29
                                     ,hz_parties_tbl(i).attribute30
                                     ,hz_parties_tbl(i).load_request_id
                                     --,hz_parties_tbl(i).creation_date
                                     --,hz_parties_tbl(i).created_by
                                     --,hz_parties_tbl(i).last_update_date
                                     --,hz_parties_tbl(i).last_updated_by
                                );
                             --
                             --
                        --** END FORALL
                        --
                        --
                END LOOP;
                   --
                   --
                gvv_ProgressIndicator :='0090';
                --
                --
                COMMIT;
                --
                --
                gvv_ProgressIndicator :='0100';
                --
                --
                CLOSE hz_parties_cur;
                --
               --
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
                --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
              --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => 'Procedure "'
                                                 ||gcv_PackageName
                                                 ||'.'
                                                 ||cv_ProcOrFuncName
                                                 ||'" completed.'
                    ,pt_i_OracleError         => NULL
                    );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_parties_cur%ISOPEN
                    THEN
                    CLOSE hz_parties_cur;
                    END IF;
                    ROLLBACK;
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END e_ModuleError Exception
               --
               --
               WHEN OTHERS
               THEN
                    --
                    --
                    IF hz_parties_cur%ISOPEN
                    THEN
                    CLOSE hz_parties_cur;
                    END IF;
                    ROLLBACK;
                    --
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite     => gct_ApplicationSuite
                         ,pt_i_Application          => gct_Application
                         ,pt_i_BusinessEntity       => gcv_BusinessEntity
                         ,pt_i_SubEntity            => pt_i_SubEntity
                         ,pt_i_MigrationSetID       => pt_i_MigrationSetID
                         ,pt_i_Phase                => ct_Phase
                         ,pt_i_PackageName          => gcv_PackageName
                         ,pt_i_ProcOrFuncName       => cv_ProcOrFuncName
                         ,pt_i_Severity             => 'ERROR'
                         ,pt_i_ProgressIndicator    => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage        => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError          => gvt_OracleError
                         );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        end hz_parties_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_PARTY_SITE >-----------------------
    -- ------------------------------------------------------------------------------
    --
    -- Update  : amended Location Orig System Reference to include party site id as 
	-- 16/09/21  fusion does not allow the same location to be assigned to different 
	--           sites. We need to create separate addresses.
    --
	-- ------------------------------------------------------------------------------
        PROCEDURE hz_party_sites_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                         )
        IS
        -- Cursor to FETCH the Party Site details from SRC_AR_PARTY_SITE
        CURSOR hz_party_sites_cur

        IS
            WITH selection
            AS
                (SELECT DISTINCT PARTY_SITE_ID, SITE_PARTY_ID PARTY_ID
                 FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
            SELECT
                   gct_OrigSystem                                                                                              party_orig_system
                  ,selection.party_id                                                                                          party_orig_system_reference
                  ,gct_OrigSystem                                                                                              site_orig_system
--                  ,selection.party_site_id                                                                                     site_orig_system_reference
                  ,hps.party_id||'-'||hps.party_site_number                                                                    site_orig_system_reference -- CPL
                  ,gct_OrigSystem                                                                                              location_orig_system
                  ,hps.party_site_id||'_'||hps.location_id                                                                     location_orig_system_reference
                  ,NULL                                                                                                        insert_update_flag
                  ,hps.party_site_name                                                                                         party_site_name
--                  ,hps.party_site_number                                                                                       party_site_number  -- CPL
                  ,hps.party_site_number                                                                                       party_site_number
                  ,nvl(hps.start_date_active,hps.creation_date)                                                                start_date_active
                  ,hps.end_date_active                                                                                         end_date_active
                  ,hps.mailstop                                                                                                mailstop
                  ,hps.identifying_address_flag                                                                                identifying_address_flag
                  ,hps.LANGUAGE                                                                                                party_site_language
                  ,NULL/*hps.attribute_category*/                                                                              attribute_category
                  ,NULL/*hps.attribute1*/                                                                                      attribute1
                  ,NULL/*hps.attribute2*/                                                                                      attribute2
                  ,NULL/*hps.attribute3*/                                                                                      attribute3
                  ,NULL/*hps.attribute4*/                                                                                      attribute4
                  ,NULL/*hps.attribute5*/                                                                                      attribute5
                  ,NULL/*hps.attribute6*/                                                                                      attribute6
                  ,NULL/*hps.attribute7*/                                                                                      attribute7
                  ,NULL/*hps.attribute8*/                                                                                      attribute8
                  ,NULL/*hps.attribute9*/                                                                                      attribute9
                  ,NULL/*hps.attribute10*/                                                                                     attribute10
                  ,NULL/*hps.attribute11*/                                                                                     attribute11
                  ,NULL/*hps.attribute12*/                                                                                     attribute12
                  ,NULL/*hps.attribute13*/                                                                                     attribute13
                  ,NULL/*hps.attribute14*/                                                                                     attribute14
                  ,NULL/*hps.attribute15*/                                                                                     attribute15
                  ,NULL/*hps.attribute16*/                                                                                     attribute16
                  ,NULL/*hps.attribute17*/                                                                                     attribute17
                  ,NULL/*hps.attribute18*/                                                                                     attribute18
                  ,NULL/*hps.attribute19*/                                                                                     attribute19
                  ,NULL/*hps.attribute20*/                                                                                     attribute20
                  ,NULL                                                                                                        attribute21
                  ,NULL                                                                                                        attribute22
                  ,NULL                                                                                                        attribute23
                  ,NULL                                                                                                        attribute24
                  ,NULL                                                                                                        attribute25
                  ,NULL                                                                                                        attribute26
                  ,NULL                                                                                                        attribute27
                  ,NULL                                                                                                        attribute28
                  ,NULL                                                                                                        attribute29
                  ,NULL                                                                                                        attribute30
                  ,NULL                                                                                                        rel_orig_system
                  ,NULL                                                                                                        rel_orig_system_reference
                  ,NULL                                                                                                        load_request_id
            FROM   selection,
                   apps.hz_party_sites@MXDM_NVIS_EXTRACT          hps
--                  ,apps.hz_parties@MXDM_NVIS_EXTRACT              hp
--                  ,apps.hz_cust_acct_sites_all@MXDM_NVIS_EXTRACT hcasa
            WHERE hps.party_site_id    = selection.party_site_id
--            AND   hps.party_id         = hp.party_id
--            AND   hcasa.party_site_id  = hps.party_site_id
--            AND   hps.status           = 'A'
--            AND   hp.status            = 'A'
            ;
                   --
                   --
              --** END CURSOR **
              --
              --
              --********************
              --** Type Declarations
              --********************
              --
                TYPE hz_party_sites_tt IS TABLE OF hz_party_sites_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
              cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_party_sites_stg';
              ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
              ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_party_sites_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

            hz_party_sites_tbl                 hz_party_sites_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** DSF 28/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => 'Procedure "'
                                                 ||gcv_PackageName
                                                 ||'.'
                                                 ||cv_ProcOrFuncName
                                                 ||'" initiated.'
                    ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
                   OPEN hz_party_sites_cur;
                   --
                   --
                   --xxmx_utilities_pkg.out_message(' After OPEN hz_party_sites_cur');
                   --
                   --
                              gvv_ProgressIndicator :='0070';
                   --
                   --
                   LOOP
                        --
                        --
                        FETCH hz_party_sites_cur
                        BULK COLLECT
                        INTO hz_party_sites_tbl
                        LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                        --
                        --
                        EXIT WHEN hz_party_sites_tbl.COUNT=0;
                        --
                        --
                        gvv_ProgressIndicator :='0070';
                        --
                        --

                        FORALL i IN 1..hz_party_sites_tbl.COUNT
                        --
                        --
                        INSERT
                        INTO xxmx_hz_party_sites_stg
                                (
                                      migration_set_id
                                     ,migration_set_name
                                     ,migration_status
                                     ,party_orig_system
                                     ,party_orig_system_reference
                                     ,site_orig_system
                                     ,site_orig_system_reference
                                     ,location_orig_system
                                     ,location_orig_system_reference
                                     ,insert_update_flag
                                     ,party_site_name
                                     ,party_site_number
                                     ,start_date_active
                                     ,end_date_active
                                     ,mailstop
                                     ,identifying_address_flag
                                     ,party_site_language
                                     ,attribute_category
                                     ,attribute1
                                     ,attribute2
                                     ,attribute3
                                     ,attribute4
                                     ,attribute5
                                     ,attribute6
                                     ,attribute7
                                     ,attribute8
                                     ,attribute9
                                     ,attribute10
                                     ,attribute11
                                     ,attribute12
                                     ,attribute13
                                     ,attribute14
                                     ,attribute15
                                     ,attribute16
                                     ,attribute17
                                     ,attribute18
                                     ,attribute19
                                     ,attribute20
                                     ,attribute21
                                     ,attribute22
                                     ,attribute23
                                     ,attribute24
                                     ,attribute25
                                     ,attribute26
                                     ,attribute27
                                     ,attribute28
                                     ,attribute29
                                     ,attribute30
                                     ,rel_orig_system
                                     ,rel_orig_system_reference
                                     ,load_request_id
                                     --,creation_date
                                     --,created_by
                                     --,last_update_date
                                     --,last_updated_by
                                )
                                VALUES (
                                      pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                     ,gvt_MigrationSetName                               --migration_set_name
                                     ,'EXTRACTED'                                       --MIGRATION_STATUS
                                     ,hz_party_sites_tbl(i).party_orig_system
                                     ,hz_party_sites_tbl(i).party_orig_system_reference
                                     ,hz_party_sites_tbl(i).site_orig_system
                                     ,hz_party_sites_tbl(i).site_orig_system_reference
                                     ,hz_party_sites_tbl(i).location_orig_system
                                     ,hz_party_sites_tbl(i).location_orig_system_reference
                                     ,hz_party_sites_tbl(i).insert_update_flag
                                     ,hz_party_sites_tbl(i).party_site_name
                                     ,hz_party_sites_tbl(i).party_site_number
                                     ,hz_party_sites_tbl(i).start_date_active
                                     ,hz_party_sites_tbl(i).end_date_active
                                     ,hz_party_sites_tbl(i).mailstop
                                     ,hz_party_sites_tbl(i).identifying_address_flag
                                     ,hz_party_sites_tbl(i).party_site_language
                                     ,hz_party_sites_tbl(i).attribute_category
                                     ,hz_party_sites_tbl(i).attribute1
                                     ,hz_party_sites_tbl(i).attribute2
                                     ,hz_party_sites_tbl(i).attribute3
                                     ,hz_party_sites_tbl(i).attribute4
                                     ,hz_party_sites_tbl(i).attribute5
                                     ,hz_party_sites_tbl(i).attribute6
                                     ,hz_party_sites_tbl(i).attribute7
                                     ,hz_party_sites_tbl(i).attribute8
                                     ,hz_party_sites_tbl(i).attribute9
                                     ,hz_party_sites_tbl(i).attribute10
                                     ,hz_party_sites_tbl(i).attribute11
                                     ,hz_party_sites_tbl(i).attribute12
                                     ,hz_party_sites_tbl(i).attribute13
                                     ,hz_party_sites_tbl(i).attribute14
                                     ,hz_party_sites_tbl(i).attribute15
                                     ,hz_party_sites_tbl(i).attribute16
                                     ,hz_party_sites_tbl(i).attribute17
                                     ,hz_party_sites_tbl(i).attribute18
                                     ,hz_party_sites_tbl(i).attribute19
                                     ,hz_party_sites_tbl(i).attribute20
                                     ,hz_party_sites_tbl(i).attribute21
                                     ,hz_party_sites_tbl(i).attribute22
                                     ,hz_party_sites_tbl(i).attribute23
                                     ,hz_party_sites_tbl(i).attribute24
                                     ,hz_party_sites_tbl(i).attribute25
                                     ,hz_party_sites_tbl(i).attribute26
                                     ,hz_party_sites_tbl(i).attribute27
                                     ,hz_party_sites_tbl(i).attribute28
                                     ,hz_party_sites_tbl(i).attribute29
                                     ,hz_party_sites_tbl(i).attribute30
                                     ,hz_party_sites_tbl(i).rel_orig_system
                                     ,hz_party_sites_tbl(i).rel_orig_system_reference
                                     ,hz_party_sites_tbl(i).load_request_id
                                     --,hz_party_sites_tbl(i).creation_date
                                     --,hz_party_sites_tbl(i).created_by
                                     --,hz_party_sites_tbl(i).last_update_date
                                     --,hz_party_sites_tbl(i).last_updated_by
                            );
                             --
                             --
                        --** END FORALL
                        --
                        --
                   END LOOP;
                   --
                   --
               gvv_ProgressIndicator :='0080';
                   --
                   --
                   --
                   COMMIT;
                   --
                   --
               gvv_ProgressIndicator :='0090';
                   --
                   --
                   CLOSE hz_party_sites_cur;
               --
               --
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0100';
               --
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => 'Procedure "'
                                                 ||gcv_PackageName
                                                 ||'.'
                                                 ||cv_ProcOrFuncName
                                                 ||'" completed.'
                    ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_party_sites_cur%ISOPEN
                    THEN
                         CLOSE hz_party_sites_cur;
                    END IF;
                    --
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END e_ModuleError Exception
               --
               --
               WHEN OTHERS
               THEN
                    --
                    --
                        --
                    IF hz_party_sites_cur%ISOPEN
                    THEN
                        CLOSE hz_party_sites_cur;
                    END IF;
                    --
                    --
                    ROLLBACK;
                    --
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                         pt_i_ApplicationSuite     => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        END hz_party_sites_stg;
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_PARTY_SITE_USES >------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_party_site_uses_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                         )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_party_site_uses_stg
              --
        CURSOR hz_party_site_uses_cur
        IS
            WITH selection
            AS
                (SELECT DISTINCT PARTY_SITE_ID, SITE_PARTY_ID PARTY_ID,
                                 CUST_ACCT_SITE_ID, ORG_ID
                 FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
            SELECT DISTINCT
                         gct_OrigSystem                                                                                              party_orig_system
                        ,selection.party_id                                                                                          party_orig_system_reference
                        ,gct_OrigSystem                                                                                              site_orig_system
--                        ,selection.party_site_id                                                                                     site_orig_system_reference -- CPL
                        ,hps.party_id||'-'||hps.party_site_number                                                                    site_orig_system_reference -- CPL
                        ,hpsu.site_use_type                                                                                          site_use_type
                        ,hpsu.primary_per_type                                                                                       primary_flag
                        ,NULL                                                                                                        insert_update_flag
                        ,nvl(hps.start_date_active,hps.creation_date)                                                                start_date
                        ,hps.end_date_active                                                                                         end_date
                        ,NULL                                                                                                        attribute_category
                        ,NULL                                                                                                        attribute1
                        ,NULL                                                                                                        attribute2
                        ,NULL                                                                                                        attribute3
                        ,NULL                                                                                                        attribute4
                        ,NULL                                                                                                        attribute5
                        ,NULL                                                                                                        attribute6
                        ,NULL                                                                                                        attribute7
                        ,NULL                                                                                                        attribute8
                        ,NULL                                                                                                        attribute9
                        ,NULL                                                                                                        attribute10
                        ,NULL                                                                                                        attribute11
                        ,NULL                                                                                                        attribute12
                        ,NULL                                                                                                        attribute13
                        ,NULL                                                                                                        attribute14
                        ,NULL                                                                                                        attribute15
                        ,NULL                                                                                                        attribute16
                        ,NULL                                                                                                        attribute17
                        ,NULL                                                                                                        attribute18
                        ,NULL                                                                                                        attribute19
                        ,NULL                                                                                                        attribute20
                        ,NULL                                                                                                        attribute21
                        ,NULL                                                                                                        attribute22
                        ,NULL                                                                                                        attribute23
                        ,NULL                                                                                                        attribute24
                        ,NULL                                                                                                        attribute25
                        ,NULL                                                                                                        attribute26
                        ,NULL                                                                                                        attribute27
                        ,NULL                                                                                                        attribute28
                        ,NULL                                                                                                        attribute29
                        ,NULL                                                                                                        attribute30
                        ,gct_OrigSystem                                                                                              siteuse_orig_system
                        ,hpsu.party_site_use_id                                                                                      siteuse_orig_system_ref
                        ,NULL                                                                                                        load_request_id
            FROM   selection
                  ,apps.hz_party_site_uses@MXDM_NVIS_EXTRACT     hpsu
                  ,apps.hz_party_sites@MXDM_NVIS_EXTRACT         hps
            WHERE   1=1
            AND hpsu.party_site_id = selection.party_site_id
            AND hpsu.status        = 'A'
            --AND hpsu.site_use_type not in ('BOL','ACK','INV','DRAWEE')  -- SMBC Spec
            AND hps.party_site_id  = hpsu.party_site_id;
                   --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
        TYPE hz_party_site_uses_tt IS TABLE OF hz_party_site_uses_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_party_site_uses_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_party_site_uses_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_party_site_uses_tbl hz_party_site_uses_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
           /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
         --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError       => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                ||ct_StgTable
                                                ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError       => NULL
                    );
               --
               --
               OPEN hz_party_site_uses_cur;
               --
               --
               -- Extract Customer Site Uses into Stagimg Table
               --
               LOOP
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    FETCH hz_party_site_uses_cur
                    BULK COLLECT
                    INTO hz_party_site_uses_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    --
                    --
                    EXIT WHEN hz_party_site_uses_tbl.COUNT=0;
                    --
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    --
                    FORALL i IN 1..hz_party_site_uses_tbl.COUNT
                    --
                    --
                    INSERT
                    INTO xxmx_hz_party_site_uses_stg
                            (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,party_orig_system
                                 ,party_orig_system_reference
                                 ,site_orig_system
                                 ,site_orig_system_reference
                                 ,site_use_type
                                 ,primary_flag
                                 ,insert_update_flag
                                 ,start_date
                                 ,end_date
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,siteuse_orig_system
                                 ,siteuse_orig_system_ref
                                 ,load_request_id
                                 --,migration_set_name
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                        )
                  VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_party_site_uses_tbl(i).party_orig_system
                                 ,hz_party_site_uses_tbl(i).party_orig_system_reference
                                 ,hz_party_site_uses_tbl(i).site_orig_system
                                 ,hz_party_site_uses_tbl(i).site_orig_system_reference
                                 ,hz_party_site_uses_tbl(i).site_use_type
                                 ,hz_party_site_uses_tbl(i).primary_flag
                                 ,hz_party_site_uses_tbl(i).insert_update_flag
                                 ,hz_party_site_uses_tbl(i).start_date
                                 ,hz_party_site_uses_tbl(i).end_date
                                 ,hz_party_site_uses_tbl(i).attribute_category
                                 ,hz_party_site_uses_tbl(i).attribute1
                                 ,hz_party_site_uses_tbl(i).attribute2
                                 ,hz_party_site_uses_tbl(i).attribute3
                                 ,hz_party_site_uses_tbl(i).attribute4
                                 ,hz_party_site_uses_tbl(i).attribute5
                                 ,hz_party_site_uses_tbl(i).attribute6
                                 ,hz_party_site_uses_tbl(i).attribute7
                                 ,hz_party_site_uses_tbl(i).attribute8
                                 ,hz_party_site_uses_tbl(i).attribute9
                                 ,hz_party_site_uses_tbl(i).attribute10
                                 ,hz_party_site_uses_tbl(i).attribute11
                                 ,hz_party_site_uses_tbl(i).attribute12
                                 ,hz_party_site_uses_tbl(i).attribute13
                                 ,hz_party_site_uses_tbl(i).attribute14
                                 ,hz_party_site_uses_tbl(i).attribute15
                                 ,hz_party_site_uses_tbl(i).attribute16
                                 ,hz_party_site_uses_tbl(i).attribute17
                                 ,hz_party_site_uses_tbl(i).attribute18
                                 ,hz_party_site_uses_tbl(i).attribute19
                                 ,hz_party_site_uses_tbl(i).attribute20
                                 ,hz_party_site_uses_tbl(i).attribute21
                                 ,hz_party_site_uses_tbl(i).attribute22
                                 ,hz_party_site_uses_tbl(i).attribute23
                                 ,hz_party_site_uses_tbl(i).attribute24
                                 ,hz_party_site_uses_tbl(i).attribute25
                                 ,hz_party_site_uses_tbl(i).attribute26
                                 ,hz_party_site_uses_tbl(i).attribute27
                                 ,hz_party_site_uses_tbl(i).attribute28
                                 ,hz_party_site_uses_tbl(i).attribute29
                                 ,hz_party_site_uses_tbl(i).attribute30
                                 ,hz_party_site_uses_tbl(i).siteuse_orig_system
                                 ,hz_party_site_uses_tbl(i).siteuse_orig_system_ref
                                 ,hz_party_site_uses_tbl(i).load_request_id
                                 --,hz_party_site_uses_tbl(i).creation_date
                                 --,hz_party_site_uses_tbl(i).created_by
                                 --,hz_party_site_uses_tbl(i).last_update_date
                                 --,hz_party_site_uses_tbl(i).last_updated_by
                        );
                         --
                         --
                    --** END FORALL
                    --
                    --
               END LOOP;
               --
               --
               gvv_ProgressIndicator :='0090';
               --
               --
               COMMIT;
               --
               --
               gvv_ProgressIndicator :='0100';
               --
               --
               CLOSE hz_party_site_uses_cur;
               --
               --
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_party_site_uses_cur%ISOPEN
                    THEN
                        CLOSE hz_party_site_uses_cur;
                    END IF;
                    ROLLBACK;
                     --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END e_ModuleError Exception
               --
               --
               WHEN OTHERS
               THEN
                    --
                    --
                    IF hz_party_site_uses_cur%ISOPEN
                    THEN
                        CLOSE hz_party_site_uses_cur;
                    END IF;
                    ROLLBACK;
                    --
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage      => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        END hz_party_site_uses_stg;
    --
    -- ----------------------------------------------------------------------------
    -- -------------------------------< SRC_AR_CUSTOMER_ACCOUNT >------------------
    -- ----------------------------------------------------------------------------
        PROCEDURE hz_cust_accounts_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
        IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_cust_accounts_stg
              --
              cursor hz_cust_accts_cur
              IS
                WITH selection
                AS
                    (SELECT DISTINCT cust_account_id
                     FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
                SELECT
                             gct_OrigSystem                                                                                         cust_orig_system
                            ,hca.account_number                                                                                     cust_orig_system_reference
                            ,gct_OrigSystem                                                                                         party_orig_system
                            ,hca.party_id                                                                                           party_orig_system_reference
                            ,hca.account_number                                                                                     account_number
                            ,NULL                                                                                                   insert_update_flag
                            ,hca.customer_type                                                                                      customer_type
                            ,hca.customer_class_code                                                                                customer_class_code
                            ,replace(hca.account_name,chr(10))                                                                      account_name
                            ,nvl(hca.account_established_date,hca.creation_Date)                                                    account_established_date
                            ,NULL/*hca.attribute_category*/                                                                         attribute_category
                            ,NULL/*hca.attribute1*/                                                                                 attribute1
                            ,NULL/*hca.attribute2*/                                                                                 attribute2
                            ,NULL/*hca.attribute3*/                                                                                 attribute3
                            ,NULL/*hca.attribute4*/                                                                                 attribute4
                            ,NULL/*hca.attribute5*/                                                                                 attribute5
                            ,NULL/*hca.attribute6*/                                                                                 attribute6
                            ,NULL/*hca.attribute7*/                                                                                 attribute7
                            ,NULL/*hca.attribute8*/                                                                                 attribute8
                            ,NULL/*hca.attribute9*/                                                                                 attribute9
                            ,NULL/*hca.attribute10*/                                                                                attribute10
                            ,NULL/*hca.attribute11*/                                                                                attribute11
                            ,NULL/*hca.attribute12*/                                                                                attribute12
                            ,NULL/*hca.attribute13*/                                                                                attribute13
                            ,NULL/*hca.attribute14*/                                                                                attribute14
                            ,NULL/*hca.attribute15*/                                                                                attribute15
                            ,NULL/*hca.attribute16*/                                                                                attribute16
                            ,NULL/*hca.attribute17*/                                                                                attribute17
                            ,NULL/*hca.attribute18*/                                                                                attribute18
                            ,NULL/*hca.attribute19*/                                                                                attribute19
                            ,hca.attribute20                                                                                        attribute20
                            ,NULL                                                                                                   attribute21
                            ,NULL                                                                                                   attribute22
                            ,NULL                                                                                                   attribute23
                            ,NULL                                                                                                   attribute24
                            ,NULL                                                                                                   attribute25
                            ,NULL                                                                                                   attribute26
                            ,NULL                                                                                                   attribute27
                            ,NULL                                                                                                   attribute28
                            ,NULL                                                                                                   attribute29
                            ,NULL                                                                                                   attribute30
                            ,hca.account_termination_date                                                                           account_termination_date
                            ,NULL                                                                                                   load_request_id
                            ,hca.status                                                                                             xxmx_status
                FROM    selection
                       ,apps.hz_cust_accounts@MXDM_NVIS_EXTRACT hca
                WHERE 1                   = 1
                AND   hca.cust_account_id = selection.cust_account_id;
                   --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
              TYPE hz_cust_accts_tt IS TABLE OF hz_cust_accts_cur%ROWTYPE INDEX BY BINARY_INTEGER;
               --
              --************************
              --** Constant Declarations
              --************************
              --
              cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_cust_accounts_stg';
              ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
              ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_cust_accounts_stg';
               --
             --************************
              --** Variable Declarations
              --************************
              --
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_cust_accts_tbl hz_cust_accts_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
           ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
         --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
           --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
           --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
              xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               OPEN hz_cust_accts_cur;
                   --
                   --
               LOOP
                        --
                    gvv_ProgressIndicator :='0070';
                        --
                    FETCH hz_cust_accts_cur
                    BULK COLLECT
                    INTO hz_cust_accts_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_cust_accts_tbl.COUNT=0;
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    FORALL i in 1..hz_cust_accts_tbl.COUNT
                        INSERT
                        INTO xxmx_hz_cust_accounts_stg
                                     (
                                      migration_set_id
                                     ,migration_set_name
                                     ,migration_status
                                     ,cust_orig_system
                                     ,cust_orig_system_reference
                                     ,party_orig_system
                                     ,party_orig_system_reference
                                     ,account_number
                                     ,insert_update_flag
                                     ,customer_type
                                     ,customer_class_code
                                     ,account_name
                                     ,account_established_date
                                     ,attribute_category
                                     ,attribute1
                                     ,attribute2
                                     ,attribute3
                                     ,attribute4
                                     ,attribute5
                                     ,attribute6
                                     ,attribute7
                                     ,attribute8
                                     ,attribute9
                                     ,attribute10
                                     ,attribute11
                                     ,attribute12
                                     ,attribute13
                                     ,attribute14
                                     ,attribute15
                                     ,attribute16
                                     ,attribute17
                                     ,attribute18
                                     ,attribute19
                                     ,attribute20
                                     ,attribute21
                                     ,attribute22
                                     ,attribute23
                                     ,attribute24
                                     ,attribute25
                                     ,attribute26
                                     ,attribute27
                                     ,attribute28
                                     ,attribute29
                                     ,attribute30
                                     ,account_termination_date
                                     ,load_request_id
                                     ,xxmx_status
                                     --,creation_date
                                     --,created_by
                                     --,last_update_date
                                     --,last_updated_by
                                     )
                             VALUES
                                     (
                                      pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                     ,gvt_MigrationSetName                               --migration_set_name
                                     ,'EXTRACTED'                                       --MIGRATION_STATUS
                                     ,hz_cust_accts_tbl(i).cust_orig_system
                                     ,hz_cust_accts_tbl(i).cust_orig_system_reference
                                     ,hz_cust_accts_tbl(i).party_orig_system
                                     ,hz_cust_accts_tbl(i).party_orig_system_reference
                                     ,hz_cust_accts_tbl(i).account_number
                                     ,hz_cust_accts_tbl(i).insert_update_flag
                                     ,hz_cust_accts_tbl(i).customer_type
                                     ,hz_cust_accts_tbl(i).customer_class_code
                                     ,hz_cust_accts_tbl(i).account_name
                                     ,hz_cust_accts_tbl(i).account_established_date
                                     ,hz_cust_accts_tbl(i).attribute_category
                                     ,hz_cust_accts_tbl(i).attribute1
                                     ,hz_cust_accts_tbl(i).attribute2
                                     ,hz_cust_accts_tbl(i).attribute3
                                     ,hz_cust_accts_tbl(i).attribute4
                                     ,hz_cust_accts_tbl(i).attribute5
                                     ,hz_cust_accts_tbl(i).attribute6
                                     ,hz_cust_accts_tbl(i).attribute7
                                     ,hz_cust_accts_tbl(i).attribute8
                                     ,hz_cust_accts_tbl(i).attribute9
                                     ,hz_cust_accts_tbl(i).attribute10
                                     ,hz_cust_accts_tbl(i).attribute11
                                     ,hz_cust_accts_tbl(i).attribute12
                                     ,hz_cust_accts_tbl(i).attribute13
                                     ,hz_cust_accts_tbl(i).attribute14
                                     ,hz_cust_accts_tbl(i).attribute15
                                     ,hz_cust_accts_tbl(i).attribute16
                                     ,hz_cust_accts_tbl(i).attribute17
                                     ,hz_cust_accts_tbl(i).attribute18
                                     ,hz_cust_accts_tbl(i).attribute19
                                     ,hz_cust_accts_tbl(i).attribute20
                                     ,hz_cust_accts_tbl(i).attribute21
                                     ,hz_cust_accts_tbl(i).attribute22
                                     ,hz_cust_accts_tbl(i).attribute23
                                     ,hz_cust_accts_tbl(i).attribute24
                                     ,hz_cust_accts_tbl(i).attribute25
                                     ,hz_cust_accts_tbl(i).attribute26
                                     ,hz_cust_accts_tbl(i).attribute27
                                     ,hz_cust_accts_tbl(i).attribute28
                                     ,hz_cust_accts_tbl(i).attribute29
                                     ,hz_cust_accts_tbl(i).attribute30
                                     ,hz_cust_accts_tbl(i).account_termination_date
                                     ,hz_cust_accts_tbl(i).load_request_id
                                     ,hz_cust_accts_tbl(i).xxmx_status
                                     --,hz_cust_accts_tbl(i).creation_date
                                     --,hz_cust_accts_tbl(i).created_by
                                     --,hz_cust_accts_tbl(i).last_update_date
                                     --,hz_cust_accts_tbl(i).last_updated_by
                                     );
                             --
                             --
                        --** END FORALL
                        --
                        --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
               CLOSE hz_cust_accts_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
                --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_cust_accts_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_accts_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END e_ModuleError Exception
               --
               --
               WHEN OTHERS
               THEN
                    --
                    --
                    IF hz_cust_accts_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_accts_cur;
                    END IF;
                    ROLLBACK;
                    --
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        END hz_cust_accounts_stg;
    --
    -- ----------------------------------------------------------------------------
    -- -------------------------------< hz_cust_acct_sites_stg >------------------
    -- ----------------------------------------------------------------------------
        PROCEDURE hz_cust_acct_sites_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_cust_acct_sites_stg
              --
          CURSOR hz_cust_acct_sites_cur
              IS
                WITH selection
                AS
                    (SELECT DISTINCT account_number, cust_acct_site_id, ACCOUNT_PARTY_ID party_id
                     FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
                SELECT
                             gct_OrigSystem                                                                       cust_orig_system
                            ,selection.account_number                                                             cust_orig_system_reference
                            ,gct_OrigSystem                                                                       cust_site_orig_system
                            ,hcasa.cust_account_id||'-'||hcasa.cust_acct_site_id                                  cust_site_orig_sys_ref
                            ,gct_OrigSystem                                                                       site_orig_system
--                            ,hcasa.party_site_id                                                                  site_orig_system_reference
                            ,hps.party_id||'-'||hps.party_site_number                                             site_orig_system_reference -- CPL
                            ,hcasa.LANGUAGE                                                                       acct_site_language
                            ,NULL                                                                                 insert_update_flag
                            ,hcasa.customer_category_code                                                         customer_category_code
                            ,hcasa.translated_customer_name                                                       translated_customer_name
                            ,NULL                                                                                 set_code
                            ,nvl(hps.start_date_active,hps.creation_date)                                         start_date
                            ,NULL                                                                                 end_date
                            ,hcasa.key_account_flag                                                               key_account_flag
                            ,NULL                                                                                 attribute_category
                            ,NULL                                                                                 attribute1
                            ,NULL                                                                                 attribute2
                            ,NULL                                                                                 attribute3
                            ,NULL                                                                                 attribute4
                            ,NULL                                                                                 attribute5
                            ,NULL                                                                                 attribute6
                            ,NULL                                                                                 attribute7
                            ,NULL                                                                                 attribute8
                            ,NULL                                                                                 attribute9
                            ,NULL                                                                                 attribute10
                            ,NULL                                                                                 attribute11
                            ,NULL                                                                                 attribute12
                            ,NULL                                                                                 attribute13
                            ,NULL                                                                                 attribute14
                            ,NULL                                                                                 attribute15
                            ,NULL                                                                                 attribute16
                            ,NULL                                                                                 attribute17
                            ,NULL                                                                                 attribute18
                            ,NULL                                                                                 attribute19
                            ,NULL                                                                                 attribute20
                            ,NULL                                                                                 attribute21
                            ,NULL                                                                                 attribute22
                            ,NULL                                                                                 attribute23
                            ,NULL                                                                                 attribute24
                            ,NULL                                                                                 attribute25
                            ,NULL                                                                                 attribute26
                            ,NULL                                                                                 attribute27
                            ,NULL                                                                                 attribute28
                            ,NULL                                                                                 attribute29
                            ,NULL                                                                                 attribute30
                            ,NULL                                                                                 account_number
                            ,NULL                                                                                 party_site_number
                            ,NULL                                                                                 load_request_id
                            ,org.name                                                                             ou_name
                            ,hcasa.status                                                                         xxmx_status
                            ,selection.party_id                                                                   party_orig_system_reference
            FROM   selection
                  ,apps.hz_cust_acct_sites_all@MXDM_NVIS_EXTRACT     hcasa
                  ,apps.hz_party_sites@MXDM_NVIS_EXTRACT             hps
                  ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT  org
            WHERE  hcasa.cust_acct_site_id = selection.cust_acct_site_id
            AND    hcasa.party_site_id     = hps.party_site_id
            AND    org.organization_id     = hcasa.org_id;
          --
          --** END CURSOR **
          --
          --********************
          --** Type Declarations
          --********************
          --
          TYPE hz_cust_acct_sites_tt IS TABLE OF hz_cust_acct_sites_cur%ROWTYPE INDEX BY BINARY_INTEGER;
          --
          --************************
          --** Constant Declarations
          --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_cust_acct_sites_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_cust_acct_sites_stg';
          --
          --************************
          --** Variable Declarations
          --************************
          --
          --
          --****************************
          --** Record Table Declarations
          --****************************
          --
          --
          --
          --****************************
          --** PL/SQL Table Declarations
          --****************************
          --

         hz_cust_acct_sites_tbl hz_cust_acct_sites_tt;
          --
          --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** DSF 28/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               OPEN hz_cust_acct_sites_cur;
               --
               LOOP
                    --
                   gvv_ProgressIndicator :='0070';
                    --
                    --
                    FETCH hz_cust_acct_sites_cur
                    BULK COLLECT
                    INTO hz_cust_acct_sites_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_cust_acct_sites_tbl.COUNT=0;
                    --
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    --
                    FORALL i in 1..hz_cust_acct_sites_tbl.COUNT
                    INSERT
                    INTO xxmx_hz_cust_acct_sites_stg
                                 (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,cust_orig_system
                                 ,cust_orig_system_reference
                                 ,cust_site_orig_system
                                 ,cust_site_orig_sys_ref
                                 ,site_orig_system
                                 ,site_orig_system_reference
                                 ,acct_site_language
                                 ,insert_update_flag
                                 ,customer_category_code
                                 ,translated_customer_name
                                 ,set_code
                                 ,start_date
                                 ,end_date
                                 ,key_account_flag
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,account_number
                                 ,party_site_number
                                 ,load_request_id
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                                 ,ou_name
                                 ,xxmx_status
                                 ,party_orig_system_reference
                                 )
                         VALUES
                                 (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_cust_acct_sites_tbl(i).cust_orig_system
                                 ,hz_cust_acct_sites_tbl(i).cust_orig_system_reference
                                 ,hz_cust_acct_sites_tbl(i).cust_site_orig_system
                                 ,hz_cust_acct_sites_tbl(i).cust_site_orig_sys_ref
                                 ,hz_cust_acct_sites_tbl(i).site_orig_system
                                 ,hz_cust_acct_sites_tbl(i).site_orig_system_reference
                                 ,hz_cust_acct_sites_tbl(i).acct_site_language
                                 ,hz_cust_acct_sites_tbl(i).insert_update_flag
                                 ,hz_cust_acct_sites_tbl(i).customer_category_code
                                 ,hz_cust_acct_sites_tbl(i).translated_customer_name
                                 ,hz_cust_acct_sites_tbl(i).set_code
                                 ,hz_cust_acct_sites_tbl(i).start_date
                                 ,hz_cust_acct_sites_tbl(i).end_date
                                 ,hz_cust_acct_sites_tbl(i).key_account_flag
                                 ,hz_cust_acct_sites_tbl(i).attribute_category
                                 ,hz_cust_acct_sites_tbl(i).attribute1
                                 ,hz_cust_acct_sites_tbl(i).attribute2
                                 ,hz_cust_acct_sites_tbl(i).attribute3
                                 ,hz_cust_acct_sites_tbl(i).attribute4
                                 ,hz_cust_acct_sites_tbl(i).attribute5
                                 ,hz_cust_acct_sites_tbl(i).attribute6
                                 ,hz_cust_acct_sites_tbl(i).attribute7
                                 ,hz_cust_acct_sites_tbl(i).attribute8
                                 ,hz_cust_acct_sites_tbl(i).attribute9
                                 ,hz_cust_acct_sites_tbl(i).attribute10
                                 ,hz_cust_acct_sites_tbl(i).attribute11
                                 ,hz_cust_acct_sites_tbl(i).attribute12
                                 ,hz_cust_acct_sites_tbl(i).attribute13
                                 ,hz_cust_acct_sites_tbl(i).attribute14
                                 ,hz_cust_acct_sites_tbl(i).attribute15
                                 ,hz_cust_acct_sites_tbl(i).attribute16
                                 ,hz_cust_acct_sites_tbl(i).attribute17
                                 ,hz_cust_acct_sites_tbl(i).attribute18
                                 ,hz_cust_acct_sites_tbl(i).attribute19
                                 ,hz_cust_acct_sites_tbl(i).attribute20
                                 ,hz_cust_acct_sites_tbl(i).attribute21
                                 ,hz_cust_acct_sites_tbl(i).attribute22
                                 ,hz_cust_acct_sites_tbl(i).attribute23
                                 ,hz_cust_acct_sites_tbl(i).attribute24
                                 ,hz_cust_acct_sites_tbl(i).attribute25
                                 ,hz_cust_acct_sites_tbl(i).attribute26
                                 ,hz_cust_acct_sites_tbl(i).attribute27
                                 ,hz_cust_acct_sites_tbl(i).attribute28
                                 ,hz_cust_acct_sites_tbl(i).attribute29
                                 ,hz_cust_acct_sites_tbl(i).attribute30
                                 ,hz_cust_acct_sites_tbl(i).account_number
                                 ,hz_cust_acct_sites_tbl(i).party_site_number
                                 ,hz_cust_acct_sites_tbl(i).load_request_id
                                 --,hz_cust_acct_sites_tbl(i).creation_date
                                 --,hz_cust_acct_sites_tbl(i).created_by
                                 --,hz_cust_acct_sites_tbl(i).last_update_date
                                 --,hz_cust_acct_sites_tbl(i).last_updated_by
                                 ,hz_cust_acct_sites_tbl(i).ou_name
                                 ,hz_cust_acct_sites_tbl(i).xxmx_status
                                 ,hz_cust_acct_sites_tbl(i).party_orig_system_reference
                        );
                          --
                    --** END FORALL
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
               CLOSE hz_cust_acct_sites_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
           ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
                --
          END IF;
           --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_cust_acct_sites_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_sites_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               --
               WHEN OTHERS
               THEN
                    --
                    IF hz_cust_acct_sites_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_sites_cur;
                    END IF;
                    ROLLBACK;
                    --
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                     --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
          --
        END hz_cust_acct_sites_stg;
    --
    -- ----------------------------------------------------------------------------
    -- -------------------------------< SRC_AR_ACCOUNT_SITE_USES >-----------------
    -- ----------------------------------------------------------------------------
        PROCEDURE hz_account_site_uses_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_account_site_uses_stg
              --
              -------------------------------------------------------------------------------------------------------------------
              -- NOTE THAT THIS CURSOR IS NO LONGER USED FOR THE EXTRACTION, BEIGNG REPLACED IN CODE BY 'INSERT INTO SELECT FROM'
              -- This was due to issues extracting Location causing the FORALL to fail with Numeric or Value Error
              -------------------------------------------------------------------------------------------------------------------
              CURSOR hz_cust_acct_site_uses_cur
              IS
                WITH selection
                AS
                    (SELECT DISTINCT cust_account_id, party_site_id, cust_acct_site_id,account_party_id party_id
                     FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
                SELECT  distinct
                             gct_OrigSystem                                                                                 cust_site_orig_system
                            ,selection.cust_account_id||'-'||selection.cust_acct_site_id                                    cust_site_orig_sys_ref
                            ,gct_OrigSystem                                                                                 cust_siteuse_orig_system
                            ,hcsua.site_use_id                                                                              cust_siteuse_orig_sys_ref
                            ,hcsua.site_use_code                                                                            site_use_code
                            ,hcsua.primary_flag                                                                             primary_flag
                            ,NULL                                                                                           insert_update_flag
                            ,hcsua.location                                                                                 location                                                                                       location
                            ,NULL                                                                                           set_code
                            ,nvl(hps.start_date_active,hps.creation_date)                                                   start_date
                            ,NULL                                                                                           end_date
                            ,NULL                                                                                           attribute_category
                            ,NULL                                                                                           attribute1
                            ,NULL                                                                                           attribute2
                            ,NULL                                                                                           attribute3
                            ,NULL                                                                                           attribute4
                            ,NULL                                                                                           attribute5
                            ,NULL                                                                                           attribute6
                            ,NULL                                                                                           attribute7
                            ,NULL                                                                                           attribute8
                            ,NULL                                                                                           attribute9
                            ,NULL                                                                                           attribute10
                            ,NULL                                                                                           attribute11
                            ,NULL                                                                                           attribute12
                            ,NULL                                                                                           attribute13
                            ,NULL                                                                                           attribute14
                            ,NULL                                                                                           attribute15
                            ,NULL                                                                                           attribute16
                            ,NULL                                                                                           attribute17
                            ,NULL                                                                                           attribute18
                            ,NULL                                                                                           attribute19
                            ,NULL                                                                                           attribute20
                            ,NULL                                                                                           attribute21
                            ,NULL                                                                                           attribute22
                            ,NULL                                                                                           attribute23
                            ,NULL                                                                                           attribute24
                            ,NULL                                                                                           attribute25
                            ,NULL                                                                                           attribute26
                            ,NULL                                                                                           attribute27
                            ,NULL                                                                                           attribute28
                            ,NULL                                                                                           attribute29
                            ,NULL                                                                                           attribute30
                            ,NULL                                                                                           account_number
                            ,NULL                                                                                           party_site_number
                            ,NULL                                                                                           load_request_id
                            ,org.name                                                                                       ou_name
                            ,selection.party_id                                                                             party_orig_system_reference
                FROM   selection
                      ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT      hcsua
                      ,apps.hz_cust_acct_sites_all@MXDM_NVIS_EXTRACT     hcasa
                      ,apps.hz_party_sites@MXDM_NVIS_EXTRACT             hps
                      ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT  org
                WHERE  hcsua.cust_acct_site_id      = selection.cust_acct_site_id
                AND    hcsua.status                 = 'A'
               --AND    hcsua.site_use_code     NOT IN ('BOL','ACK','INV','DRAWEE')  -- SMBC Spec
                AND    hcasa.cust_acct_site_id      = hcsua.cust_acct_site_id
                AND    hps.party_site_id            = hcasa.party_site_id
                AND    org.organization_id          = hcasa.org_id;
              --
              -- Local Type Variables
              --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
              TYPE hz_cust_acct_site_uses_tt IS TABLE OF hz_cust_acct_site_uses_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --************************
              --** Constant Declarations
              --************************
              --
              cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'xxmx_hz_cust_site_uses_stg';
              ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
              ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_cust_site_uses_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_cust_acct_site_uses_tbl     hz_cust_acct_site_uses_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
           IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
           gvv_ReturnStatus  := '';
           gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
           --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError       => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
              --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               OPEN hz_cust_acct_site_uses_cur;
               --
               --xxmx_utilities_pkg.out_message(' After OPEN hz_cust_acct_site_uses_cur');
               --
               gvv_ProgressIndicator :='0070';
               --
/**************************
----------------------------------------------------------------------------------------------------------------------
-- code commented out in favour of a 'INSERT INTO SELECT FROM' strategy, as at SMBC the FORALL was failing on Locaton
-- It was easiest to avoid the issue by changing the extraction mechaism
----------------------------------------------------------------------------------------------------------------------
LOOP
                    --
                    --
                    FETCH hz_cust_acct_site_uses_cur
                    BULK COLLECT
                    INTO hz_cust_acct_site_uses_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_cust_acct_site_uses_tbl.count=0;
                    --
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    --
                    FORALL i in 1..hz_cust_acct_site_uses_tbl.count
                    INSERT
                    INTO xxmx_hz_cust_site_uses_stg
                            (
                                 migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,cust_site_orig_system
                                 ,cust_site_orig_sys_ref
                                 ,cust_siteuse_orig_system
                                 ,cust_siteuse_orig_sys_ref
                                 ,site_use_code
                                 ,primary_flag
                                 ,insert_update_flag
                                 ,location
                                 ,set_code
                                 ,start_date
                                 ,end_date
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,account_number
                                 ,party_site_number
                                 ,load_request_id
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                                 ,ou_name
                        )
                        VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_cust_acct_site_uses_tbl(i).cust_site_orig_system
                                 ,hz_cust_acct_site_uses_tbl(i).cust_site_orig_sys_ref
                                 ,hz_cust_acct_site_uses_tbl(i).cust_siteuse_orig_system
                                 ,hz_cust_acct_site_uses_tbl(i).cust_siteuse_orig_sys_ref
                                 ,hz_cust_acct_site_uses_tbl(i).site_use_code
                                 ,hz_cust_acct_site_uses_tbl(i).primary_flag
                                 ,hz_cust_acct_site_uses_tbl(i).insert_update_flag
                                 ,NULL
                           --      ,hz_cust_acct_site_uses_tbl(i).location
                                 ,hz_cust_acct_site_uses_tbl(i).set_code
                                 ,hz_cust_acct_site_uses_tbl(i).start_date
                                 ,hz_cust_acct_site_uses_tbl(i).end_date
                                 ,hz_cust_acct_site_uses_tbl(i).attribute_category
                                 ,hz_cust_acct_site_uses_tbl(i).attribute1
                                 ,hz_cust_acct_site_uses_tbl(i).attribute2
                                 ,hz_cust_acct_site_uses_tbl(i).attribute3
                                 ,hz_cust_acct_site_uses_tbl(i).attribute4
                                 ,hz_cust_acct_site_uses_tbl(i).attribute5
                                 ,hz_cust_acct_site_uses_tbl(i).attribute6
                                 ,hz_cust_acct_site_uses_tbl(i).attribute7
                                 ,hz_cust_acct_site_uses_tbl(i).attribute8
                                 ,hz_cust_acct_site_uses_tbl(i).attribute9
                                 ,hz_cust_acct_site_uses_tbl(i).attribute10
                                 ,hz_cust_acct_site_uses_tbl(i).attribute11
                                 ,hz_cust_acct_site_uses_tbl(i).attribute12
                                 ,hz_cust_acct_site_uses_tbl(i).attribute13
                                 ,hz_cust_acct_site_uses_tbl(i).attribute14
                                 ,hz_cust_acct_site_uses_tbl(i).attribute15
                                 ,hz_cust_acct_site_uses_tbl(i).attribute16
                                 ,hz_cust_acct_site_uses_tbl(i).attribute17
                                 ,hz_cust_acct_site_uses_tbl(i).attribute18
                                 ,hz_cust_acct_site_uses_tbl(i).attribute19
                                 ,hz_cust_acct_site_uses_tbl(i).attribute20
                                 ,hz_cust_acct_site_uses_tbl(i).attribute21
                                 ,hz_cust_acct_site_uses_tbl(i).attribute22
                                 ,hz_cust_acct_site_uses_tbl(i).attribute23
                                 ,hz_cust_acct_site_uses_tbl(i).attribute24
                                 ,hz_cust_acct_site_uses_tbl(i).attribute25
                                 ,hz_cust_acct_site_uses_tbl(i).attribute26
                                 ,hz_cust_acct_site_uses_tbl(i).attribute27
                                 ,hz_cust_acct_site_uses_tbl(i).attribute28
                                 ,hz_cust_acct_site_uses_tbl(i).attribute29
                                 ,hz_cust_acct_site_uses_tbl(i).attribute30
                                 ,hz_cust_acct_site_uses_tbl(i).account_number
                                 ,hz_cust_acct_site_uses_tbl(i).party_site_number
                                 ,hz_cust_acct_site_uses_tbl(i).load_request_id
                                 -- ,hz_cust_acct_site_uses_tbl(i).creation_date
                                 -- ,hz_cust_acct_site_uses_tbl(i).created_by
                                 -- ,hz_cust_acct_site_uses_tbl(i).last_update_date
                                 -- ,hz_cust_acct_site_uses_tbl(i).last_updated_by
                                 ,hz_cust_acct_site_uses_tbl(i).ou_name
                            );
                    --
                    --** END FORALL
                    --
               END LOOP;
***********************************/
                    INSERT
                    INTO xxmx_hz_cust_site_uses_stg
                            (
                                 migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,cust_site_orig_system
                                 ,cust_site_orig_sys_ref
                                 ,cust_siteuse_orig_system
                                 ,cust_siteuse_orig_sys_ref
                                 ,site_use_code
                                 ,primary_flag
                                 ,insert_update_flag
                                 ,location
                                 ,set_code
                                 ,start_date
                                 ,end_date
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,account_number
                                 ,party_site_number
                                 ,load_request_id
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                                 ,ou_name
                                 ,party_orig_system_reference
                        )
                WITH selection
                AS
                    (SELECT DISTINCT cust_account_id, party_site_id, cust_acct_site_id ,account_party_id party_id
                     FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
                SELECT  distinct
                             pt_i_MigrationSetID                                                                            MIGRATION_SET_ID
                            ,gvt_MigrationSetName                                                                           migration_set_name
                            ,'EXTRACTED'                                                                                    MIGRATION_STATUS
                            ,gct_OrigSystem                                                                                 cust_site_orig_system
                            ,selection.cust_account_id||'-'||selection.cust_acct_site_id                                    cust_site_orig_sys_ref
                            ,gct_OrigSystem                                                                                 cust_siteuse_orig_system
                            ,hcsua.site_use_id                                                                              cust_siteuse_orig_sys_ref
                            ,hcsua.site_use_code                                                                            site_use_code
                            ,hcsua.primary_flag                                                                             primary_flag
                            ,NULL                                                                                       insert_update_flag
                            ,hcsua.location                                                                                 location
                            ,NULL                                                                                           set_code
                            ,nvl(hps.start_date_active,hps.creation_date)                                                   start_date
                            ,NULL                                                                                           end_date
                            ,NULL                                                                                           attribute_category
                            ,NULL                                                                                           attribute1
                            ,NULL                                                                                           attribute2
                            ,NULL                                                                                           attribute3
                            ,NULL                                                                                           attribute4
                            ,NULL                                                                                           attribute5
                            ,NULL                                                                                           attribute6
                            ,NULL                                                                                           attribute7
                            ,NULL                                                                                           attribute8
                            ,NULL                                                                                           attribute9
                            ,NULL                                                                                           attribute10
                            ,NULL                                                                                           attribute11
                            ,NULL                                                                                           attribute12
                            ,NULL                                                                                           attribute13
                            ,NULL                                                                                           attribute14
                            ,NULL                                                                                           attribute15
                            ,NULL                                                                                           attribute16
                            ,NULL                                                                                           attribute17
                            ,NULL                                                                                           attribute18
                            ,NULL                                                                                           attribute19
                            ,NULL                                                                                           attribute20
                            ,NULL                                                                                           attribute21
                            ,NULL                                                                                           attribute22
                            ,NULL                                                                                           attribute23
                            ,NULL                                                                                           attribute24
                            ,NULL                                                                                           attribute25
                            ,NULL                                                                                           attribute26
                            ,NULL                                                                                           attribute27
                            ,NULL                                                                                           attribute28
                            ,NULL                                                                                           attribute29
                            ,NULL                                                                                           attribute30
                            ,NULL                                                                                           account_number
                            ,NULL                                                                                           party_site_number
                            ,NULL                                                                                           load_request_id
                            ,org.name                                                                                       ou_name
                            ,selection.party_id                                                                             party_orig_system_reference
                FROM   selection
                      ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT      hcsua
                      ,apps.hz_cust_acct_sites_all@MXDM_NVIS_EXTRACT     hcasa
                      ,apps.hz_party_sites@MXDM_NVIS_EXTRACT             hps
                      ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT  org
                WHERE  hcsua.cust_acct_site_id      = selection.cust_acct_site_id
                AND    hcsua.status                 = 'A'
                --AND    hcsua.site_use_code     NOT IN ('BOL','ACK','INV','DRAWEE')  -- SMBC Spec
                AND    hcasa.cust_acct_site_id      = hcsua.cust_acct_site_id
                AND    hps.party_site_id            = hcasa.party_site_id
                AND    org.organization_id          = hcasa.org_id;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
                --
               gvv_ProgressIndicator :='0100';
               --
               CLOSE hz_cust_acct_site_uses_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
                --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError       => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_cust_acct_site_uses_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_site_uses_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    --
                    IF hz_cust_acct_site_uses_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_site_uses_cur;
                    END IF;
                    ROLLBACK;
                    --
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        END hz_account_site_uses_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_customer_profiles_stg >-------------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_customer_profiles_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_customer_profiles_stg
              --
        CURSOR hz_cust_profiles_cur
            IS
                SELECT
                         src.insert_update_flag                                                            AS insert_update_flag
                        ,gct_OrigSystem                                                                    AS cust_orig_system
                        ,src.cust_orig_system_reference                                                    AS cust_orig_system_reference
--                        ,src.cust_site_orig_system                                                         AS cust_site_orig_system
                        ,decode(src.cust_site_orig_sys_ref,null,null,gct_OrigSystem)                       AS cust_site_orig_system
                        ,src.cust_site_orig_sys_ref                                                        AS cust_site_orig_sys_ref
                        ,src.customer_profile_class_name                                                   AS customer_profile_class_name
                        ,src.collector_name                                                                AS collector_name
                        ,src.credit_balance_statements                                                     AS credit_balance_statements
                        ,src.credit_checking                                                               AS credit_checking
                        ,src.credit_hold                                                                   AS credit_hold
                        ,src.discount_terms                                                                AS discount_terms
                        ,src.dunning_letters                                                               AS dunning_letters
                        ,src.interest_charges                                                              AS interest_charges
                        ,src.statements                                                                    AS statements
                        ,src.tolerance                                                                     AS tolerance
                        ,src.tax_printing_option                                                           AS tax_printing_option
                        ,src.account_status                                                                AS account_status
                        ,src.autocash_hierarchy_name                                                       AS autocash_hierarchy_name
                        ,src.credit_rating                                                                 AS credit_rating
                        ,src.discount_grace_days                                                           AS discount_grace_days
                        ,src.interest_period_days                                                          AS interest_period_days
                        ,src.override_terms                                                                AS override_terms
                        ,src.payment_grace_days                                                            AS payment_grace_days
                        ,src.percent_collectable                                                           AS percent_collectable
                        ,src.risk_code                                                                     AS risk_code
                        ,xxmx_utilities_pkg.convert_string
                               (
                                pv_i_StringToConvert     => src.standard_term_name
                               ,pv_i_ConvertCommaToSpace => 'N'
                               ,pi_i_SubstrStartPos      => 1
                               ,pi_i_SubstrLength        => 0    /* 0 turns off the SUBSTR functionality */
                               ,pv_i_UseBinarySubstr     => 'N'
                               )                                                                          AS standard_term_name
                       ,xxmx_utilities_pkg.convert_string
                               (
                                pv_i_StringToConvert     => src.statement_cycle_name
                               ,pv_i_ConvertCommaToSpace => 'N'
                               ,pi_i_SubstrStartPos      => 1
                               ,pi_i_SubstrLength        => 0    /* 0 turns off the SUBSTR functionality */
                               ,pv_i_UseBinarySubstr     => 'N'
                               )                                                                          AS statement_cycle_name
                        ,src.charge_on_finance_charge_flag                                                 AS charge_on_finance_charge_flag
                        ,src.grouping_rule_name                                                            AS grouping_rule_name
                        ,src.currency_code                                                                 AS currency_code
                        ,src.auto_rec_min_receipt_amount                                                   AS auto_rec_min_receipt_amount
                        ,src.interest_rate                                                                 AS interest_rate
                        ,src.max_interest_charge                                                           AS max_interest_charge
                        ,src.min_dunning_amount                                                            AS min_dunning_amount
                        ,src.min_dunning_invoice_amount                                                    AS min_dunning_invoice_amount
                        ,src.min_fc_balance_amount                                                         AS min_fc_balance_amount
                        ,src.min_fc_invoice_amount                                                         AS min_fc_invoice_amount
                        ,src.min_statement_amount                                                          AS min_statement_amount
                        ,src.overall_credit_limit                                                          AS overall_credit_limit
                        ,src.trx_credit_limit                                                              AS trx_credit_limit
                        ,NULL/*src.attribute_category*/                                                    AS attribute_category
                        ,NULL/*src.attribute1*/                                                            AS attribute1
                        ,NULL/*src.attribute2*/                                                            AS attribute2
                        ,NULL/*src.attribute3*/                                                            AS attribute3
                        ,NULL/*src.attribute4*/                                                            AS attribute4
                        ,NULL/*src.attribute5*/                                                            AS attribute5
                        ,NULL/*src.attribute6*/                                                            AS attribute6
                        ,NULL/*src.attribute7*/                                                            AS attribute7
                        ,NULL/*src.attribute8*/                                                            AS attribute8
                        ,NULL/*src.attribute9*/                                                            AS attribute9
                        ,NULL/*src.attribute10*/                                                           AS attribute10
                        ,NULL/*src.attribute11*/                                                           AS attribute11
                        ,NULL/*src.attribute12*/                                                           AS attribute12
                        ,NULL/*src.attribute13*/                                                           AS attribute13
                        ,NULL/*src.attribute14*/                                                           AS attribute14
                        ,NULL/*src.attribute15*/                                                           AS attribute15
                        ,NULL/*src.amount_attribute_category*/                                             AS amount_attribute_category
                        ,NULL/*src.amount_attribute1*/                                                     AS amount_attribute1
                        ,NULL/*src.amount_attribute2*/                                                     AS amount_attribute2
                        ,NULL/*src.amount_attribute3*/                                                     AS amount_attribute3
                        ,NULL/*src.amount_attribute4*/                                                     AS amount_attribute4
                        ,NULL/*src.amount_attribute5*/                                                     AS amount_attribute5
                        ,NULL/*src.amount_attribute6*/                                                     AS amount_attribute6
                        ,NULL/*src.amount_attribute7*/                                                     AS amount_attribute7
                        ,NULL/*src.amount_attribute8*/                                                     AS amount_attribute8
                        ,NULL/*src.amount_attribute9*/                                                     AS amount_attribute9
                        ,NULL/*src.amount_attribute10*/                                                    AS amount_attribute10
                        ,NULL/*src.amount_attribute11*/                                                    AS amount_attribute11
                        ,NULL/*src.amount_attribute12*/                                                    AS amount_attribute12
                        ,NULL/*src.amount_attribute13*/                                                    AS amount_attribute13
                        ,NULL/*src.amount_attribute14*/                                                    AS amount_attribute14
                        ,NULL/*src.amount_attribute15*/                                                    AS amount_attribute15
                       --,src.party_orig_system                                                             AS party_orig_system
                        ,decode(src.party_orig_system_reference,null,null,gct_OrigSystem)                  AS party_orig_system
                        --,src.party_orig_system_reference                                                   AS party_orig_system_reference
                        ,src.auto_rec_incl_disputed_flag                                                   AS auto_rec_incl_disputed_flag
                        ,src.clearing_days                                                                 AS clearing_days
                        ,src.org_id                                                                        AS org_id
                        ,src.cons_inv_flag                                                                 AS cons_inv_flag
                        ,xxmx_utilities_pkg.convert_string
                               (
                                pv_i_StringToConvert     => src.cons_inv_type
                               ,pv_i_ConvertCommaToSpace => 'N'
                               ,pi_i_SubstrStartPos      => 1
                               ,pi_i_SubstrLength        => 0    /* 0 turns off the SUBSTR functionality */
                              ,pv_i_UseBinarySubstr     => 'N'
                               )                                                                          AS cons_inv_type
                        ,src.lockbox_matching_option                                                       AS lockbox_matching_option
                        ,src.autocash_hierarchy_name_adr                                                   AS autocash_hierarchy_name_adr
                        ,src.credit_classification                                                         AS credit_classification
                        ,src.cons_bill_level                                                               AS cons_bill_level
                        ,src.late_charge_calculation_trx                                                   AS late_charge_calculation_trx
                        ,src.credit_items_flag                                                             AS credit_items_flag
                        ,src.disputed_transactions_flag                                                    AS disputed_transactions_flag
                        ,src.late_charge_type                                                              AS late_charge_type
                        ,src.interest_calculation_period                                                   AS interest_calculation_period
                        ,src.hold_charged_invoices_flag                                                    AS hold_charged_invoices_flag
                        ,src.multiple_interest_rates_flag                                                  AS multiple_interest_rates_flag
                        ,src.charge_BEGIN_date                                                             AS charge_BEGIN_date
                        ,src.exchange_rate_type                                                            AS exchange_rate_type
                        ,src.min_fc_invoice_overdue_type                                                   AS min_fc_invoice_overdue_type
                        ,src.min_fc_invoice_percent                                                        AS min_fc_invoice_percent
                        ,src.min_fc_balance_overdue_type                                                   AS min_fc_balance_overdue_type
                        ,src.min_fc_balance_percent                                                        AS min_fc_balance_percent
                        ,src.interest_type                                                                 AS interest_type
                        ,src.interest_fixed_amount                                                         AS interest_fixed_amount
                        ,src.penalty_type                                                                  AS penalty_type
                        ,src.penalty_rate                                                                  AS penalty_rate
                        ,src.min_interest_charge                                                           AS min_interest_charge
                        ,src.penalty_fixed_amount                                                          AS penalty_fixed_amount
                        ,src.credit_analyst_name                                                           AS credit_analyst_name
                        ,src.credit_review_cycle                                                           AS credit_review_cycle
                        ,src.last_credit_review_date                                                       AS last_credit_review_date
                        ,src.next_credit_review_date                                                       AS next_credit_review_date
                        ,src.automatch_rule_name                                                           AS automatch_rule_name
                        ,src.match_by_autoupdate_flag                                                      AS match_by_autoupdate_flag
                        ,src.printing_option_code                                                          AS printing_option_code
                        ,src.txn_delivery_method                                                           AS txn_delivery_method
                        ,src.stmt_delivery_method                                                          AS stmt_delivery_method
                        ,src.xml_inv_flag                                                                  AS xml_inv_flag
                        ,src.xml_dm_flag                                                                   AS xml_dm_flag
                        ,src.xml_cb_flag                                                                   AS xml_cb_flag
                        ,src.xml_cm_flag                                                                   AS xml_cm_flag
                        ,src.cmk_config_flag                                                               AS cmk_config_flag
                        ,src.service_provider_name                                                         AS service_provider_name
                        ,src.partner_id                                                                    AS partner_id
                        ,src.partner_id_type_code                                                          AS partner_id_type_code
                        ,src.ar_outbound_transaction_flag                                                  AS ar_outbound_transaction_flag
                        ,src.ar_inbound_confirm_bod_flag                                                   AS ar_inbound_confirm_bod_flag
                        ,src.account_number                                                                AS account_number
                        ,src.party_number                                                                  AS party_number
                        ,src.pref_contact_method                                                           AS pref_contact_method
                        ,NULL                                                                              AS load_request_id
                        ,ou_name
						,src.party_orig_system_reference                                                   AS party_orig_system_reference
            FROM
                (
                ---------------------------------------------------
                -- Party Level (not attached to a customer account)
                ---------------------------------------------------
/****************************************************************************************************************************
The Party Site Level has been removed. It was excluded from the original set (using 1=2), and in dicsussion with
Jim Venn there appears no functional purpose to define at party level rather than account level
The code has been checked and does exttract rows
                SELECT  NULL                                                                             insert_update_flag
                       ,NULL                                                                             cust_orig_system    --'-1'
                       ,NULL                                                                             cust_orig_system_reference --'-1'
                       ,null                                                                             cust_site_orig_system
                       ,null                                                                             cust_site_orig_sys_ref
                       ,(SELECT  hcpc.name
                         FROM    apps.hz_cust_profile_classes@MXDM_NVIS_EXTRACT hcpc
                         WHERE   hcpc.profile_class_id  = hcp.profile_class_id)                          customer_profile_class_name
                       ,(SELECT  ac.name
                         FROM    apps.ar_collectors@MXDM_NVIS_EXTRACT ac
                         WHERE   ac.collector_id  = hcp.collector_id)                                    collector_name
                       ,hcp.credit_balance_statements                                                    credit_balance_statements
                       ,hcp.credit_checking                                                              credit_checking
                       ,hcp.credit_hold                                                                  credit_hold
                       ,hcp.discount_terms                                                               discount_terms
                       ,hcp.dunning_letters                                                              dunning_letters
                       ,hcp.interest_charges                                                             interest_charges
                       ,hcp.send_statements                                                              statements
                       ,hcp.tolerance                                                                    tolerance
                       ,hcp.tax_printing_option                                                          tax_printing_option
                       ,hcp.account_status                                                               account_status
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id)                 autocash_hierarchy_name
                       ,hcp.credit_rating                                                                credit_rating
                       ,hcp.discount_grace_days                                                          discount_grace_days
                       ,case when hcp.interest_charges  = 'N'
                        THEN null
                        else hcp.interest_period_days
                        end                                                                              interest_period_days
                       ,hcp.override_terms                                                               override_terms
                       ,hcp.payment_grace_days                                                           payment_grace_days
                       ,hcp.percent_collectable                                                          percent_collectable
                       ,hcp.risk_code                                                                    risk_code
                       ,(SELECT  rt.name
                         FROM    apps.ra_terms@MXDM_NVIS_EXTRACT rt
                         WHERE   rt.term_id  = hcp.standard_terms)                                       standard_term_name
                       ,(SELECT  ascs.name
                         FROM    apps.ar_statement_cycles@MXDM_NVIS_EXTRACT ascs
                         WHERE   ascs.statement_cycle_id  = hcp.statement_cycle_id)                      statement_cycle_name
                       ,hcp.charge_on_finance_charge_flag                                                charge_on_finance_charge_flag
                       ,(SELECT  rgr.name
                         FROM    apps.ra_grouping_rules@MXDM_NVIS_EXTRACT rgr
                         WHERE   rgr.grouping_rule_id  = hcp.grouping_rule_id)                           grouping_rule_name
                       ,hcpa.currency_code                                                               currency_code
                       ,hcpa.auto_rec_min_receipt_amount                                                 auto_rec_min_receipt_amount
                       ,hcpa.interest_rate                                                               interest_rate
                       ,hcpa.max_interest_charge                                                         max_interest_charge
                       ,hcpa.min_dunning_amount                                                          min_dunning_amount
                       ,hcpa.min_dunning_invoice_amount                                                  min_dunning_invoice_amount
                       ,hcpa.min_fc_balance_amount                                                       min_fc_balance_amount
                       ,hcpa.min_fc_invoice_amount                                                       min_fc_invoice_amount
                       ,hcpa.min_statement_amount                                                        min_statement_amount
                       ,hcpa.overall_credit_limit                                                        overall_credit_limit
                       ,hcpa.trx_credit_limit                                                            trx_credit_limit
                       ,hcp.attribute_category                                                           attribute_category
                       ,hcp.attribute1                                                                   attribute1
                       ,hcp.attribute2                                                                   attribute2
                       ,hcp.attribute3                                                                   attribute3
                       ,hcp.attribute4                                                                   attribute4
                       ,hcp.attribute5                                                                   attribute5
                       ,hcp.attribute6                                                                   attribute6
                       ,hcp.attribute7                                                                   attribute7
                       ,hcp.attribute8                                                                   attribute8
                       ,hcp.attribute9                                                                   attribute9
                       ,hcp.attribute10                                                                  attribute10
                       ,hcp.attribute11                                                                  attribute11
                       ,hcp.attribute12                                                                  attribute12
                       ,hcp.attribute13                                                                  attribute13
                       ,hcp.attribute14                                                                  attribute14
                       ,hcp.attribute15                                                                  attribute15
                       ,hcpa.attribute_category                                                          amount_attribute_category
                       ,hcpa.attribute1                                                                  amount_attribute1
                       ,hcpa.attribute2                                                                  amount_attribute2
                       ,hcpa.attribute3                                                                  amount_attribute3
                       ,hcpa.attribute4                                                                  amount_attribute4
                       ,hcpa.attribute5                                                                  amount_attribute5
                       ,hcpa.attribute6                                                                  amount_attribute6
                       ,hcpa.attribute7                                                                  amount_attribute7
                       ,hcpa.attribute8                                                                  amount_attribute8
                       ,hcpa.attribute9                                                                  amount_attribute9
                       ,hcpa.attribute10                                                                 amount_attribute10
                       ,hcpa.attribute11                                                                 amount_attribute11
                       ,hcpa.attribute12                                                                 amount_attribute12
                       ,hcpa.attribute13                                                                 amount_attribute13
                       ,hcpa.attribute14                                                                 amount_attribute14
                       ,hcpa.attribute15                                                                 amount_attribute15
                       ,NULL                                                                             party_orig_system
                       ,selection.party_id                                                               party_orig_system_reference
                       ,hcp.auto_rec_incl_disputed_flag                                                  auto_rec_incl_disputed_flag
                       ,hcp.clearing_days                                                                clearing_days
                       ,NULL                                                                             org_id
                       ,hcp.cons_inv_flag                                                                cons_inv_flag
                       ,hcp.cons_inv_type                                                                cons_inv_type
                       ,hcp.lockbox_matching_option                                                      lockbox_matching_option
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id_for_adr)         autocash_hierarchy_name_adr
                       ,hcp.credit_classification                                                        credit_classification
                       ,hcp.cons_bill_level                                                              cons_bill_level
                       ,hcp.late_charge_calculation_trx                                                  late_charge_calculation_trx
                       ,hcp.credit_items_flag                                                            credit_items_flag
                       ,hcp.disputed_transactions_flag                                                   disputed_transactions_flag
                       ,hcp.late_charge_type                                                             late_charge_type
                       ,hcp.interest_calculation_period                                                  interest_calculation_period
                       ,hcp.hold_charged_invoices_flag                                                   hold_charged_invoices_flag
                       ,hcp.multiple_interest_rates_flag                                                 multiple_interest_rates_flag
                       ,hcp.charge_begin_date                                                            charge_begin_date
                       ,hcpa.exchange_rate_type                                                          exchange_rate_type
                       ,hcpa.min_fc_invoice_overdue_type                                                 min_fc_invoice_overdue_type
                       ,hcpa.min_fc_invoice_percent                                                      min_fc_invoice_percent
                       ,hcpa.min_fc_balance_overdue_type                                                 min_fc_balance_overdue_type
                       ,hcpa.min_fc_balance_percent                                                      min_fc_balance_percent
                       ,hcpa.interest_type                                                               interest_type
                       ,hcpa.interest_fixed_amount                                                       interest_fixed_amount
                       ,hcpa.penalty_type                                                                penalty_type
                       ,hcpa.penalty_rate                                                                penalty_rate
                       ,hcpa.min_interest_charge                                                         min_interest_charge
                       ,hcpa.penalty_fixed_amount                                                        penalty_fixed_amount
                       ,(SELECT  hp.party_name
                         FROM    apps.hz_parties@MXDM_NVIS_EXTRACT hp
                         WHERE   hp.party_id  = hcp.credit_analyst_id)                                   credit_analyst_name
                       ,hcp.review_cycle                                                                 credit_review_cycle
                       ,hcp.last_credit_review_date                                                      last_credit_review_date
                       ,hcp.next_credit_review_date                                                      next_credit_review_date
                       ,null                                                                             automatch_rule_name
                       ,null                                                                             match_by_autoupdate_flag
                       ,null                                                                             printing_option_code
                       ,null                                                                             txn_delivery_method
                       ,null                                                                             stmt_delivery_method
                       ,null                                                                             xml_inv_flag
                       ,null                                                                             xml_dm_flag
                       ,null                                                                             xml_cb_flag
                       ,null                                                                             xml_cm_flag
                       ,null                                                                             cmk_config_flag
                       ,null                                                                             service_provider_name
                       ,null                                                                             partner_id
                       ,null                                                                             partner_id_type_code
                       ,null                                                                             ar_outbound_transaction_flag
                       ,null                                                                             ar_inbound_confirm_bod_flag
                       ,null                                                                             account_number
                       ,null                                                                             party_number
                       ,null                                                                             pref_contact_method
                       ,null                                                                             ou_name
                FROM    (SELECT DISTINCT account_party_id party_id
                         FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                       ,apps.hz_customer_profiles@MXDM_NVIS_EXTRACT        hcp
                       ,apps.hz_cust_profile_amts@MXDM_NVIS_EXTRACT        hcpa
                WHERE   hcp.party_id                 = selection.party_id
                AND     hcp.site_use_id             is null   -- ISV: Customer Level Profiles?
                AND     hcp.status                   = 'A'
                AND     nvl(hcp.cust_account_id, -1) = -1
                AND     hcp.cust_account_profile_id  = hcpa.cust_account_profile_id (+)
                UNION
***************************************************************************************************************/
                ---------------------------------------------------
                -- Account Level (not attached to a site use)
                ---------------------------------------------------
               SELECT   'I'                                                                                 insert_update_flag
                        ,NULL                                                                             cust_orig_system
                        ,selection.account_number                                                         cust_orig_system_reference
                       ,NULL                                                                              cust_site_orig_system
                       ,NULL                                                                              cust_site_orig_sys_ref
                       ,(SELECT  hcpc.name
                         FROM    apps.hz_cust_profile_classes@MXDM_NVIS_EXTRACT hcpc
                         WHERE   hcpc.profile_class_id  = hcp.profile_class_id)                           customer_profile_class_name
                       ,(SELECT  ac.name
                         FROM    apps.ar_collectors@MXDM_NVIS_EXTRACT ac
                         WHERE   ac.collector_id  = hcp.collector_id)                                     collector_name
                       ,hcp.credit_balance_statements                                                     credit_balance_statements
                       ,hcp.credit_checking                                                               credit_checking
                       ,hcp.credit_hold                                                                   credit_hold
                       ,hcp.discount_terms                                                                discount_terms
                       ,hcp.dunning_letters                                                               dunning_letters
                       ,hcp.interest_charges                                                              interest_charges
                       ,hcp.send_statements                                                               statements
                       ,hcp.tolerance                                                                     tolerance
                       ,hcp.tax_printing_option                                                           tax_printing_option
                       ,hcp.account_status                                                                account_status
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id)                  autocash_hierarchy_name
                       ,hcp.credit_rating                                                                 credit_rating
                       ,hcp.discount_grace_days                                                           discount_grace_days
                       ,case when hcp.interest_charges  = 'N'
                        THEN NULL
                        else hcp.interest_period_days
                        end                                                                               interest_period_days
                       ,hcp.override_terms                                                                override_terms
                       ,hcp.payment_grace_days                                                            payment_grace_days
                       ,hcp.percent_collectable                                                           percent_collectable
                       ,hcp.risk_code                                                                     risk_code
                       ,(SELECT  rt.name
                         FROM    apps.ra_terms@MXDM_NVIS_EXTRACT rt
                         WHERE   rt.term_id  = hcp.standard_terms)                                        standard_term_name
                       ,(SELECT  ascs.name
                         FROM    apps.ar_statement_cycles@MXDM_NVIS_EXTRACT ascs
                         WHERE   ascs.statement_cycle_id  = hcp.statement_cycle_id)                       statement_cycle_name
                       ,hcp.charge_on_finance_charge_flag                                                 charge_on_finance_charge_flag
                       ,(SELECT  rgr.name
                         FROM    apps.ra_grouping_rules@MXDM_NVIS_EXTRACT rgr
                         WHERE   rgr.grouping_rule_id  = hcp.grouping_rule_id)                            grouping_rule_name
                       ,hcpa.currency_code                                                                currency_code
                       ,hcpa.auto_rec_min_receipt_amount                                                  auto_rec_min_receipt_amount
                       ,hcpa.interest_rate                                                                interest_rate
                       ,hcpa.max_interest_charge                                                          max_interest_charge
                       ,hcpa.min_dunning_amount                                                           min_dunning_amount
                       ,hcpa.min_dunning_invoice_amount                                                   min_dunning_invoice_amount
                       ,hcpa.min_fc_balance_amount                                                        min_fc_balance_amount
                       ,hcpa.min_fc_invoice_amount                                                        min_fc_invoice_amount
                       ,hcpa.min_statement_amount                                                         min_statement_amount
                       ,hcpa.overall_credit_limit                                                         overall_credit_limit
                       ,hcpa.trx_credit_limit                                                             trx_credit_limit
                       ,hcp.attribute_category                                                            attribute_category
                       ,hcp.attribute1                                                                    attribute1
                       ,hcp.attribute2                                                                    attribute2
                       ,hcp.attribute3                                                                    attribute3
                       ,hcp.attribute4                                                                    attribute4
                       ,hcp.attribute5                                                                    attribute5
                       ,hcp.attribute6                                                                    attribute6
                       ,hcp.attribute7                                                                    attribute7
                       ,hcp.attribute8                                                                    attribute8
                       ,hcp.attribute9                                                                    attribute9
                       ,hcp.attribute10                                                                   attribute10
                       ,hcp.attribute11                                                                   attribute11
                       ,hcp.attribute12                                                                   attribute12
                       ,hcp.attribute13                                                                   attribute13
                       ,hcp.attribute14                                                                   attribute14
                       ,hcp.attribute15                                                                   attribute15
                       ,hcpa.attribute_category                                                           amount_attribute_category
                       ,hcpa.attribute1                                                                   amount_attribute1
                       ,hcpa.attribute2                                                                   amount_attribute2
                       ,hcpa.attribute3                                                                   amount_attribute3
                       ,hcpa.attribute4                                                                   amount_attribute4
                       ,hcpa.attribute5                                                                   amount_attribute5
                       ,hcpa.attribute6                                                                   amount_attribute6
                       ,hcpa.attribute7                                                                   amount_attribute7
                       ,hcpa.attribute8                                                                   amount_attribute8
                       ,hcpa.attribute9                                                                   amount_attribute9
                       ,hcpa.attribute10                                                                  amount_attribute10
                       ,hcpa.attribute11                                                                  amount_attribute11
                       ,hcpa.attribute12                                                                  amount_attribute12
                       ,hcpa.attribute13                                                                  amount_attribute13
                       ,hcpa.attribute14                                                                  amount_attribute14
                       ,hcpa.attribute15                                                                  amount_attribute15
                       ,NULL                                                                              party_orig_system
                      -- ,NULL                                                                              party_orig_system_reference
                       ,hcp.auto_rec_incl_disputed_flag                                                   auto_rec_incl_disputed_flag
                       ,hcp.clearing_days                                                                 clearing_days
                       ,NULL                                                                              org_id
                       ,hcp.cons_inv_flag                                                                 cons_inv_flag
                       ,hcp.cons_inv_type                                                                 cons_inv_type
                       ,hcp.lockbox_matching_option                                                       lockbox_matching_option
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id_for_adr)          autocash_hierarchy_name_adr
                       ,hcp.credit_classification                                                         credit_classification
                       ,hcp.cons_bill_level                                                               cons_bill_level
                       ,hcp.late_charge_calculation_trx                                                   late_charge_calculation_trx
                       ,hcp.credit_items_flag                                                             credit_items_flag
                       ,hcp.disputed_transactions_flag                                                    disputed_transactions_flag
                       ,hcp.late_charge_type                                                              late_charge_type
                       ,hcp.interest_calculation_period                                                   interest_calculation_period
                       ,hcp.hold_charged_invoices_flag                                                    hold_charged_invoices_flag
                       ,hcp.multiple_interest_rates_flag                                                  multiple_interest_rates_flag
                       ,hcp.charge_BEGIN_date                                                             charge_BEGIN_date
                       ,hcpa.exchange_rate_type                                                           exchange_rate_type
                       ,hcpa.min_fc_invoice_overdue_type                                                  min_fc_invoice_overdue_type
                       ,hcpa.min_fc_invoice_percent                                                       min_fc_invoice_percent
                       ,hcpa.min_fc_balance_overdue_type                                                  min_fc_balance_overdue_type
                       ,hcpa.min_fc_balance_percent                                                       min_fc_balance_percent
                       ,hcpa.interest_type                                                                interest_type
                       ,hcpa.interest_fixed_amount                                                        interest_fixed_amount
                       ,hcpa.penalty_type                                                                 penalty_type
                       ,hcpa.penalty_rate                                                                 penalty_rate
                       ,hcpa.min_interest_charge                                                          min_interest_charge
                       ,hcpa.penalty_fixed_amount                                                         penalty_fixed_amount
                       ,(SELECT  hp.party_name
                         FROM    apps.hz_parties@MXDM_NVIS_EXTRACT hp
                         WHERE   hp.party_id  = hcp.credit_analyst_id)                                    credit_analyst_name
                       ,hcp.review_cycle                                                                  credit_review_cycle
                       ,hcp.last_credit_review_date                                                       last_credit_review_date
                       ,hcp.next_credit_review_date                                                       next_credit_review_date
                       ,NULL                                                                              automatch_rule_name
                       ,NULL                                                                              match_by_autoupdate_flag
                       ,NULL                                                                              printing_option_code
                       ,NULL                                                                              txn_delivery_method
                       ,NULL                                                                              stmt_delivery_method
                       ,NULL                                                                              xml_inv_flag
                       ,NULL                                                                              xml_dm_flag
                       ,NULL                                                                              xml_cb_flag
                       ,NULL                                                                              xml_cm_flag
                       ,NULL                                                                              cmk_config_flag
                       ,NULL                                                                              service_provider_name
                       ,NULL                                                                              partner_id
                       ,NULL                                                                              partner_id_type_code
                       ,NULL                                                                              ar_outbound_transaction_flag
                       ,NULL                                                                              ar_inbound_confirm_bod_flag
                       ,NULL                                                                              account_number
                       ,NULL                                                                              party_number
                       ,NULL                                                                              pref_contact_method
                       ,'DEFAULT' ou_name
					   ,selection.account_number                                                          party_orig_system_reference
                FROM    (SELECT DISTINCT cust_account_id, account_number
                         FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)              selection
                       ,apps.hz_customer_profiles@MXDM_NVIS_EXTRACT        hcp
                       ,apps.hz_cust_profile_amts@MXDM_NVIS_EXTRACT        hcpa
                WHERE   hcp.cust_account_id              = selection.cust_account_id
                AND     hcp.status = 'A'
                AND     hcp.site_use_id                  IS NULL
                AND     hcpa.cust_account_profile_id (+) = hcp.cust_account_profile_id
                -----------------------------------------------------
                -- Site Use Level
                -----------------------------------------------------
                UNION
                SELECT  distinct 'I'                                                                      insert_update_flag
                       ,NULL                                                                              cust_orig_system
                       ,selection.account_number                                                          cust_orig_system_reference
                       ,NULL                                                                              cust_site_orig_system
                       ,selection.cust_account_id||'-'||selection.cust_acct_site_id                       cust_site_orig_sys_ref
                       ,(SELECT  hcpc.name
                         FROM    apps.hz_cust_profile_classes@MXDM_NVIS_EXTRACT hcpc
                         WHERE   hcpc.profile_class_id  = hcp.profile_class_id)                           customer_profile_class_name
                       ,(SELECT  ac.name
                         FROM    apps.ar_collectors@MXDM_NVIS_EXTRACT ac
                         WHERE   ac.collector_id  = hcp.collector_id)                                     collector_name
                       ,hcp.credit_balance_statements                                                     credit_balance_statements
                       ,hcp.credit_checking                                                               credit_checking
                       ,hcp.credit_hold                                                                   credit_hold
                       ,hcp.discount_terms                                                                discount_terms
                       ,hcp.dunning_letters                                                               dunning_letters
                       ,hcp.interest_charges                                                              interest_charges
                       ,hcp.send_statements                                                               statements
                       ,hcp.tolerance                                                                     tolerance
                       ,hcp.tax_printing_option                                                           tax_printing_option
                       ,hcp.account_status                                                                account_status
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id)                  autocash_hierarchy_name
                       ,hcp.credit_rating                                                                 credit_rating
                       ,hcp.discount_grace_days                                                           discount_grace_days
                       ,case when hcp.interest_charges  = 'N'
                        THEN NULL
                        else hcp.interest_period_days
                        end                                                                               interest_period_days
                       ,hcp.override_terms                                                                override_terms
                       ,hcp.payment_grace_days                                                            payment_grace_days
                       ,hcp.percent_collectable                                                           percent_collectable
                       ,hcp.risk_code                                                                     risk_code
                       ,(SELECT  rt.name
                         FROM    apps.ra_terms@MXDM_NVIS_EXTRACT rt
                         WHERE   rt.term_id  = hcp.standard_terms)                                        standard_term_name
                       ,(SELECT  ascs.name
                         FROM    apps.ar_statement_cycles@MXDM_NVIS_EXTRACT ascs
                         WHERE   ascs.statement_cycle_id  = hcp.statement_cycle_id)                       statement_cycle_name
                       ,hcp.charge_on_finance_charge_flag                                                 charge_on_finance_charge_flag
                       ,(SELECT  rgr.name
                         FROM    apps.ra_grouping_rules@MXDM_NVIS_EXTRACT rgr
                         WHERE   rgr.grouping_rule_id  = hcp.grouping_rule_id)                            grouping_rule_name
                       ,hcpa.currency_code                                                                currency_code
                       ,hcpa.auto_rec_min_receipt_amount                                                  auto_rec_min_receipt_amount
                       ,hcpa.interest_rate                                                                interest_rate
                       ,hcpa.max_interest_charge                                                          max_interest_charge
                       ,hcpa.min_dunning_amount                                                           min_dunning_amount
                       ,hcpa.min_dunning_invoice_amount                                                   min_dunning_invoice_amount
                       ,hcpa.min_fc_balance_amount                                                        min_fc_balance_amount
                       ,hcpa.min_fc_invoice_amount                                                        min_fc_invoice_amount
                       ,hcpa.min_statement_amount                                                         min_statement_amount
                       ,hcpa.overall_credit_limit                                                         overall_credit_limit
                       ,hcpa.trx_credit_limit                                                             trx_credit_limit
                       ,hcp.attribute_category                                                            attribute_category
                       ,hcp.attribute1                                                                    attribute1
                       ,hcp.attribute2                                                                    attribute2
                       ,hcp.attribute3                                                                    attribute3
                       ,hcp.attribute4                                                                    attribute4
                       ,hcp.attribute5                                                                    attribute5
                       ,hcp.attribute6                                                                    attribute6
                       ,hcp.attribute7                                                                    attribute7
                       ,hcp.attribute8                                                                    attribute8
                       ,hcp.attribute9                                                                    attribute9
                       ,hcp.attribute10                                                                   attribute10
                       ,hcp.attribute11                                                                   attribute11
                       ,hcp.attribute12                                                                   attribute12
                       ,hcp.attribute13                                                                   attribute13
                       ,hcp.attribute14                                                                   attribute14
                       ,hcp.attribute15                                                                   attribute15
                       ,hcpa.attribute_category                                                           amount_attribute_category
                       ,hcpa.attribute1                                                                   amount_attribute1
                       ,hcpa.attribute2                                                                   amount_attribute2
                       ,hcpa.attribute3                                                                   amount_attribute3
                       ,hcpa.attribute4                                                                   amount_attribute4
                       ,hcpa.attribute5                                                                   amount_attribute5
                       ,hcpa.attribute6                                                                   amount_attribute6
                       ,hcpa.attribute7                                                                   amount_attribute7
                       ,hcpa.attribute8                                                                   amount_attribute8
                       ,hcpa.attribute9                                                                   amount_attribute9
                       ,hcpa.attribute10                                                                  amount_attribute10
                       ,hcpa.attribute11                                                                  amount_attribute11
                       ,hcpa.attribute12                                                                  amount_attribute12
                       ,hcpa.attribute13                                                                  amount_attribute13
                       ,hcpa.attribute14                                                                  amount_attribute14
                       ,hcpa.attribute15                                                                  amount_attribute15
                       ,NULL                                                                              party_orig_system
                      -- ,NULL                                                                              party_orig_system_reference
                       ,hcp.auto_rec_incl_disputed_flag                                                   auto_rec_incl_disputed_flag
                       ,hcp.clearing_days                                                                 clearing_days
                       ,NULL                                                                              org_id
                       ,hcp.cons_inv_flag                                                                 cons_inv_flag
                       ,hcp.cons_inv_type                                                                 cons_inv_type
                       ,hcp.lockbox_matching_option                                                       lockbox_matching_option
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id_for_adr)          autocash_hierarchy_name_adr
                       ,hcp.credit_classification                                                         credit_classification
                       ,hcp.cons_bill_level                                                               cons_bill_level
                       ,hcp.late_charge_calculation_trx                                                   late_charge_calculation_trx
                       ,hcp.credit_items_flag                                                             credit_items_flag
                       ,hcp.disputed_transactions_flag                                                    disputed_transactions_flag
                       ,hcp.late_charge_type                                                              late_charge_type
                       ,hcp.interest_calculation_period                                                   interest_calculation_period
                       ,hcp.hold_charged_invoices_flag                                                    hold_charged_invoices_flag
                       ,hcp.multiple_interest_rates_flag                                                  multiple_interest_rates_flag
                       ,hcp.charge_BEGIN_date                                                             charge_BEGIN_date
                       ,hcpa.exchange_rate_type                                                           exchange_rate_type
                       ,hcpa.min_fc_invoice_overdue_type                                                  min_fc_invoice_overdue_type
                       ,hcpa.min_fc_invoice_percent                                                       min_fc_invoice_percent
                       ,hcpa.min_fc_balance_overdue_type                                                  min_fc_balance_overdue_type
                       ,hcpa.min_fc_balance_percent                                                       min_fc_balance_percent
                       ,hcpa.interest_type                                                                interest_type
                       ,hcpa.interest_fixed_amount                                                        interest_fixed_amount
                       ,hcpa.penalty_type                                                                 penalty_type
                       ,hcpa.penalty_rate                                                                 penalty_rate
                       ,hcpa.min_interest_charge                                                          min_interest_charge
                       ,hcpa.penalty_fixed_amount                                                         penalty_fixed_amount
                       ,(SELECT  hp.party_name
                         FROM    apps.hz_parties@MXDM_NVIS_EXTRACT hp
                         WHERE   hp.party_id  = hcp.credit_analyst_id)                                    credit_analyst_name
                       ,hcp.review_cycle                                                                  credit_review_cycle
                       ,hcp.last_credit_review_date                                                       last_credit_review_date
                       ,hcp.next_credit_review_date                                                       next_credit_review_date
                       ,NULL                                                                              automatch_rule_name
                       ,NULL                                                                              match_by_autoupdate_flag
                       ,NULL                                                                              printing_option_code
                       ,NULL                                                                              txn_delivery_method
                       ,NULL                                                                              stmt_delivery_method
                       ,NULL                                                                              xml_inv_flag
                       ,NULL                                                                              xml_dm_flag
                       ,NULL                                                                              xml_cb_flag
                       ,NULL                                                                              xml_cm_flag
                       ,NULL                                                                              cmk_config_flag
                       ,NULL                                                                              service_provider_name
                       ,NULL                                                                              partner_id
                       ,NULL                                                                              partner_id_type_code
                       ,NULL                                                                              ar_outbound_transaction_flag
                       ,NULL                                                                              ar_inbound_confirm_bod_flag
                       ,NULL                                                                              account_number
                       ,NULL                                                                              party_number
                       ,NULL                                                                              pref_contact_method
                       ,org.name                                                                          ou_name
					   ,selection.account_number                                                          party_orig_system_reference
                FROM   (SELECT DISTINCT cust_account_id, account_number, party_site_id, cust_acct_site_id
                         FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                       ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT       hcsua
                       ,apps.hz_customer_profiles@MXDM_NVIS_EXTRACT        hcp
                       ,apps.hz_cust_profile_amts@MXDM_NVIS_EXTRACT        hcpa
                       ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT   org
                WHERE   hcsua.cust_acct_site_id                        = selection.cust_acct_site_id
                AND     hcsua.status = 'A'
                AND     hcp.status = 'A'
--                AND     hcsua.primary_flag                             = 'Y' -- new 17/08/2021 due to multiple records per cust/site : DH removed this restriction due to SMBC/Chris L request
                AND     hcp.cust_account_id                            = selection.cust_account_id
                AND     hcp.site_use_id                                = hcsua.site_use_id
                AND     hcp.cust_account_profile_id                    = hcpa.cust_account_profile_id (+)
                AND     org.organization_id                            = hcsua.org_id
UNION
--
-- Added 11/10/2021 - select inactive site uses where an active one doesn't exist - as active site uses will be retrieved above
--                  - this is to fix multiple customer profiles getting extracted at site level
--
                SELECT  distinct 'I'                                                                               insert_update_flag
                       ,NULL                                                                              cust_orig_system
                       ,selection.account_number                                                          cust_orig_system_reference
                       ,NULL                                                                              cust_site_orig_system
                       ,selection.cust_account_id||'-'||selection.cust_acct_site_id                       cust_site_orig_sys_ref
                       ,(SELECT  hcpc.name
                         FROM    apps.hz_cust_profile_classes@MXDM_NVIS_EXTRACT hcpc
                         WHERE   hcpc.profile_class_id  = hcp.profile_class_id)                           customer_profile_class_name
                       ,(SELECT  ac.name
                         FROM    apps.ar_collectors@MXDM_NVIS_EXTRACT ac
                         WHERE   ac.collector_id  = hcp.collector_id)                                     collector_name
                       ,hcp.credit_balance_statements                                                     credit_balance_statements
                       ,hcp.credit_checking                                                               credit_checking
                       ,hcp.credit_hold                                                                   credit_hold
                       ,hcp.discount_terms                                                                discount_terms
                       ,hcp.dunning_letters                                                               dunning_letters
                       ,hcp.interest_charges                                                              interest_charges
                       ,hcp.send_statements                                                               statements
                       ,hcp.tolerance                                                                     tolerance
                       ,hcp.tax_printing_option                                                           tax_printing_option
                       ,hcp.account_status                                                                account_status
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id)                  autocash_hierarchy_name
                       ,hcp.credit_rating                                                                 credit_rating
                       ,hcp.discount_grace_days                                                           discount_grace_days
                       ,case when hcp.interest_charges  = 'N'
                        THEN NULL
                        else hcp.interest_period_days
                        end                                                                               interest_period_days
                       ,hcp.override_terms                                                                override_terms
                       ,hcp.payment_grace_days                                                            payment_grace_days
                       ,hcp.percent_collectable                                                           percent_collectable
                       ,hcp.risk_code                                                                     risk_code
                       ,(SELECT  rt.name
                         FROM    apps.ra_terms@MXDM_NVIS_EXTRACT rt
                         WHERE   rt.term_id  = hcp.standard_terms)                                        standard_term_name
                       ,(SELECT  ascs.name
                         FROM    apps.ar_statement_cycles@MXDM_NVIS_EXTRACT ascs
                         WHERE   ascs.statement_cycle_id  = hcp.statement_cycle_id)                       statement_cycle_name
                       ,hcp.charge_on_finance_charge_flag                                                 charge_on_finance_charge_flag
                       ,(SELECT  rgr.name
                         FROM    apps.ra_grouping_rules@MXDM_NVIS_EXTRACT rgr
                         WHERE   rgr.grouping_rule_id  = hcp.grouping_rule_id)                            grouping_rule_name
                       ,hcpa.currency_code                                                                currency_code
                       ,hcpa.auto_rec_min_receipt_amount                                                  auto_rec_min_receipt_amount
                       ,hcpa.interest_rate                                                                interest_rate
                       ,hcpa.max_interest_charge                                                          max_interest_charge
                       ,hcpa.min_dunning_amount                                                           min_dunning_amount
                       ,hcpa.min_dunning_invoice_amount                                                   min_dunning_invoice_amount
                       ,hcpa.min_fc_balance_amount                                                        min_fc_balance_amount
                       ,hcpa.min_fc_invoice_amount                                                        min_fc_invoice_amount
                       ,hcpa.min_statement_amount                                                         min_statement_amount
                       ,hcpa.overall_credit_limit                                                         overall_credit_limit
                       ,hcpa.trx_credit_limit                                                             trx_credit_limit
                       ,hcp.attribute_category                                                            attribute_category
                       ,hcp.attribute1                                                                    attribute1
                       ,hcp.attribute2                                                                    attribute2
                       ,hcp.attribute3                                                                    attribute3
                       ,hcp.attribute4                                                                    attribute4
                       ,hcp.attribute5                                                                    attribute5
                       ,hcp.attribute6                                                                    attribute6
                       ,hcp.attribute7                                                                    attribute7
                       ,hcp.attribute8                                                                    attribute8
                       ,hcp.attribute9                                                                    attribute9
                       ,hcp.attribute10                                                                   attribute10
                       ,hcp.attribute11                                                                   attribute11
                       ,hcp.attribute12                                                                   attribute12
                       ,hcp.attribute13                                                                   attribute13
                       ,hcp.attribute14                                                                   attribute14
                       ,hcp.attribute15                                                                   attribute15
                       ,hcpa.attribute_category                                                           amount_attribute_category
                       ,hcpa.attribute1                                                                   amount_attribute1
                       ,hcpa.attribute2                                                                   amount_attribute2
                       ,hcpa.attribute3                                                                   amount_attribute3
                       ,hcpa.attribute4                                                                   amount_attribute4
                       ,hcpa.attribute5                                                                   amount_attribute5
                       ,hcpa.attribute6                                                                   amount_attribute6
                       ,hcpa.attribute7                                                                   amount_attribute7
                       ,hcpa.attribute8                                                                   amount_attribute8
                       ,hcpa.attribute9                                                                   amount_attribute9
                       ,hcpa.attribute10                                                                  amount_attribute10
                       ,hcpa.attribute11                                                                  amount_attribute11
                       ,hcpa.attribute12                                                                  amount_attribute12
                       ,hcpa.attribute13                                                                  amount_attribute13
                       ,hcpa.attribute14                                                                  amount_attribute14
                       ,hcpa.attribute15                                                                  amount_attribute15
                       ,NULL                                                                              party_orig_system
                      -- ,NULL                                                                              party_orig_system_reference
                       ,hcp.auto_rec_incl_disputed_flag                                                   auto_rec_incl_disputed_flag
                       ,hcp.clearing_days                                                                 clearing_days
                       ,NULL                                                                              org_id
                       ,hcp.cons_inv_flag                                                                 cons_inv_flag
                       ,hcp.cons_inv_type                                                                 cons_inv_type
                       ,hcp.lockbox_matching_option                                                       lockbox_matching_option
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id_for_adr)          autocash_hierarchy_name_adr
                       ,hcp.credit_classification                                                         credit_classification
                       ,hcp.cons_bill_level                                                               cons_bill_level
                       ,hcp.late_charge_calculation_trx                                                   late_charge_calculation_trx
                       ,hcp.credit_items_flag                                                             credit_items_flag
                       ,hcp.disputed_transactions_flag                                                    disputed_transactions_flag
                       ,hcp.late_charge_type                                                              late_charge_type
                       ,hcp.interest_calculation_period                                                   interest_calculation_period
                       ,hcp.hold_charged_invoices_flag                                                    hold_charged_invoices_flag
                       ,hcp.multiple_interest_rates_flag                                                  multiple_interest_rates_flag
                       ,hcp.charge_BEGIN_date                                                             charge_BEGIN_date
                       ,hcpa.exchange_rate_type                                                           exchange_rate_type
                       ,hcpa.min_fc_invoice_overdue_type                                                  min_fc_invoice_overdue_type
                       ,hcpa.min_fc_invoice_percent                                                       min_fc_invoice_percent
                       ,hcpa.min_fc_balance_overdue_type                                                  min_fc_balance_overdue_type
                       ,hcpa.min_fc_balance_percent                                                       min_fc_balance_percent
                       ,hcpa.interest_type                                                                interest_type
                       ,hcpa.interest_fixed_amount                                                        interest_fixed_amount
                       ,hcpa.penalty_type                                                                 penalty_type
                       ,hcpa.penalty_rate                                                                 penalty_rate
                       ,hcpa.min_interest_charge                                                          min_interest_charge
                       ,hcpa.penalty_fixed_amount                                                         penalty_fixed_amount
                       ,(SELECT  hp.party_name
                         FROM    apps.hz_parties@MXDM_NVIS_EXTRACT hp
                         WHERE   hp.party_id  = hcp.credit_analyst_id)                                    credit_analyst_name
                       ,hcp.review_cycle                                                                  credit_review_cycle
                       ,hcp.last_credit_review_date                                                       last_credit_review_date
                       ,hcp.next_credit_review_date                                                       next_credit_review_date
                       ,NULL                                                                              automatch_rule_name
                       ,NULL                                                                              match_by_autoupdate_flag
                       ,NULL                                                                              printing_option_code
                       ,NULL                                                                              txn_delivery_method
                       ,NULL                                                                              stmt_delivery_method
                       ,NULL                                                                              xml_inv_flag
                       ,NULL                                                                              xml_dm_flag
                       ,NULL                                                                              xml_cb_flag
                       ,NULL                                                                              xml_cm_flag
                       ,NULL                                                                              cmk_config_flag
                       ,NULL                                                                              service_provider_name
                       ,NULL                                                                              partner_id
                       ,NULL                                                                              partner_id_type_code
                       ,NULL                                                                              ar_outbound_transaction_flag
                       ,NULL                                                                              ar_inbound_confirm_bod_flag
                       ,NULL                                                                              account_number
                       ,NULL                                                                              party_number
                       ,NULL                                                                              pref_contact_method
                       ,org.name                                                                          ou_name
					   ,selection.account_number                                                          party_orig_system_reference
                FROM   (SELECT DISTINCT cust_account_id, account_number, party_site_id, cust_acct_site_id
                         FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                       ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT       hcsua
                       ,apps.hz_customer_profiles@MXDM_NVIS_EXTRACT        hcp
                       ,apps.hz_cust_profile_amts@MXDM_NVIS_EXTRACT        hcpa
                       ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT   org
                WHERE   hcsua.cust_acct_site_id                        = selection.cust_acct_site_id
                AND     hcsua.status = 'I'
                and hcp.creation_date=(select max(hcp1.creation_date)
                                       from apps.hz_customer_profiles@MXDM_NVIS_EXTRACT  hcp1, apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT  hcsua1
                                       where hcp1.site_use_id=hcsua1.site_use_id  and    hcsua1.cust_acct_site_id = hcsua.cust_acct_site_id       and  hcp1.cust_account_id=hcp.cust_account_id)

                AND NOT EXISTS (select 1 from apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT       hcsua2
                                where hcsua2.cust_acct_site_id                        = selection.cust_acct_site_id
                                and hcsua2.status = 'A'
                               )				
                AND     hcp.status = 'A'
--                AND     hcsua.primary_flag                             = 'Y' -- new 17/08/2021 due to multiple records per cust/site : DH removed this restriction due to SMBC/Chris L request
                AND     hcp.cust_account_id                            = selection.cust_account_id
                AND     hcp.site_use_id                                = hcsua.site_use_id
                AND     hcp.cust_account_profile_id                    = hcpa.cust_account_profile_id (+)
                AND     org.organization_id                            = hcsua.org_id          
/*                
                SELECT  distinct 'I'                                                                               insert_update_flag
                       ,NULL                                                                              cust_orig_system
                       ,selection.account_number                                                          cust_orig_system_reference
                       ,NULL                                                                              cust_site_orig_system
                       ,selection.cust_account_id||'-'||selection.cust_acct_site_id                       cust_site_orig_sys_ref
                       ,(SELECT  hcpc.name
                         FROM    apps.hz_cust_profile_classes@MXDM_NVIS_EXTRACT hcpc
                         WHERE   hcpc.profile_class_id  = hcp.profile_class_id)                           customer_profile_class_name
                       ,(SELECT  ac.name
                         FROM    apps.ar_collectors@MXDM_NVIS_EXTRACT ac
                         WHERE   ac.collector_id  = hcp.collector_id)                                     collector_name
                       ,hcp.credit_balance_statements                                                     credit_balance_statements
                       ,hcp.credit_checking                                                               credit_checking
                       ,hcp.credit_hold                                                                   credit_hold
                       ,hcp.discount_terms                                                                discount_terms
                       ,hcp.dunning_letters                                                               dunning_letters
                       ,hcp.interest_charges                                                              interest_charges
                       ,hcp.send_statements                                                               statements
                       ,hcp.tolerance                                                                     tolerance
                       ,hcp.tax_printing_option                                                           tax_printing_option
                       ,hcp.account_status                                                                account_status
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id)                  autocash_hierarchy_name
                       ,hcp.credit_rating                                                                 credit_rating
                       ,hcp.discount_grace_days                                                           discount_grace_days
                       ,case when hcp.interest_charges  = 'N'
                        THEN NULL
                        else hcp.interest_period_days
                        end                                                                               interest_period_days
                       ,hcp.override_terms                                                                override_terms
                       ,hcp.payment_grace_days                                                            payment_grace_days
                       ,hcp.percent_collectable                                                           percent_collectable
                       ,hcp.risk_code                                                                     risk_code
                       ,(SELECT  rt.name
                         FROM    apps.ra_terms@MXDM_NVIS_EXTRACT rt
                         WHERE   rt.term_id  = hcp.standard_terms)                                        standard_term_name
                       ,(SELECT  ascs.name
                         FROM    apps.ar_statement_cycles@MXDM_NVIS_EXTRACT ascs
                         WHERE   ascs.statement_cycle_id  = hcp.statement_cycle_id)                       statement_cycle_name
                       ,hcp.charge_on_finance_charge_flag                                                 charge_on_finance_charge_flag
                       ,(SELECT  rgr.name
                         FROM    apps.ra_grouping_rules@MXDM_NVIS_EXTRACT rgr
                         WHERE   rgr.grouping_rule_id  = hcp.grouping_rule_id)                            grouping_rule_name
                       ,hcpa.currency_code                                                                currency_code
                       ,hcpa.auto_rec_min_receipt_amount                                                  auto_rec_min_receipt_amount
                       ,hcpa.interest_rate                                                                interest_rate
                       ,hcpa.max_interest_charge                                                          max_interest_charge
                       ,hcpa.min_dunning_amount                                                           min_dunning_amount
                       ,hcpa.min_dunning_invoice_amount                                                   min_dunning_invoice_amount
                       ,hcpa.min_fc_balance_amount                                                        min_fc_balance_amount
                       ,hcpa.min_fc_invoice_amount                                                        min_fc_invoice_amount
                       ,hcpa.min_statement_amount                                                         min_statement_amount
                       ,hcpa.overall_credit_limit                                                         overall_credit_limit
                       ,hcpa.trx_credit_limit                                                             trx_credit_limit
                       ,hcp.attribute_category                                                            attribute_category
                       ,hcp.attribute1                                                                    attribute1
                       ,hcp.attribute2                                                                    attribute2
                       ,hcp.attribute3                                                                    attribute3
                       ,hcp.attribute4                                                                    attribute4
                       ,hcp.attribute5                                                                    attribute5
                       ,hcp.attribute6                                                                    attribute6
                       ,hcp.attribute7                                                                    attribute7
                       ,hcp.attribute8                                                                    attribute8
                       ,hcp.attribute9                                                                    attribute9
                       ,hcp.attribute10                                                                   attribute10
                       ,hcp.attribute11                                                                   attribute11
                       ,hcp.attribute12                                                                   attribute12
                       ,hcp.attribute13                                                                   attribute13
                       ,hcp.attribute14                                                                   attribute14
                       ,hcp.attribute15                                                                   attribute15
                       ,hcpa.attribute_category                                                           amount_attribute_category
                       ,hcpa.attribute1                                                                   amount_attribute1
                       ,hcpa.attribute2                                                                   amount_attribute2
                       ,hcpa.attribute3                                                                   amount_attribute3
                       ,hcpa.attribute4                                                                   amount_attribute4
                       ,hcpa.attribute5                                                                   amount_attribute5
                       ,hcpa.attribute6                                                                   amount_attribute6
                       ,hcpa.attribute7                                                                   amount_attribute7
                       ,hcpa.attribute8                                                                   amount_attribute8
                       ,hcpa.attribute9                                                                   amount_attribute9
                       ,hcpa.attribute10                                                                  amount_attribute10
                       ,hcpa.attribute11                                                                  amount_attribute11
                       ,hcpa.attribute12                                                                  amount_attribute12
                       ,hcpa.attribute13                                                                  amount_attribute13
                       ,hcpa.attribute14                                                                  amount_attribute14
                       ,hcpa.attribute15                                                                  amount_attribute15
                       ,NULL                                                                              party_orig_system
                       ,NULL                                                                              party_orig_system_reference
                       ,hcp.auto_rec_incl_disputed_flag                                                   auto_rec_incl_disputed_flag
                       ,hcp.clearing_days                                                                 clearing_days
                       ,NULL                                                                              org_id
                       ,hcp.cons_inv_flag                                                                 cons_inv_flag
                       ,hcp.cons_inv_type                                                                 cons_inv_type
                       ,hcp.lockbox_matching_option                                                       lockbox_matching_option
                       ,(SELECT  aah.hierarchy_name
                         FROM    apps.ar_autocash_hierarchies@MXDM_NVIS_EXTRACT aah
                         WHERE   aah.autocash_hierarchy_id  = hcp.autocash_hierarchy_id_for_adr)          autocash_hierarchy_name_adr
                       ,hcp.credit_classification                                                         credit_classification
                       ,hcp.cons_bill_level                                                               cons_bill_level
                       ,hcp.late_charge_calculation_trx                                                   late_charge_calculation_trx
                       ,hcp.credit_items_flag                                                             credit_items_flag
                       ,hcp.disputed_transactions_flag                                                    disputed_transactions_flag
                       ,hcp.late_charge_type                                                              late_charge_type
                       ,hcp.interest_calculation_period                                                   interest_calculation_period
                       ,hcp.hold_charged_invoices_flag                                                    hold_charged_invoices_flag
                       ,hcp.multiple_interest_rates_flag                                                  multiple_interest_rates_flag
                       ,hcp.charge_BEGIN_date                                                             charge_BEGIN_date
                       ,hcpa.exchange_rate_type                                                           exchange_rate_type
                       ,hcpa.min_fc_invoice_overdue_type                                                  min_fc_invoice_overdue_type
                       ,hcpa.min_fc_invoice_percent                                                       min_fc_invoice_percent
                       ,hcpa.min_fc_balance_overdue_type                                                  min_fc_balance_overdue_type
                       ,hcpa.min_fc_balance_percent                                                       min_fc_balance_percent
                       ,hcpa.interest_type                                                                interest_type
                       ,hcpa.interest_fixed_amount                                                        interest_fixed_amount
                       ,hcpa.penalty_type                                                                 penalty_type
                       ,hcpa.penalty_rate                                                                 penalty_rate
                       ,hcpa.min_interest_charge                                                          min_interest_charge
                       ,hcpa.penalty_fixed_amount                                                         penalty_fixed_amount
                       ,(SELECT  hp.party_name
                         FROM    apps.hz_parties@MXDM_NVIS_EXTRACT hp
                         WHERE   hp.party_id  = hcp.credit_analyst_id)                                    credit_analyst_name
                       ,hcp.review_cycle                                                                  credit_review_cycle
                       ,hcp.last_credit_review_date                                                       last_credit_review_date
                       ,hcp.next_credit_review_date                                                       next_credit_review_date
                       ,NULL                                                                              automatch_rule_name
                       ,NULL                                                                              match_by_autoupdate_flag
                       ,NULL                                                                              printing_option_code
                       ,NULL                                                                              txn_delivery_method
                       ,NULL                                                                              stmt_delivery_method
                       ,NULL                                                                              xml_inv_flag
                       ,NULL                                                                              xml_dm_flag
                       ,NULL                                                                              xml_cb_flag
                       ,NULL                                                                              xml_cm_flag
                       ,NULL                                                                              cmk_config_flag
                       ,NULL                                                                              service_provider_name
                       ,NULL                                                                              partner_id
                       ,NULL                                                                              partner_id_type_code
                       ,NULL                                                                              ar_outbound_transaction_flag
                       ,NULL                                                                              ar_inbound_confirm_bod_flag
                       ,NULL                                                                              account_number
                       ,NULL                                                                              party_number
                       ,NULL                                                                              pref_contact_method
                       ,org.name                                                                          ou_name
                FROM   (SELECT DISTINCT cust_account_id, account_number, party_site_id, cust_acct_site_id
                         FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                       ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT       hcsua
                       ,apps.hz_customer_profiles@MXDM_NVIS_EXTRACT        hcp
                       ,apps.hz_cust_profile_amts@MXDM_NVIS_EXTRACT        hcpa
                       ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT   org
                WHERE   hcsua.cust_acct_site_id                        = selection.cust_acct_site_id
                AND     hcsua.status = 'A'
                AND     hcp.status = 'A' -- added 11/10/2021 - CLewis request
--                AND     hcsua.primary_flag                             = 'Y' -- new 17/08/2021 due to multiple records per cust/site : DH removed this restriction due to SMBC/Chris L request
                AND     hcp.cust_account_id                            = selection.cust_account_id
                AND     hcp.site_use_id                                = hcsua.site_use_id
                AND     hcp.cust_account_profile_id                    = hcpa.cust_account_profile_id (+)
                AND     org.organization_id                            = hcsua.org_id
*/                
/***************************************************************************************************
The original code had a fourth part to the UNION. This code did not make a great deal of sense and
did not fit with the 3-level definition for customer profiles, so the code has been removed
***************************************************************************************************/
            ) src;
           --
           -- Local Type Variables
           --
           TYPE hz_cust_profiles_tt IS TABLE OF hz_cust_profiles_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_customer_profiles_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_cust_profiles_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_cust_profiles_tbl hz_cust_profiles_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
           /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_cust_profiles_cur;
               --
               --
               --xxmx_utilities_pkg.out_message(' After OPEN hz_cust_profiles_cur');
               --
               gvv_ProgressIndicator :='0070';
                --
               LOOP
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    FETCH hz_cust_profiles_cur
                    BULK COLLECT
                    INTO hz_cust_profiles_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_cust_profiles_tbl.count=0;
                    --
                    gvv_ProgressIndicator := '0080';
                    --
                    FORALL i in 1..hz_cust_profiles_tbl.count
                    INSERT
                    INTO xxmx_hz_cust_profiles_stg
                        (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,insert_update_flag
                                 ,cust_orig_system
                                 ,cust_orig_system_reference
                                 ,cust_site_orig_system
                                 ,cust_site_orig_sys_ref
                                 ,customer_profile_class_name
                                 ,collector_name
                                 ,credit_balance_statements
                                 ,credit_checking
                                 ,credit_hold
                                 ,discount_terms
                                 ,dunning_letters
                                 ,interest_charges
                                 ,statements
                                 ,tolerance
                                 ,tax_printing_option
                                 ,account_status
                                 ,autocash_hierarchy_name
                                 ,credit_rating
                                 ,discount_grace_days
                                 ,interest_period_days
                                 ,override_terms
                                 ,payment_grace_days
                                 ,percent_collectable
                                 ,risk_code
                                 ,standard_term_name
                                 ,statement_cycle_name
                                 ,charge_on_finance_charge_flag
                                 ,grouping_rule_name
                                 ,currency_code
                                 ,auto_rec_min_receipt_amount
                                 ,interest_rate
                                 ,max_interest_charge
                                 ,min_dunning_amount
                                 ,min_dunning_invoice_amount
                                 ,min_fc_balance_amount
                                 ,min_fc_invoice_amount
                                 ,min_statement_amount
                                 ,overall_credit_limit
                                 ,trx_credit_limit
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,amount_attribute_category
                                 ,amount_attribute2
                                 ,amount_attribute3
                                 ,amount_attribute4
                                 ,amount_attribute5
                                 ,amount_attribute6
                                 ,amount_attribute7
                                 ,amount_attribute8
                                 ,amount_attribute9
                                 ,amount_attribute1
                                 ,amount_attribute10
                                 ,amount_attribute11
                                 ,amount_attribute12
                                 ,amount_attribute13
                                 ,amount_attribute14
                                 ,amount_attribute15
                                 ,party_orig_system
                                 ,party_orig_system_reference
                                 ,auto_rec_incl_disputed_flag
                                 ,clearing_days
                                 ,org_id
                                 ,cons_inv_flag
                                 ,cons_inv_type
                                 ,lockbox_matching_option
                                 ,autocash_hierarchy_name_adr
                                 ,credit_classification
                                 ,cons_bill_level
                                 ,late_charge_calculation_trx
                                 ,credit_items_flag
                                 ,disputed_transactions_flag
                                 ,late_charge_type
                                 ,interest_calculation_period
                                 ,hold_charged_invoices_flag
                                 ,multiple_interest_rates_flag
                                 ,charge_BEGIN_date
                                 ,exchange_rate_type
                                 ,min_fc_invoice_overdue_type
                                 ,min_fc_invoice_percent
                                 ,min_fc_balance_overdue_type
                                 ,min_fc_balance_percent
                                 ,interest_type
                                 ,interest_fixed_amount
                                 ,penalty_type
                                 ,penalty_rate
                                 ,min_interest_charge
                                 ,penalty_fixed_amount
                                 ,credit_analyst_name
                                 ,credit_review_cycle
                                 ,last_credit_review_date
                                 ,next_credit_review_date
                                 ,automatch_rule_name
                                 ,match_by_autoupdate_flag
                                 ,printing_option_code
                                 ,txn_delivery_method
                                 ,stmt_delivery_method
                                 ,xml_inv_flag
                                 ,xml_dm_flag
                                 ,xml_cb_flag
                                 ,xml_cm_flag
                                 ,cmk_config_flag
                                 ,service_provider_name
                                 ,partner_id
                                 ,partner_id_type_code
                                 ,ar_outbound_transaction_flag
                                 ,ar_inbound_confirm_bod_flag
                                 ,account_number
                                 ,party_number
                                 ,pref_contact_method
                                 ,load_request_id
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                                 ,ou_name
                        )
                        VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_cust_profiles_tbl(i).insert_update_flag
                                 ,hz_cust_profiles_tbl(i).cust_orig_system
                                 ,hz_cust_profiles_tbl(i).cust_orig_system_reference
                                 ,hz_cust_profiles_tbl(i).cust_site_orig_system
                                 ,hz_cust_profiles_tbl(i).cust_site_orig_sys_ref
                                 ,hz_cust_profiles_tbl(i).customer_profile_class_name
                                 ,hz_cust_profiles_tbl(i).collector_name
                                 ,hz_cust_profiles_tbl(i).credit_balance_statements
                                 ,hz_cust_profiles_tbl(i).credit_checking
                                 ,hz_cust_profiles_tbl(i).credit_hold
                                 ,hz_cust_profiles_tbl(i).discount_terms
                                 ,hz_cust_profiles_tbl(i).dunning_letters
                                 ,hz_cust_profiles_tbl(i).interest_charges
                                 ,hz_cust_profiles_tbl(i).statements
                                 ,hz_cust_profiles_tbl(i).tolerance
                                 ,hz_cust_profiles_tbl(i).tax_printing_option
                                 ,hz_cust_profiles_tbl(i).account_status
                                 ,hz_cust_profiles_tbl(i).autocash_hierarchy_name
                                 ,hz_cust_profiles_tbl(i).credit_rating
                                 ,hz_cust_profiles_tbl(i).discount_grace_days
                                 ,hz_cust_profiles_tbl(i).interest_period_days
                                 ,hz_cust_profiles_tbl(i).override_terms
                                 ,hz_cust_profiles_tbl(i).payment_grace_days
                                 ,hz_cust_profiles_tbl(i).percent_collectable
                                 ,hz_cust_profiles_tbl(i).risk_code
                                 ,hz_cust_profiles_tbl(i).standard_term_name
                                 ,hz_cust_profiles_tbl(i).statement_cycle_name
                                 ,hz_cust_profiles_tbl(i).charge_on_finance_charge_flag
                                 ,hz_cust_profiles_tbl(i).grouping_rule_name
                                 ,hz_cust_profiles_tbl(i).currency_code
                                 ,hz_cust_profiles_tbl(i).auto_rec_min_receipt_amount
                                 ,hz_cust_profiles_tbl(i).interest_rate
                                 ,hz_cust_profiles_tbl(i).max_interest_charge
                                 ,hz_cust_profiles_tbl(i).min_dunning_amount
                                 ,hz_cust_profiles_tbl(i).min_dunning_invoice_amount
                                 ,hz_cust_profiles_tbl(i).min_fc_balance_amount
                                 ,hz_cust_profiles_tbl(i).min_fc_invoice_amount
                                 ,hz_cust_profiles_tbl(i).min_statement_amount
                                 ,hz_cust_profiles_tbl(i).overall_credit_limit
                                 ,hz_cust_profiles_tbl(i).trx_credit_limit
                                 ,hz_cust_profiles_tbl(i).attribute_category
                                 ,hz_cust_profiles_tbl(i).attribute1
                                 ,hz_cust_profiles_tbl(i).attribute2
                                 ,hz_cust_profiles_tbl(i).attribute3
                                 ,hz_cust_profiles_tbl(i).attribute4
                                 ,hz_cust_profiles_tbl(i).attribute5
                                 ,hz_cust_profiles_tbl(i).attribute6
                                 ,hz_cust_profiles_tbl(i).attribute7
                                 ,hz_cust_profiles_tbl(i).attribute8
                                 ,hz_cust_profiles_tbl(i).attribute9
                                 ,hz_cust_profiles_tbl(i).attribute10
                                 ,hz_cust_profiles_tbl(i).attribute11
                                 ,hz_cust_profiles_tbl(i).attribute12
                                 ,hz_cust_profiles_tbl(i).attribute13
                                 ,hz_cust_profiles_tbl(i).attribute14
                                 ,hz_cust_profiles_tbl(i).attribute15
                                 ,hz_cust_profiles_tbl(i).amount_attribute_category
                                 ,hz_cust_profiles_tbl(i).amount_attribute1
                                 ,hz_cust_profiles_tbl(i).amount_attribute2
                                 ,hz_cust_profiles_tbl(i).amount_attribute3
                                 ,hz_cust_profiles_tbl(i).amount_attribute4
                                 ,hz_cust_profiles_tbl(i).amount_attribute5
                                 ,hz_cust_profiles_tbl(i).amount_attribute6
                                 ,hz_cust_profiles_tbl(i).amount_attribute7
                                 ,hz_cust_profiles_tbl(i).amount_attribute8
                                 ,hz_cust_profiles_tbl(i).amount_attribute9
                                 ,hz_cust_profiles_tbl(i).amount_attribute10
                                 ,hz_cust_profiles_tbl(i).amount_attribute11
                                 ,hz_cust_profiles_tbl(i).amount_attribute12
                                 ,hz_cust_profiles_tbl(i).amount_attribute13
                                 ,hz_cust_profiles_tbl(i).amount_attribute14
                                 ,hz_cust_profiles_tbl(i).amount_attribute15
                                 ,hz_cust_profiles_tbl(i).party_orig_system
                                 ,hz_cust_profiles_tbl(i).party_orig_system_reference
                                 ,hz_cust_profiles_tbl(i).auto_rec_incl_disputed_flag
                                 ,hz_cust_profiles_tbl(i).clearing_days
                                 ,hz_cust_profiles_tbl(i).org_id
                                 ,hz_cust_profiles_tbl(i).cons_inv_flag
                                 ,hz_cust_profiles_tbl(i).cons_inv_type
                                 ,hz_cust_profiles_tbl(i).lockbox_matching_option
                                 ,hz_cust_profiles_tbl(i).autocash_hierarchy_name_adr
                                 ,hz_cust_profiles_tbl(i).credit_classification
                                 ,hz_cust_profiles_tbl(i).cons_bill_level
                                 ,hz_cust_profiles_tbl(i).late_charge_calculation_trx
                                 ,hz_cust_profiles_tbl(i).credit_items_flag
                                 ,hz_cust_profiles_tbl(i).disputed_transactions_flag
                                 ,hz_cust_profiles_tbl(i).late_charge_type
                                 ,hz_cust_profiles_tbl(i).interest_calculation_period
                                 ,hz_cust_profiles_tbl(i).hold_charged_invoices_flag
                                 ,hz_cust_profiles_tbl(i).multiple_interest_rates_flag
                                 ,hz_cust_profiles_tbl(i).charge_BEGIN_date
                                 ,hz_cust_profiles_tbl(i).exchange_rate_type
                                 ,hz_cust_profiles_tbl(i).min_fc_invoice_overdue_type
                                 ,hz_cust_profiles_tbl(i).min_fc_invoice_percent
                                 ,hz_cust_profiles_tbl(i).min_fc_balance_overdue_type
                                 ,hz_cust_profiles_tbl(i).min_fc_balance_percent
                                 ,hz_cust_profiles_tbl(i).interest_type
                                 ,hz_cust_profiles_tbl(i).interest_fixed_amount
                                 ,hz_cust_profiles_tbl(i).penalty_type
                                 ,hz_cust_profiles_tbl(i).penalty_rate
                                 ,hz_cust_profiles_tbl(i).min_interest_charge
                                 ,hz_cust_profiles_tbl(i).penalty_fixed_amount
                                 ,hz_cust_profiles_tbl(i).credit_analyst_name
                                 ,hz_cust_profiles_tbl(i).credit_review_cycle
                                 ,hz_cust_profiles_tbl(i).last_credit_review_date
                                 ,hz_cust_profiles_tbl(i).next_credit_review_date
                                 ,hz_cust_profiles_tbl(i).automatch_rule_name
                                 ,hz_cust_profiles_tbl(i).match_by_autoupdate_flag
                                 ,hz_cust_profiles_tbl(i).printing_option_code
                                 ,hz_cust_profiles_tbl(i).txn_delivery_method
                                 ,hz_cust_profiles_tbl(i).stmt_delivery_method
                                 ,hz_cust_profiles_tbl(i).xml_inv_flag
                                 ,hz_cust_profiles_tbl(i).xml_dm_flag
                                 ,hz_cust_profiles_tbl(i).xml_cb_flag
                                 ,hz_cust_profiles_tbl(i).xml_cm_flag
                                 ,hz_cust_profiles_tbl(i).cmk_config_flag
                                 ,hz_cust_profiles_tbl(i).service_provider_name
                                 ,hz_cust_profiles_tbl(i).partner_id
                                 ,hz_cust_profiles_tbl(i).partner_id_type_code
                                 ,hz_cust_profiles_tbl(i).ar_outbound_transaction_flag
                                 ,hz_cust_profiles_tbl(i).ar_inbound_confirm_bod_flag
                                 ,hz_cust_profiles_tbl(i).account_number
                                 ,hz_cust_profiles_tbl(i).party_number
                                 ,hz_cust_profiles_tbl(i).pref_contact_method
                                 ,hz_cust_profiles_tbl(i).load_request_id
                                 -- ,hz_cust_profiles_tbl(i).creation_date
                                 -- ,hz_cust_profiles_tbl(i).created_by
                                 -- ,hz_cust_profiles_tbl(i).last_update_date
                                 -- ,hz_cust_profiles_tbl(i).last_updated_by
                                 ,hz_cust_profiles_tbl(i).ou_name
                        );
                    --
                    --** END FORALL
                    --
               END LOOP;
                    --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE hz_cust_profiles_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** DSF 28/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
			   --
			   --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID     => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError       => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_cust_profiles_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_profiles_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                     --
                    if hz_cust_profiles_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_profiles_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_customer_profiles_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_LOCATION >-------------------------
    -- ------------------------------------------------------------------------------
    --
    -- Update  : amended Location Orig System Reference to include party site id as 
	-- 16/09/21  fusion does not allow the same location to be assigned to different 
	--           sites. We need to create separate addresses.
    --
	-- ------------------------------------------------------------------------------	
        PROCEDURE hz_locations_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_locations_stg
              --
              cursor hz_locations_cur
              IS
                WITH selection
                AS
                    (SELECT DISTINCT party_site_id, location_id , account_party_id party_id
                     FROM   XXMX_CUSTOMER_SCOPE_TEMP_STG)
                SELECT  distinct
                                 gct_OrigSystem                                                                                              location_orig_system
--                                ,hl.location_id                                                                                              location_orig_system_reference
                                ,selection.party_site_id||'_'||hl.location_id                                                                location_orig_system_reference
                                ,NULL                                                                                                        insert_update_flag
                                ,hl.country                                                                                                  country
                                ,hl.address1                                                                                                 address1
                                ,hl.address2                                                                                                 address2
                                ,hl.address3                                                                                                 address3
                                ,hl.address4                                                                                                 address4
                                ,hl.city                                                                                                     city
                                ,hl.state                                                                                                    state
                                ,hl.province                                                                                                 province
                                ,hl.county                                                                                                   county
                                ,hl.postal_code                                                                                              postal_code
                                ,hl.postal_plus4_code                                                                                        postal_plus4_code
                                ,hl.language                                                                                                 location_language
                                ,hl.description                                                                                              description
                                ,hl.short_description                                                                                        short_description
                                ,hl.sales_tax_geocode                                                                                        sales_tax_geocode
                                ,hl.sales_tax_inside_city_limits                                                                             sales_tax_inside_city_limits
                                ,(SELECT standard_time_short_code
                                    from   apps.hz_timezones@MXDM_NVIS_EXTRACT
                                    WHERE  timezone_id = hl.timezone_id)                                                                     timezone_code
                                --,NULL                                                                                                        timezone_code   -- Ammended the Query
                                ,NULL                                                                                                        address1_std
                                ,hl.actual_content_source                                                                                    adapter_content_source
                                ,hl.validation_status_code                                                                                   addr_valid_status_code
                                ,hl.date_validated                                                                                           date_validated
                                ,hl.address_effective_date                                                                                   address_effective_date
                                ,hl.address_expiration_date                                                                                  address_expiration_date
                                ,hl.validated_flag                                                                                           validated_flag
                                ,hl.do_not_validate_flag                                                                                     do_not_validate_flag
                                ,NULL                                                                                                        interface_status
                                ,NULL                                                                                                        error_id
                                ,NULL/*hl.attribute_category*/                                                                               attribute_category
                                ,NULL/*hl.attribute1*/                                                                                       attribute1
                                ,NULL/*hl.attribute2*/                                                                                       attribute2
                                ,NULL/*hl.attribute3*/                                                                                       attribute3
                                ,NULL/*hl.attribute4*/                                                                                       attribute4
                                ,NULL/*hl.attribute5*/                                                                                       attribute5
                                ,NULL/*hl.attribute6*/                                                                                       attribute6
                                ,NULL/*hl.attribute7*/                                                                                       attribute7
                                ,NULL/*hl.attribute8*/                                                                                       attribute8
                                ,NULL/*hl.attribute9*/                                                                                       attribute9
                                ,NULL/*hl.attribute10*/                                                                                      attribute10
                                ,NULL/*hl.attribute11*/                                                                                      attribute11
                                ,NULL/*hl.attribute12*/                                                                                      attribute12
                                ,NULL/*hl.attribute13*/                                                                                      attribute13
                                ,NULL/*hl.attribute14*/                                                                                      attribute14
                                ,NULL/*hl.attribute15*/                                                                                      attribute15
                                ,NULL/*hl.attribute16*/                                                                                      attribute16
                                ,NULL/*hl.attribute17*/                                                                                      attribute17
                                ,NULL/*hl.attribute18*/                                                                                      attribute18
                                ,NULL/*hl.attribute19*/                                                                                      attribute19
                                ,NULL/*hl.attribute20*/                                                                                      attribute20
                                ,NULL                                                                                                        attribute21
                                ,NULL                                                                                                        attribute22
                                ,NULL                                                                                                        attribute23
                                ,NULL                                                                                                        attribute24
                                ,NULL                                                                                                        attribute25
                                ,NULL                                                                                                        attribute26
                                ,NULL                                                                                                        attribute27
                                ,NULL                                                                                                        attribute28
                                ,NULL                                                                                                        attribute29
                                ,NULL                                                                                                        attribute30
                                ,NULL                                                                                                        attribute_number1
                                ,NULL                                                                                                        attribute_number2
                                ,NULL                                                                                                        attribute_number3
                                ,NULL                                                                                                        attribute_number4
                                ,NULL                                                                                                        attribute_number5
                                ,NULL                                                                                                        attribute_number6
                                ,NULL                                                                                                        attribute_number7
                                ,NULL                                                                                                        attribute_number8
                                ,NULL                                                                                                        attribute_number9
                                ,NULL                                                                                                        attribute_number10
                                ,NULL                                                                                                        attribute_number11
                                ,NULL                                                                                                        attribute_number12
                                ,NULL                                                                                                        attribute_date1
                                ,NULL                                                                                                        attribute_date2
                                ,NULL                                                                                                        attribute_date3
                                ,NULL                                                                                                        attribute_date4
                                ,NULL                                                                                                        attribute_date5
                                ,NULL                                                                                                        attribute_date6
                                ,NULL                                                                                                        attribute_date7
                                ,NULL                                                                                                        attribute_date8
                                ,NULL                                                                                                        attribute_date9
                                ,NULL                                                                                                        attribute_date10
                                ,NULL                                                                                                        attribute_date11
                                ,NULL                                                                                                        attribute_date12
                                ,NULL                                                                                                        gnr_status
                                ,NULL                                                                                                         load_request_id
                                ,selection. party_id                                                                                          party_orig_system_reference
                FROM    selection
                       ,apps.hz_locations@MXDM_NVIS_EXTRACT                hl
                WHERE   hl.location_id = selection.location_id;
              --
              --** END CURSOR **
              --
              --
              --********************
              --** Type Declarations
              --********************
              --
              TYPE hz_locations_tt IS TABLE OF hz_locations_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
            cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_locations_stg';
            ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
            ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_locations_stg';
              --
              --************************
              --** Variable Declarations
              --************************
               --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_locations_tbl hz_locations_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
                --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
           --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 28/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the Locations and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_locations_cur;
               --
               LOOP
                    --
                   gvv_ProgressIndicator :='0070';
                    --
                    FETCH hz_locations_cur
                    BULK COLLECT
                    INTO hz_locations_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_locations_tbl.count=0;
                    --
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    --
                    FORALL i in 1..hz_locations_tbl.count
                    INSERT
                    INTO xxmx_hz_locations_stg
                        (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,location_orig_system
                                 ,location_orig_system_reference
                                 ,insert_update_flag
                                 ,country
                                 ,address1
                                 ,address2
                                 ,address3
                                 ,address4
                                 ,city
                                 ,state
                                 ,province
                                 ,county
                                 ,postal_code
                                 ,postal_plus4_code
                                 ,location_language
                                 ,description
                                 ,short_description
                                 ,sales_tax_geocode
                                 ,sales_tax_inside_city_limits
                                 ,timezone_code
                                 ,address1_std
                                 ,adapter_content_source
                                 ,addr_valid_status_code
                                 ,date_validated
                                 ,address_effective_date
                                 ,address_expiration_date
                                 ,validated_flag
                                 ,do_not_validate_flag
                                 ,interface_status
                                 ,error_id
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,attribute_number1
                                 ,attribute_number2
                                 ,attribute_number3
                                 ,attribute_number4
                                 ,attribute_number5
                                 ,attribute_number6
                                 ,attribute_number7
                                 ,attribute_number8
                                 ,attribute_number9
                                 ,attribute_number10
                                 ,attribute_number11
                                 ,attribute_number12
                                 ,attribute_date1
                                 ,attribute_date2
                                 ,attribute_date3
                                 ,attribute_date4
                                 ,attribute_date5
                                 ,attribute_date6
                                 ,attribute_date7
                                 ,attribute_date8
                                 ,attribute_date9
                                 ,attribute_date10
                                 ,attribute_date11
                                 ,attribute_date12
                                 ,gnr_status
                                 ,load_request_id
                                 ,party_orig_system_reference
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                    )
                    VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_locations_tbl(i).location_orig_system
                                 ,hz_locations_tbl(i).location_orig_system_reference
                                 ,hz_locations_tbl(i).insert_update_flag
                                 ,hz_locations_tbl(i).country
                                 ,hz_locations_tbl(i).address1
                                 ,hz_locations_tbl(i).address2
                                 ,hz_locations_tbl(i).address3
                                 ,hz_locations_tbl(i).address4
                                 ,hz_locations_tbl(i).city
                                 ,hz_locations_tbl(i).state
                                 ,hz_locations_tbl(i).province
                                 ,hz_locations_tbl(i).county
                                 ,hz_locations_tbl(i).postal_code
                                 ,hz_locations_tbl(i).postal_plus4_code
                                 ,hz_locations_tbl(i).location_language
                                 ,hz_locations_tbl(i).description
                                 ,hz_locations_tbl(i).short_description
                                 ,hz_locations_tbl(i).sales_tax_geocode
                                 ,hz_locations_tbl(i).sales_tax_inside_city_limits
                                 ,hz_locations_tbl(i).timezone_code
                                 ,hz_locations_tbl(i).address1_std
                                 ,hz_locations_tbl(i).adapter_content_source
                                 ,hz_locations_tbl(i).addr_valid_status_code
                                 ,hz_locations_tbl(i).date_validated
                                 ,hz_locations_tbl(i).address_effective_date
                                 ,hz_locations_tbl(i).address_expiration_date
                                 ,hz_locations_tbl(i).validated_flag
                                 ,hz_locations_tbl(i).do_not_validate_flag
                                 ,hz_locations_tbl(i).interface_status
                                 ,hz_locations_tbl(i).error_id
                                 ,hz_locations_tbl(i).attribute_category
                                 ,hz_locations_tbl(i).attribute1
                                 ,hz_locations_tbl(i).attribute2
                                 ,hz_locations_tbl(i).attribute3
                                 ,hz_locations_tbl(i).attribute4
                                 ,hz_locations_tbl(i).attribute5
                                 ,hz_locations_tbl(i).attribute6
                                 ,hz_locations_tbl(i).attribute7
                                 ,hz_locations_tbl(i).attribute8
                                 ,hz_locations_tbl(i).attribute9
                                 ,hz_locations_tbl(i).attribute10
                                 ,hz_locations_tbl(i).attribute11
                                 ,hz_locations_tbl(i).attribute12
                                 ,hz_locations_tbl(i).attribute13
                                 ,hz_locations_tbl(i).attribute14
                                 ,hz_locations_tbl(i).attribute15
                                 ,hz_locations_tbl(i).attribute16
                                 ,hz_locations_tbl(i).attribute17
                                 ,hz_locations_tbl(i).attribute18
                                 ,hz_locations_tbl(i).attribute19
                                 ,hz_locations_tbl(i).attribute20
                                 ,hz_locations_tbl(i).attribute21
                                 ,hz_locations_tbl(i).attribute22
                                 ,hz_locations_tbl(i).attribute23
                                 ,hz_locations_tbl(i).attribute24
                                 ,hz_locations_tbl(i).attribute25
                                 ,hz_locations_tbl(i).attribute26
                                 ,hz_locations_tbl(i).attribute27
                                 ,hz_locations_tbl(i).attribute28
                                 ,hz_locations_tbl(i).attribute29
                                 ,hz_locations_tbl(i).attribute30
                                 ,hz_locations_tbl(i).attribute_number1
                                 ,hz_locations_tbl(i).attribute_number2
                                 ,hz_locations_tbl(i).attribute_number3
                                 ,hz_locations_tbl(i).attribute_number4
                                 ,hz_locations_tbl(i).attribute_number5
                                 ,hz_locations_tbl(i).attribute_number6
                                 ,hz_locations_tbl(i).attribute_number7
                                 ,hz_locations_tbl(i).attribute_number8
                                 ,hz_locations_tbl(i).attribute_number9
                                 ,hz_locations_tbl(i).attribute_number10
                                 ,hz_locations_tbl(i).attribute_number11
                                 ,hz_locations_tbl(i).attribute_number12
                                 ,hz_locations_tbl(i).attribute_date1
                                 ,hz_locations_tbl(i).attribute_date2
                                 ,hz_locations_tbl(i).attribute_date3
                                 ,hz_locations_tbl(i).attribute_date4
                                 ,hz_locations_tbl(i).attribute_date5
                                 ,hz_locations_tbl(i).attribute_date6
                                 ,hz_locations_tbl(i).attribute_date7
                                 ,hz_locations_tbl(i).attribute_date8
                                 ,hz_locations_tbl(i).attribute_date9
                                 ,hz_locations_tbl(i).attribute_date10
                                 ,hz_locations_tbl(i).attribute_date11
                                 ,hz_locations_tbl(i).attribute_date12
                                 ,hz_locations_tbl(i).gnr_status
                                 ,hz_locations_tbl(i).load_request_id
                                 ,hz_locations_tbl(i).party_orig_system_reference
                                 --,hz_locations_tbl(i).migration_set_name
                                 --,hz_locations_tbl(i).creation_date
                                 --,hz_locations_tbl(i).created_by
                                 --,hz_locations_tbl(i).last_update_date
                                 --,hz_locations_tbl(i).last_updated_by
                    );
                    --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
               CLOSE hz_locations_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** DSF 28/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0100';
               --
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
                --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_locations_cur%ISOPEN
                    THEN
                        CLOSE hz_locations_cur;
                    END IF;
                    ROLLBACK;
                   --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                     --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    if hz_locations_cur%ISOPEN
                    THEN
                        CLOSE hz_locations_cur;
                    END IF;
                    ROLLBACK;
                     --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                     --
               --** END OTHERS Exception
               --
          --** END Exception Handler
           --
        END hz_locations_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_RELATIONSHIP >---------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_relationships_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
        IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_relationships_stg
              --------------------------------------------------------------------
              -- The WITH clause gets all the parties used by accounts
              -- limited to those with appropriate account roles
              -- This code needs to line up with the Party extraction earlier
              -- Not sure why we need to check on the account roles
              -- Both Forward and Back connections are extracted
              --------------------------------------------------------------------
            cursor hz_relationships_cur
            IS
                WITH selection AS (
                    select hr.object_id party_id,
                     xcsv.account_party_id
                    from   XXMX_CUSTOMER_SCOPE_TEMP_STG xcsv,
                           apps.hz_relationships@MXDM_NVIS_EXTRACT  hr
                    where  hr.object_id          = xcsv.account_party_id
                    and    hr.object_table_name  = 'HZ_PARTIES'
                    AND    hr.status             = 'A'
                    and    hr.subject_table_name = 'HZ_PARTIES'
                    and    directional_flag      = 'F'
                    and    (hr.end_date is null or hr.end_date >= trunc(sysdate))
                    union
                    select hr.subject_id party_id,
                     xcsv.account_party_id
                    from   XXMX_CUSTOMER_SCOPE_TEMP_STG xcsv,
                           apps.hz_relationships@MXDM_NVIS_EXTRACT  hr
                    where  hr.subject_id         = xcsv.account_party_id
                    and    hr.object_table_name  = 'HZ_PARTIES'
                    AND    hr.status             = 'A'
                    and    hr.subject_table_name = 'HZ_PARTIES'
                    and    directional_flag      = 'F'
                    and    (hr.end_date is null or hr.end_date >= trunc(sysdate))
                    )
                SELECT
                         gct_OrigSystem                                                                                      sub_orig_system
                        ,hr.subject_id                                                                                       sub_orig_system_reference
                        ,gct_OrigSystem                                                                                      obj_orig_system
                        ,hr.object_id                                                                                        obj_orig_system_reference
                        ,hr.relationship_type                                                                                relationship_type
                        ,hr.relationship_code                                                                                relationship_code
                        ,hr.start_date                                                                                       start_date
                        ,NULL                                                                                                insert_update_flag
                        ,hr.end_date                                                                                         end_date
                        ,NULL/*hr.attribute_category*/                                                                       attribute_category
                        ,NULL/*hr.attribute1*/                                                                               attribute1
                        ,NULL/*hr.attribute2*/                                                                               attribute2
                        ,NULL/*hr.attribute3*/                                                                               attribute3
                        ,NULL/*hr.attribute4*/                                                                               attribute4
                        ,NULL/*hr.attribute5*/                                                                               attribute5
                        ,NULL/*hr.attribute6*/                                                                               attribute6
                        ,NULL/*hr.attribute7*/                                                                               attribute7
                        ,NULL/*hr.attribute8*/                                                                               attribute8
                        ,NULL/*hr.attribute9*/                                                                               attribute9
                        ,NULL/*hr.attribute10*/                                                                              attribute10
                        ,NULL/*hr.attribute11*/                                                                              attribute11
                        ,NULL/*hr.attribute12*/                                                                              attribute12
                        ,NULL/*hr.attribute13*/                                                                              attribute13
                        ,NULL/*hr.attribute14*/                                                                              attribute14
                        ,NULL/*hr.attribute15*/                                                                              attribute15
                        ,NULL/*hr.attribute16*/                                                                              attribute16
                        ,NULL/*hr.attribute17*/                                                                              attribute17
                        ,NULL/*hr.attribute18*/                                                                              attribute18
                        ,NULL/*hr.attribute19*/                                                                              attribute19
                        ,NULL/*hr.attribute20*/                                                                              attribute20
                        ,NULL                                                                                                attribute21
                        ,NULL                                                                                                attribute22
                        ,NULL                                                                                                attribute23
                        ,NULL                                                                                                attribute24
                        ,NULL                                                                                                attribute25
                        ,NULL                                                                                                attribute26
                        ,NULL                                                                                                attribute27
                        ,NULL                                                                                                attribute28
                        ,NULL                                                                                                attribute29
                        ,NULL                                                                                                attribute30
                        ,NULL                                                                                                attribute_number1
                        ,NULL                                                                                                attribute_number2
                        ,NULL                                                                                                attribute_number3
                        ,NULL                                                                                                attribute_number4
                        ,NULL                                                                                                attribute_number5
                        ,NULL                                                                                                attribute_number6
                        ,NULL                                                                                                attribute_number7
                        ,NULL                                                                                                attribute_number8
                        ,NULL                                                                                                attribute_number9
                        ,NULL                                                                                                attribute_number10
                        ,NULL                                                                                                attribute_number11
                        ,NULL                                                                                                attribute_number12
                        ,NULL                                                                                                attribute_date1
                        ,NULL                                                                                                attribute_date2
                        ,NULL                                                                                                attribute_date3
                        ,NULL                                                                                                attribute_date4
                        ,NULL                                                                                                attribute_date5
                        ,NULL                                                                                                attribute_date6
                        ,NULL                                                                                                attribute_date7
                        ,NULL                                                                                                attribute_date8
                        ,NULL                                                                                                attribute_date9
                        ,NULL                                                                                                attribute_date10
                        ,NULL                                                                                                attribute_date11
                        ,NULL                                                                                                attribute_date12
                        ,hr.subject_type                                                                                     subject_type
                        ,hr.object_type                                                                                      object_type
--                        ,decode(selection.party_id,null,null,gct_OrigSystem)                                               rel_orig_system
--                        ,selection.party_id                                                                                rel_orig_system_reference
                        ,decode(selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id,null,null,gct_OrigSystem)         rel_orig_system
                        ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id                                          rel_orig_system_reference
                        ,NULL                                                                                                load_request_id
                        ,selection.account_party_id                                                                     party_orig_system_reference
                FROM   selection
                      ,apps.hz_relationships@MXDM_NVIS_EXTRACT      hr
                WHERE   (hr.subject_id = selection.party_id  or hr.object_id = selection.party_id)    -- DH changed hr.party_id = selection.party_id
                AND     hr.object_table_name  = 'HZ_PARTIES'
                AND     hr.subject_table_name  = 'HZ_PARTIES'
                AND     hr.status = 'A'
                AND     directional_flag      = 'F'                
                AND    (hr.end_date is null or hr.end_date >= trunc(sysdate));
              --
              --** END CURSOR **
              --
              --
              --********************
              --** Type Declarations
              --********************
              --
            TYPE hz_relationships_tt IS TABLE OF hz_relationships_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
            cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_relationships_stg';
            ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
            ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_relationships_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --
              hz_relationships_tbl hz_relationships_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
           --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
         --
          gvv_ProgressIndicator :='0030';
           --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_relationships_cur;
                   --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH hz_relationships_cur
                    BULK COLLECT
                    INTO hz_relationships_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_relationships_tbl.count=0;
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    FORALL i in 1..hz_relationships_tbl.count
                    INSERT
                    INTO xxmx_hz_relationships_stg
                            (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,sub_orig_system
                                 ,sub_orig_system_reference
                                 ,obj_orig_system
                                 ,obj_orig_system_reference
                                 ,relationship_type
                                 ,relationship_code
                                 ,start_date
                                 ,insert_update_flag
                                 ,end_date
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,attribute_number1
                                 ,attribute_number2
                                 ,attribute_number3
                                 ,attribute_number4
                                 ,attribute_number5
                                 ,attribute_number6
                                 ,attribute_number7
                                 ,attribute_number8
                                 ,attribute_number9
                                 ,attribute_number10
                                 ,attribute_number11
                                 ,attribute_number12
                                 ,attribute_date1
                                 ,attribute_date2
                                 ,attribute_date3
                                 ,attribute_date4
                                 ,attribute_date5
                                 ,attribute_date6
                                 ,attribute_date7
                                 ,attribute_date8
                                 ,attribute_date9
                                 ,attribute_date10
                                 ,attribute_date11
                                 ,attribute_date12
                                 ,subject_type
                                 ,object_type
                                 ,rel_orig_system
                                 ,rel_orig_system_reference
                                 ,load_request_id
                                 ,party_orig_system_reference
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                  ) VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_relationships_tbl(i).sub_orig_system
                                 ,hz_relationships_tbl(i).sub_orig_system_reference
                                 ,hz_relationships_tbl(i).obj_orig_system
                                 ,hz_relationships_tbl(i).obj_orig_system_reference
                                 ,hz_relationships_tbl(i).relationship_type
                                 ,hz_relationships_tbl(i).relationship_code
                                 ,hz_relationships_tbl(i).start_date
                                 ,hz_relationships_tbl(i).insert_update_flag
                                 ,hz_relationships_tbl(i).end_date
                                 ,hz_relationships_tbl(i).attribute_category
                                 ,hz_relationships_tbl(i).attribute1
                                 ,hz_relationships_tbl(i).attribute2
                                 ,hz_relationships_tbl(i).attribute3
                                 ,hz_relationships_tbl(i).attribute4
                                 ,hz_relationships_tbl(i).attribute5
                                 ,hz_relationships_tbl(i).attribute6
                                 ,hz_relationships_tbl(i).attribute7
                                 ,hz_relationships_tbl(i).attribute8
                                 ,hz_relationships_tbl(i).attribute9
                                 ,hz_relationships_tbl(i).attribute10
                                 ,hz_relationships_tbl(i).attribute11
                                 ,hz_relationships_tbl(i).attribute12
                                 ,hz_relationships_tbl(i).attribute13
                                 ,hz_relationships_tbl(i).attribute14
                                 ,hz_relationships_tbl(i).attribute15
                                 ,hz_relationships_tbl(i).attribute16
                                 ,hz_relationships_tbl(i).attribute17
                                 ,hz_relationships_tbl(i).attribute18
                                 ,hz_relationships_tbl(i).attribute19
                                 ,hz_relationships_tbl(i).attribute20
                                 ,hz_relationships_tbl(i).attribute21
                                 ,hz_relationships_tbl(i).attribute22
                                 ,hz_relationships_tbl(i).attribute23
                                 ,hz_relationships_tbl(i).attribute24
                                 ,hz_relationships_tbl(i).attribute25
                                 ,hz_relationships_tbl(i).attribute26
                                 ,hz_relationships_tbl(i).attribute27
                                 ,hz_relationships_tbl(i).attribute28
                                 ,hz_relationships_tbl(i).attribute29
                                 ,hz_relationships_tbl(i).attribute30
                                 ,hz_relationships_tbl(i).attribute_number1
                                 ,hz_relationships_tbl(i).attribute_number2
                                 ,hz_relationships_tbl(i).attribute_number3
                                 ,hz_relationships_tbl(i).attribute_number4
                                 ,hz_relationships_tbl(i).attribute_number5
                                 ,hz_relationships_tbl(i).attribute_number6
                                 ,hz_relationships_tbl(i).attribute_number7
                                 ,hz_relationships_tbl(i).attribute_number8
                                 ,hz_relationships_tbl(i).attribute_number9
                                 ,hz_relationships_tbl(i).attribute_number10
                                 ,hz_relationships_tbl(i).attribute_number11
                                 ,hz_relationships_tbl(i).attribute_number12
                                 ,hz_relationships_tbl(i).attribute_date1
                                 ,hz_relationships_tbl(i).attribute_date2
                                 ,hz_relationships_tbl(i).attribute_date3
                                 ,hz_relationships_tbl(i).attribute_date4
                                 ,hz_relationships_tbl(i).attribute_date5
                                 ,hz_relationships_tbl(i).attribute_date6
                                 ,hz_relationships_tbl(i).attribute_date7
                                 ,hz_relationships_tbl(i).attribute_date8
                                 ,hz_relationships_tbl(i).attribute_date9
                                 ,hz_relationships_tbl(i).attribute_date10
                                 ,hz_relationships_tbl(i).attribute_date11
                                 ,hz_relationships_tbl(i).attribute_date12
                                 ,hz_relationships_tbl(i).subject_type
                                 ,hz_relationships_tbl(i).object_type
                                 ,hz_relationships_tbl(i).rel_orig_system
                                 ,hz_relationships_tbl(i).rel_orig_system_reference
                                 ,hz_relationships_tbl(i).load_request_id
                                 ,hz_relationships_tbl(i).party_orig_system_reference
                                 --,hz_relationships_tbl(i).migration_set_name
                                 --,hz_relationships_tbl(i).creation_date
                                 --,hz_relationships_tbl(i).created_by
                                 --,hz_relationships_tbl(i).last_update_date
                                 --,hz_relationships_tbl(i).last_updated_by
                    );
                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
               CLOSE hz_relationships_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
              --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_relationships_cur%ISOPEN
                    THEN
                        CLOSE hz_relationships_cur;
                    END IF;
                    ROLLBACK;
                     --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                if hz_relationships_cur%ISOPEN
                THEN
                    CLOSE hz_relationships_cur;
                END IF;
                ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_relationships_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_CUST_ACCT_CONTACT >----------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_cust_acct_contact_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_cust_acct_contact_stg
              --
        cursor hz_cust_acct_contacts_cur
              IS
                   SELECT
                             gct_OrigSystem                                                 cust_orig_system
                            ,src.cust_orig_system_reference                                 cust_orig_system_reference
--                            ,src.cust_site_orig_system                                    cust_site_orig_system
                            ,decode(src.cust_site_orig_sys_ref,null,null,gct_OrigSystem)    cust_site_orig_system
                            ,src.cust_site_orig_sys_ref                                     cust_site_orig_sys_ref
--                            ,src.cust_contact_orig_system                                 cust_contact_orig_system
                            ,decode(src.cust_contact_orig_sys_ref,null,null,gct_OrigSystem) cust_contact_orig_system
                            ,src.cust_contact_orig_sys_ref                            cust_contact_orig_sys_ref
                            ,src.role_type                                            role_type
                            ,src.primary_flag                                         primary_flag
                            ,src.insert_update_flag                                   insert_update_flag
                            ,src.source_code                                          source_code
                            ,NULL/*src.attribute_category*/                           attribute_category
                            ,NULL/*src.attribute1*/                                   attribute1
                            ,NULL/*src.attribute2*/                                   attribute2
                            ,NULL/*src.attribute3*/                                   attribute3
                            ,NULL/*src.attribute4*/                                   attribute4
                            ,NULL/*src.attribute5*/                                   attribute5
                            ,NULL/*src.attribute6*/                                   attribute6
                            ,NULL/*src.attribute7*/                                   attribute7
                            ,NULL/*src.attribute8*/                                   attribute8
                            ,NULL/*src.attribute9*/                                   attribute9
                            ,NULL/*src.attribute10*/                                  attribute10
                            ,NULL/*src.attribute11*/                                  attribute11
                            ,NULL/*src.attribute12*/                                  attribute12
                            ,NULL/*src.attribute13*/                                  attribute13
                            ,NULL/*src.attribute14*/                                  attribute14
                            ,NULL/*src.attribute15*/                                  attribute15
                            ,NULL/*src.attribute16*/                                  attribute16
                            ,NULL/*src.attribute17*/                                  attribute17
                            ,NULL/*src.attribute18*/                                  attribute18
                            ,NULL/*src.attribute19*/                                  attribute19
                            ,NULL/*src.attribute20*/                                  attribute20
                            ,NULL/*src.attribute21*/                                  attribute21
                            ,NULL/*src.attribute22*/                                  attribute22
                            ,NULL/*src.attribute23*/                                  attribute23
                            ,NULL/*src.attribute24*/                                  attribute24
                            ,NULL/*src.attribute25*/                                  attribute25
                            ,NULL/*src.attribute26*/                                  attribute26
                            ,NULL/*src.attribute27*/                                  attribute27
                            ,NULL/*src.attribute28*/                                  attribute28
                            ,NULL/*src.attribute29*/                                  attribute29
                            ,NULL/*src.attribute30*/                                  attribute30
                            ,NULL/*src.attribute_number1*/                            attribute_number1
                            ,NULL/*src.attribute_number2*/                            attribute_number2
                            ,NULL/*src.attribute_number3*/                            attribute_number3
                            ,NULL/*src.attribute_number4*/                            attribute_number4
                            ,NULL/*src.attribute_number5*/                            attribute_number5
                            ,NULL/*src.attribute_number6*/                            attribute_number6
                            ,NULL/*src.attribute_number7*/                            attribute_number7
                            ,NULL/*src.attribute_number8*/                            attribute_number8
                            ,NULL/*src.attribute_number9*/                            attribute_number9
                            ,NULL/*src.attribute_number10*/                           attribute_number10
                            ,NULL/*src.attribute_number11*/                           attribute_number11
                            ,NULL/*src.attribute_number12*/                           attribute_number12
                            ,NULL/*src.attribute_date1*/                              attribute_date1
                            ,NULL/*src.attribute_date2*/                              attribute_date2
                            ,NULL/*src.attribute_date3*/                              attribute_date3
                            ,NULL/*src.attribute_date4*/                              attribute_date4
                            ,NULL/*src.attribute_date5*/                              attribute_date5
                            ,NULL/*src.attribute_date6*/                              attribute_date6
                            ,NULL/*src.attribute_date7*/                              attribute_date7
                            ,NULL/*src.attribute_date8*/                              attribute_date8
                            ,NULL/*src.attribute_date9*/                              attribute_date9
                            ,NULL/*src.attribute_date10*/                             attribute_date10
                            ,NULL/*src.attribute_date11*/                             attribute_date11
                            ,NULL/*src.attribute_date12*/                             attribute_date12
--                            ,src.rel_orig_system                                      rel_orig_system
                            ,decode(src.rel_orig_system_reference,null,null,gct_OrigSystem) rel_orig_system
                            ,src.rel_orig_system_reference                                  rel_orig_system_reference
                            ,NULL                                                           load_request_id
                            ,src.party_orig_system_reference                             party_orig_system_reference
            FROM (
                    SELECT  NULL                                                                                                        cust_orig_system
                           ,selection.account_number                                                                                   cust_orig_system_reference
                           ,NULL                                                                                                        cust_site_orig_system
                           ,NULL                                                                                                        cust_site_orig_sys_ref
                           ,NULL                                                                                                        cust_contact_orig_system
                           ,hoc.org_contact_id                                                                                          cust_contact_orig_sys_ref
                           ,hcar.role_type                                                                                              role_type
                           ,hcar.primary_flag                                                                                           primary_flag
                           ,NULL                                                                                                        insert_update_flag
                           ,hcar.source_code                                                                                            source_code
                           ,hoc.attribute_category                                                                                      attribute_category
                           ,hoc.attribute1                                                                                              attribute1
                           ,hoc.attribute2                                                                                              attribute2
                           ,hoc.attribute3                                                                                              attribute3
                           ,hoc.attribute4                                                                                              attribute4
                           ,hoc.attribute5                                                                                              attribute5
                           ,hoc.attribute6                                                                                              attribute6
                           ,hoc.attribute7                                                                                              attribute7
                           ,hoc.attribute8                                                                                              attribute8
                           ,hoc.attribute9                                                                                              attribute9
                           ,hoc.attribute10                                                                                             attribute10
                           ,hoc.attribute11                                                                                             attribute11
                           ,hoc.attribute12                                                                                             attribute12
                           ,hoc.attribute13                                                                                             attribute13
                           ,hoc.attribute14                                                                                             attribute14
                           ,hoc.attribute15                                                                                             attribute15
                           ,hoc.attribute16                                                                                             attribute16
                           ,hoc.attribute17                                                                                             attribute17
                           ,hoc.attribute18                                                                                             attribute18
                           ,hoc.attribute19                                                                                             attribute19
                           ,hoc.attribute20                                                                                             attribute20
                           ,NULL                                                                                                        attribute21
                           ,NULL                                                                                                        attribute22
                           ,NULL                                                                                                        attribute23
                           ,NULL                                                                                                        attribute24
                           ,NULL                                                                                                        attribute25
                           ,NULL                                                                                                        attribute26
                           ,NULL                                                                                                        attribute27
                           ,NULL                                                                                                        attribute28
                           ,NULL                                                                                                        attribute29
                           ,NULL                                                                                                        attribute30
                           ,NULL                                                                                                        attribute_number1
                           ,NULL                                                                                                        attribute_number2
                           ,NULL                                                                                                        attribute_number3
                           ,NULL                                                                                                        attribute_number4
                           ,NULL                                                                                                        attribute_number5
                           ,NULL                                                                                                        attribute_number6
                           ,NULL                                                                                                        attribute_number7
                           ,NULL                                                                                                        attribute_number8
                           ,NULL                                                                                                        attribute_number9
                           ,NULL                                                                                                        attribute_number10
                           ,NULL                                                                                                        attribute_number11
                           ,NULL                                                                                                        attribute_number12
                           ,NULL                                                                                                        attribute_date1
                           ,NULL                                                                                                        attribute_date2
                           ,NULL                                                                                                        attribute_date3
                           ,NULL                                                                                                        attribute_date4
                           ,NULL                                                                                                        attribute_date5
                           ,NULL                                                                                                        attribute_date6
                           ,NULL                                                                                                        attribute_date7
                           ,NULL                                                                                                        attribute_date8
                           ,NULL                                                                                                        attribute_date9
                           ,NULL                                                                                                        attribute_date10
                           ,NULL                                                                                                        attribute_date11
                           ,NULL                                                                                                        attribute_date12
                           ,NULL                                                                                                        rel_orig_system
                           ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id                                                  rel_orig_system_reference
                           ,selection.party_id                                                                   party_orig_system_reference
                    FROM    (select distinct account_number, account_party_id party_id
                             from XXMX_CUSTOMER_SCOPE_TEMP_STG)                    selection
                           ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT          hoc
                           ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT    hcar
                           ,apps.hz_parties@MXDM_NVIS_EXTRACT               hp1
                           ,apps.hz_relationships@MXDM_NVIS_EXTRACT         hr
                    WHERE  1                           =  1
                    AND    hr.subject_id               =  hp1.party_id
                    AND    hr.object_id                =  selection.party_id
                    AND    hcar.party_id               =  selection.party_id
                    AND    hoc.party_relationship_id   =  hr.relationship_id
                    AND    hcar.cust_acct_site_id      is  NULL
                    AND hp1.status                     = 'A'
                    AND hoc.status                     = 'A'
--                    and exists (select 1 from apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr where hcar.cust_account_role_id  = hrr.cust_account_role_id and  hrr.responsibility_type not in ('BOOKER','LEARNER'))
                    UNION
                    SELECT  DISTINCT
                            NULL                                                                                                        cust_orig_system
                           ,selection.account_number                                                                                    cust_orig_system_reference
                           ,NULL                                                                                                        cust_site_orig_system
                           ,selection.cust_account_id||'-'||selection.cust_acct_site_id                                                 cust_site_orig_sys_ref
                           ,NULL                                                                                                        cust_contact_orig_system
                           ,hoc.org_contact_id                                                                                          cust_contact_orig_sys_ref
                           ,hcar.role_type                                                                                              role_type
                           ,hcar.primary_flag                                                                                           primary_flag
                           ,NULL                                                                                                        insert_update_flag
                           ,hcar.source_code                                                                                            source_code
                           ,hoc.attribute_category                                                                                      attribute_category
                           ,hoc.attribute1                                                                                              attribute1
                           ,hoc.attribute2                                                                                              attribute2
                           ,hoc.attribute3                                                                                              attribute3
                           ,hoc.attribute4                                                                                              attribute4
                           ,hoc.attribute5                                                                                              attribute5
                           ,hoc.attribute6                                                                                              attribute6
                           ,hoc.attribute7                                                                                              attribute7
                           ,hoc.attribute8                                                                                              attribute8
                           ,hoc.attribute9                                                                                              attribute9
                           ,hoc.attribute10                                                                                             attribute10
                           ,hoc.attribute11                                                                                             attribute11
                           ,hoc.attribute12                                                                                             attribute12
                           ,hoc.attribute13                                                                                             attribute13
                           ,hoc.attribute14                                                                                             attribute14
                           ,hoc.attribute15                                                                                             attribute15
                           ,hoc.attribute16                                                                                             attribute16
                           ,hoc.attribute17                                                                                             attribute17
                           ,hoc.attribute18                                                                                             attribute18
                           ,hoc.attribute19                                                                                             attribute19
                           ,hoc.attribute20                                                                                             attribute20
                           ,NULL                                                                                                        attribute21
                           ,NULL                                                                                                        attribute22
                           ,NULL                                                                                                        attribute23
                           ,NULL                                                                                                        attribute24
                           ,NULL                                                                                                        attribute25
                           ,NULL                                                                                                        attribute26
                           ,NULL                                                                                                        attribute27
                           ,NULL                                                                                                        attribute28
                           ,NULL                                                                                                        attribute29
                           ,NULL                                                                                                        attribute30
                           ,NULL                                                                                                        attribute_number1
                           ,NULL                                                                                                        attribute_number2
                           ,NULL                                                                                                        attribute_number3
                           ,NULL                                                                                                        attribute_number4
                           ,NULL                                                                                                        attribute_number5
                           ,NULL                                                                                                        attribute_number6
                           ,NULL                                                                                                        attribute_number7
                           ,NULL                                                                                                        attribute_number8
                           ,NULL                                                                                                        attribute_number9
                           ,NULL                                                                                                        attribute_number10
                           ,NULL                                                                                                        attribute_number11
                           ,NULL                                                                                                        attribute_number12
                           ,NULL                                                                                                        attribute_date1
                           ,NULL                                                                                                        attribute_date2
                           ,NULL                                                                                                        attribute_date3
                           ,NULL                                                                                                        attribute_date4
                           ,NULL                                                                                                        attribute_date5
                           ,NULL                                                                                                        attribute_date6
                           ,NULL                                                                                                        attribute_date7
                           ,NULL                                                                                                        attribute_date8
                           ,NULL                                                                                                        attribute_date9
                           ,NULL                                                                                                        attribute_date10
                           ,NULL                                                                                                        attribute_date11
                           ,NULL                                                                                                        attribute_date12
                           ,NULL                                                                                                        rel_orig_system
                           ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id                                                  rel_orig_system_reference
                           ,selection.party_id                                                                   party_orig_system_reference
                    FROM  (select distinct account_party_id party_id, party_site_id, cust_account_id, account_number, cust_acct_site_id
                           from XXMX_CUSTOMER_SCOPE_TEMP_STG)                   selection
                         ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT         hoc
                         ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT   hcar
                         ,apps.hz_parties@MXDM_NVIS_EXTRACT              hp1
                         ,apps.hz_relationships@MXDM_NVIS_EXTRACT        hr
                    WHERE hcar.cust_acct_site_id(+)  = selection.cust_acct_site_id
                    AND   hr.subject_id              = hp1.party_id
                    AND   hr.object_id               = selection.party_id
                    AND   hcar.party_id              = hr.party_id
                    AND   hoc.party_relationship_id  = hr.relationship_id
                    AND   hp1.status                 = 'A'
                    AND   hr.status                  = 'A'
--                    and exists (select 1 from apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr where hcar.cust_account_role_id  = hrr.cust_account_role_id and  hrr.responsibility_type not in ('BOOKER','LEARNER'))
                    ) src;
                   --
                   --
              --** END CURSOR **
              --
              --
              --********************
              --** Type Declarations
              --********************
              --
            TYPE hz_cust_acct_contacts_tt IS TABLE OF hz_cust_acct_contacts_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
            cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_cust_acct_contact_stg';
            ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
            ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_cust_acct_contacts_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_cust_acct_contacts_tbl hz_cust_acct_contacts_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
           --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
           --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "hz_cust_acct_contact_stg":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
              --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
                --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_cust_acct_contacts_cur;
                       --
               gvv_ProgressIndicator := '0070';
               --
               LOOP
                    --
                    FETCH hz_cust_acct_contacts_cur
                    BULK COLLECT
                    INTO hz_cust_acct_contacts_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_cust_acct_contacts_tbl.count=0;
                    --
                    gvv_ProgressIndicator := '0080';
                     --
                    FORALL i in 1..hz_cust_acct_contacts_tbl.count
                    insert
                    INTO xxmx_hz_cust_acct_contacts_stg
                        (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,cust_orig_system
                                 ,cust_orig_system_reference
                                 ,cust_site_orig_system
                                 ,cust_site_orig_sys_ref
                                 ,cust_contact_orig_system
                                 ,cust_contact_orig_sys_ref
                                 ,role_type
                                 ,primary_flag
                                 ,insert_update_flag
                                 ,source_code
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,attribute_number1
                                 ,attribute_number2
                                 ,attribute_number3
                                 ,attribute_number4
                                 ,attribute_number5
                                 ,attribute_number6
                                 ,attribute_number7
                                 ,attribute_number8
                                 ,attribute_number9
                                 ,attribute_number10
                                 ,attribute_number11
                                 ,attribute_number12
                                 ,attribute_date1
                                 ,attribute_date2
                                 ,attribute_date3
                                 ,attribute_date4
                                 ,attribute_date5
                                 ,attribute_date6
                                 ,attribute_date7
                                 ,attribute_date8
                                 ,attribute_date9
                                 ,attribute_date10
                                 ,attribute_date11
                                 ,attribute_date12
                                 ,rel_orig_system
                                 ,rel_orig_system_reference
                                 ,load_request_id
                                 ,party_orig_system_reference
                                 --,migration_set_name
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                        )
                        VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_cust_acct_contacts_tbl(i).cust_orig_system
                                 ,hz_cust_acct_contacts_tbl(i).cust_orig_system_reference
                                 ,hz_cust_acct_contacts_tbl(i).cust_site_orig_system
                                 ,hz_cust_acct_contacts_tbl(i).cust_site_orig_sys_ref
                                 ,hz_cust_acct_contacts_tbl(i).cust_contact_orig_system
                                 ,hz_cust_acct_contacts_tbl(i).cust_contact_orig_sys_ref
                                 ,hz_cust_acct_contacts_tbl(i).role_type
                                 ,hz_cust_acct_contacts_tbl(i).primary_flag
                                 ,hz_cust_acct_contacts_tbl(i).insert_update_flag
                                 ,hz_cust_acct_contacts_tbl(i).source_code
                                 ,hz_cust_acct_contacts_tbl(i).attribute_category
                                 ,hz_cust_acct_contacts_tbl(i).attribute1
                                 ,hz_cust_acct_contacts_tbl(i).attribute2
                                 ,hz_cust_acct_contacts_tbl(i).attribute3
                                 ,hz_cust_acct_contacts_tbl(i).attribute4
                                 ,hz_cust_acct_contacts_tbl(i).attribute5
                                 ,hz_cust_acct_contacts_tbl(i).attribute6
                                 ,hz_cust_acct_contacts_tbl(i).attribute7
                                 ,hz_cust_acct_contacts_tbl(i).attribute8
                                 ,hz_cust_acct_contacts_tbl(i).attribute9
                                 ,hz_cust_acct_contacts_tbl(i).attribute10
                                 ,hz_cust_acct_contacts_tbl(i).attribute11
                                 ,hz_cust_acct_contacts_tbl(i).attribute12
                                 ,hz_cust_acct_contacts_tbl(i).attribute13
                                 ,hz_cust_acct_contacts_tbl(i).attribute14
                                 ,hz_cust_acct_contacts_tbl(i).attribute15
                                 ,hz_cust_acct_contacts_tbl(i).attribute16
                                 ,hz_cust_acct_contacts_tbl(i).attribute17
                                 ,hz_cust_acct_contacts_tbl(i).attribute18
                                 ,hz_cust_acct_contacts_tbl(i).attribute19
                                 ,hz_cust_acct_contacts_tbl(i).attribute20
                                 ,hz_cust_acct_contacts_tbl(i).attribute21
                                 ,hz_cust_acct_contacts_tbl(i).attribute22
                                 ,hz_cust_acct_contacts_tbl(i).attribute23
                                 ,hz_cust_acct_contacts_tbl(i).attribute24
                                 ,hz_cust_acct_contacts_tbl(i).attribute25
                                 ,hz_cust_acct_contacts_tbl(i).attribute26
                                 ,hz_cust_acct_contacts_tbl(i).attribute27
                                 ,hz_cust_acct_contacts_tbl(i).attribute28
                                 ,hz_cust_acct_contacts_tbl(i).attribute29
                                 ,hz_cust_acct_contacts_tbl(i).attribute30
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number1
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number2
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number3
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number4
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number5
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number6
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number7
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number8
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number9
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number10
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number11
                                 ,hz_cust_acct_contacts_tbl(i).attribute_number12
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date1
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date2
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date3
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date4
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date5
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date6
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date7
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date8
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date9
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date10
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date11
                                 ,hz_cust_acct_contacts_tbl(i).attribute_date12
                                 ,hz_cust_acct_contacts_tbl(i).rel_orig_system
                                 ,hz_cust_acct_contacts_tbl(i).rel_orig_system_reference
                                 ,hz_cust_acct_contacts_tbl(i).load_request_id
                                 ,hz_cust_acct_contacts_tbl(i).party_orig_system_reference
                                 --,hz_cust_acct_contacts_tbl(i).creation_date
                                 --,hz_cust_acct_contacts_tbl(i).created_by
                                 --,hz_cust_acct_contacts_tbl(i).last_update_date
                                 --,hz_cust_acct_contacts_tbl(i).last_updated_by
                        );
                         --
                    --** END FORALL
                     --
               END LOOP;
                --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
                --
               CLOSE hz_cust_acct_contacts_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0100';
               --
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_cust_acct_contacts_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_contacts_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    if hz_cust_acct_contacts_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_contacts_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                              ,1
                                              ,4000
                                              );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        END hz_cust_acct_contact_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_CONTACTS >-------------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_org_contacts_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_org_contacts_stg
              --
        cursor hz_org_contacts_cur
              IS
                    WITH SELECTION AS
                        (select distinct account_party_id party_id
                        from 
                        XXMX_CUSTOMER_SCOPE_TEMP_STG)
                    SELECT
                            src.insert_update_flag                                    insert_update_flag
                            ,src.contact_number                                       contact_number
                            ,src.department_code                                      department_code
                            ,src.department                                           department
                            ,src.job_title                                            job_title
                            ,src.job_title_code                                       job_title_code
                            ,NULL/*src.attribute_category*/                           attribute_category
                            ,NULL/*src.attribute1*/                                   attribute1
                            ,NULL/*src.attribute2*/                                   attribute2
                            ,NULL/*src.attribute3*/                                   attribute3
                            ,NULL/*src.attribute4*/                                   attribute4
                            ,NULL/*src.attribute5*/                                   attribute5
                            ,NULL/*src.attribute6*/                                   attribute6
                            ,NULL/*src.attribute7*/                                   attribute7
                            ,NULL/*src.attribute8*/                                   attribute8
                            ,NULL/*src.attribute9*/                                   attribute9
                            ,NULL/*src.attribute10*/                                  attribute10
                            ,NULL/*src.attribute11*/                                  attribute11
                            ,NULL/*src.attribute12*/                                  attribute12
                            ,NULL/*src.attribute13*/                                  attribute13
                            ,NULL/*src.attribute14*/                                  attribute14
                            ,NULL/*src.attribute15*/                                  attribute15
                            ,NULL/*src.attribute16*/                                  attribute16
                            ,NULL/*src.attribute17*/                                  attribute17
                            ,NULL/*src.attribute18*/                                  attribute18
                            ,NULL/*src.attribute19*/                                  attribute19
                            ,NULL/*src.attribute20*/                                  attribute20
                            ,NULL/*src.attribute21*/                                  attribute21
                            ,NULL/*src.attribute22*/                                  attribute22
                            ,NULL/*src.attribute23*/                                  attribute23
                            ,NULL/*src.attribute24*/                                  attribute24
                            ,NULL/*src.attribute25*/                                  attribute25
                            ,NULL/*src.attribute26*/                                  attribute26
                            ,NULL/*src.attribute27*/                                  attribute27
                            ,NULL/*src.attribute28*/                                  attribute28
                            ,NULL/*src.attribute29*/                                  attribute29
                            ,NULL/*src.attribute30*/                                  attribute30
                            ,NULL/*src.attribute_number1*/                            attribute_number1
                            ,NULL/*src.attribute_number2*/                            attribute_number2
                            ,NULL/*src.attribute_number3*/                            attribute_number3
                            ,NULL/*src.attribute_number4*/                            attribute_number4
                            ,NULL/*src.attribute_number5*/                            attribute_number5
                            ,NULL/*src.attribute_number6*/                            attribute_number6
                            ,NULL/*src.attribute_number7*/                            attribute_number7
                            ,NULL/*src.attribute_number8*/                            attribute_number8
                            ,NULL/*src.attribute_number9*/                            attribute_number9
                            ,NULL/*src.attribute_number10*/                           attribute_number10
                            ,NULL/*src.attribute_number11*/                           attribute_number11
                            ,NULL/*src.attribute_number12*/                           attribute_number12
                            ,NULL/*src.attribute_date1*/                              attribute_date1
                            ,NULL/*src.attribute_date2*/                              attribute_date2
                            ,NULL/*src.attribute_date3*/                              attribute_date3
                            ,NULL/*src.attribute_date4*/                              attribute_date4
                            ,NULL/*src.attribute_date5*/                              attribute_date5
                            ,NULL/*src.attribute_date6*/                              attribute_date6
                            ,NULL/*src.attribute_date7*/                              attribute_date7
                            ,NULL/*src.attribute_date8*/                              attribute_date8
                            ,NULL/*src.attribute_date9*/                              attribute_date9
                            ,NULL/*src.attribute_date10*/                             attribute_date10
                            ,NULL/*src.attribute_date11*/                             attribute_date11
                            ,NULL/*src.attribute_date12*/                             attribute_date12
                            -- ,src.rel_orig_system                                         rel_orig_system
                            ,decode(src.rel_orig_system_reference,null,null,gct_OrigSystem) rel_orig_system
                            ,src.rel_orig_system_reference                                  rel_orig_system_reference
                            -- ,src.ps_orig_system                                          ps_orig_system
                            ,decode(src.ps_orig_system_reference,null,null,gct_OrigSystem)  ps_orig_system
                            ,src.ps_orig_system_reference                             ps_orig_system_reference
                            ,NULL                                                     load_request_id
                            ,src.party_orig_system_reference                           party_orig_system_reference
            from
               (
                    SELECT  NULL                                                                                                        insert_update_flag
                           ,hoc.contact_number                                                                                          contact_number
                           ,hoc.department_code                                                                                         department_code
                           ,hoc.department                                                                                              department
                           ,hoc.job_title                                                                                               job_title
                           ,hoc.job_title_code                                                                                          job_title_code
                           ,hoc.attribute_category                                                                                      attribute_category
                           ,hoc.attribute1                                                                                              attribute1
                           ,hoc.attribute2                                                                                              attribute2
                           ,hoc.attribute3                                                                                              attribute3
                           ,hoc.attribute4                                                                                              attribute4
                           ,hoc.attribute5                                                                                              attribute5
                           ,hoc.attribute6                                                                                              attribute6
                           ,hoc.attribute7                                                                                              attribute7
                           ,hoc.attribute8                                                                                              attribute8
                           ,hoc.attribute9                                                                                              attribute9
                           ,hoc.attribute10                                                                                             attribute10
                           ,hoc.attribute11                                                                                             attribute11
                           ,hoc.attribute12                                                                                             attribute12
                           ,hoc.attribute13                                                                                             attribute13
                           ,hoc.attribute14                                                                                             attribute14
                           ,hoc.attribute15                                                                                             attribute15
                           ,hoc.attribute16                                                                                             attribute16
                           ,hoc.attribute17                                                                                             attribute17
                           ,hoc.attribute18                                                                                             attribute18
                           ,hoc.attribute19                                                                                             attribute19
                           ,hoc.attribute20                                                                                             attribute20
                           ,hoc.attribute21                                                                                             attribute21
                           ,hoc.attribute22                                                                                             attribute22
                           ,hoc.attribute23                                                                                             attribute23
                           ,hoc.attribute24                                                                                             attribute24
                           ,NULL                                                                                                        attribute25
                           ,NULL                                                                                                        attribute26
                           ,NULL                                                                                                        attribute27
                           ,NULL                                                                                                        attribute28
                           ,NULL                                                                                                        attribute29
                           ,NULL                                                                                                        attribute30
                           ,NULL                                                                                                        attribute_number1
                           ,NULL                                                                                                        attribute_number2
                           ,NULL                                                                                                        attribute_number3
                           ,NULL                                                                                                        attribute_number4
                           ,NULL                                                                                                        attribute_number5
                           ,NULL                                                                                                        attribute_number6
                           ,NULL                                                                                                        attribute_number7
                           ,NULL                                                                                                        attribute_number8
                           ,NULL                                                                                                        attribute_number9
                           ,NULL                                                                                                        attribute_number10
                           ,NULL                                                                                                        attribute_number11
                           ,NULL                                                                                                        attribute_number12
                           ,NULL                                                                                                        attribute_date1
                           ,NULL                                                                                                        attribute_date2
                           ,NULL                                                                                                        attribute_date3
                           ,NULL                                                                                                        attribute_date4
                           ,NULL                                                                                                        attribute_date5
                           ,NULL                                                                                                        attribute_date6
                           ,NULL                                                                                                        attribute_date7
                           ,NULL                                                                                                        attribute_date8
                           ,NULL                                                                                                        attribute_date9
                           ,NULL                                                                                                        attribute_date10
                           ,NULL                                                                                                        attribute_date11
                           ,NULL                                                                                                        attribute_date12
                           ,NULL                                                                                                        rel_orig_system
                           ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id                                                  rel_orig_system_reference
                           ,NULL                                                                                                        ps_orig_system
                           ,NULL                                                                                                        ps_orig_system_reference
                           ,selection.party_id                                                                                   party_orig_system_reference
                    FROM    selection
                           ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT          hoc   -- ISV: Should this have been HZ_CONTACT_POINTS?
                           ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT    hcar
                           ,apps.hz_parties@MXDM_NVIS_EXTRACT               hp1
                           ,apps.hz_relationships@MXDM_NVIS_EXTRACT         hr
                    WHERE  1                           =  1
                    AND    hr.subject_id               =  hp1.party_id
                    AND    hr.object_id                =  selection.party_id
                    AND    hcar.party_id               =  hr.party_id
                    AND    hoc.party_relationship_id   =  hr.relationship_id
                    AND    hcar.cust_acct_site_id      is NULL
                    AND    hp1.status                  = 'A'
                    AND    hr.status                   = 'A'
--                    and exists (select 1 from apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr where hcar.cust_account_role_id  = hrr.cust_account_role_id and  hrr.responsibility_type not in ('BOOKER','LEARNER'))
               UNION
                    SELECT  NULL                                                                                                        insert_update_flag
                           ,hoc.contact_number                                                                                          contact_number
                           ,hoc.department_code                                                                                         department_code
                           ,hoc.department                                                                                              department
                           ,hoc.job_title                                                                                               job_title
                           ,hoc.job_title_code                                                                                          job_title_code
                           ,hoc.attribute_category                                                                                      attribute_category
                           ,hoc.attribute1                                                                                              attribute1
                           ,hoc.attribute2                                                                                              attribute2
                           ,hoc.attribute3                                                                                              attribute3
                           ,hoc.attribute4                                                                                              attribute4
                           ,hoc.attribute5                                                                                              attribute5
                           ,hoc.attribute6                                                                                              attribute6
                           ,hoc.attribute7                                                                                              attribute7
                           ,hoc.attribute8                                                                                              attribute8
                           ,hoc.attribute9                                                                                              attribute9
                           ,hoc.attribute10                                                                                             attribute10
                           ,hoc.attribute11                                                                                             attribute11
                           ,hoc.attribute12                                                                                             attribute12
                           ,hoc.attribute13                                                                                             attribute13
                           ,hoc.attribute14                                                                                             attribute14
                           ,hoc.attribute15                                                                                             attribute15
                           ,hoc.attribute16                                                                                             attribute16
                           ,hoc.attribute17                                                                                             attribute17
                           ,hoc.attribute18                                                                                             attribute18
                           ,hoc.attribute19                                                                                             attribute19
                           ,hoc.attribute20                                                                                             attribute20
                           ,hoc.attribute21                                                                                             attribute21
                           ,hoc.attribute22                                                                                             attribute22
                           ,hoc.attribute23                                                                                             attribute23
                           ,hoc.attribute24                                                                                             attribute24
                           ,NULL                                                                                                        attribute25
                           ,NULL                                                                                                        attribute26
                           ,NULL                                                                                                        attribute27
                           ,NULL                                                                                                        attribute28
                           ,NULL                                                                                                        attribute29
                           ,NULL                                                                                                        attribute30
                           ,NULL                                                                                                        attribute_number1
                           ,NULL                                                                                                        attribute_number2
                           ,NULL                                                                                                        attribute_number3
                           ,NULL                                                                                                        attribute_number4
                           ,NULL                                                                                                        attribute_number5
                           ,NULL                                                                                                        attribute_number6
                           ,NULL                                                                                                        attribute_number7
                           ,NULL                                                                                                        attribute_number8
                           ,NULL                                                                                                        attribute_number9
                           ,NULL                                                                                                        attribute_number10
                           ,NULL                                                                                                        attribute_number11
                           ,NULL                                                                                                        attribute_number12
                           ,NULL                                                                                                        attribute_date1
                           ,NULL                                                                                                        attribute_date2
                           ,NULL                                                                                                        attribute_date3
                           ,NULL                                                                                                        attribute_date4
                           ,NULL                                                                                                        attribute_date5
                           ,NULL                                                                                                        attribute_date6
                           ,NULL                                                                                                        attribute_date7
                           ,NULL                                                                                                        attribute_date8
                           ,NULL                                                                                                        attribute_date9
                           ,NULL                                                                                                        attribute_date10
                           ,NULL                                                                                                        attribute_date11
                           ,NULL                                                                                                        attribute_date12
                           ,NULL                                                                                                        rel_orig_system
                           ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id                                                  rel_orig_system_reference
                           ,NULL                                                                                                        ps_orig_system
                           ,hoc.party_site_id                                                                                           ps_orig_system_reference
                           ,selection.party_id                                                                   party_orig_system_reference
                    FROM    selection
                           ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT          hoc
                           ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT    hcar
                           ,apps.hz_parties@MXDM_NVIS_EXTRACT               hp1
                           ,apps.hz_relationships@MXDM_NVIS_EXTRACT         hr
                    WHERE  1                           =  1
                    AND    hr.subject_id               =  hp1.party_id
                    AND    hr.object_id                =  selection.party_id
                    AND    hcar.party_id               =  hr.party_id
                    AND    hoc.party_relationship_id   =  hr.relationship_id
                    AND    hcar.cust_acct_site_id      IS  NOT NULL
                    AND    hp1.status                  = 'A'
                    AND    hr.status                   = 'A'
--                    and exists (select 1 from apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr where hcar.cust_account_role_id  = hrr.cust_account_role_id and  hrr.responsibility_type not in ('BOOKER','LEARNER'))
                    ) src;
              --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
          TYPE hz_org_contacts_tt IS TABLE OF hz_org_contacts_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_org_contacts_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_org_contacts_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_org_contacts_tbl hz_org_contacts_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
                --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_org_contacts_cur;
                   --
                   --
               LOOP
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    FETCH hz_org_contacts_cur
                    BULK COLLECT
                    INTO hz_org_contacts_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_org_contacts_tbl.count=0;
                     --
                    gvv_ProgressIndicator :='0080';
                   --
                    FORALL i in 1..hz_org_contacts_tbl.count
                    insert
                    INTO xxmx_hz_org_contacts_stg
                        (
                             migration_set_id
                             ,migration_set_name
                             ,migration_status
                             ,insert_update_flag
                             ,contact_number
                             ,department_code
                             ,department
                             ,job_title
                             ,job_title_code
                             ,attribute_category
                             ,attribute1
                             ,attribute2
                             ,attribute3
                             ,attribute4
                             ,attribute5
                             ,attribute6
                             ,attribute7
                             ,attribute8
                             ,attribute9
                             ,attribute10
                             ,attribute11
                             ,attribute12
                             ,attribute13
                             ,attribute14
                             ,attribute15
                             ,attribute16
                             ,attribute17
                             ,attribute18
                             ,attribute19
                             ,attribute20
                             ,attribute21
                             ,attribute22
                             ,attribute23
                             ,attribute24
                             ,attribute25
                             ,attribute26
                             ,attribute27
                             ,attribute28
                             ,attribute29
                             ,attribute30
                             ,attribute_number1
                             ,attribute_number2
                             ,attribute_number3
                             ,attribute_number4
                             ,attribute_number5
                             ,attribute_number6
                             ,attribute_number7
                             ,attribute_number8
                             ,attribute_number9
                             ,attribute_number10
                             ,attribute_number11
                             ,attribute_number12
                             ,attribute_date1
                             ,attribute_date2
                             ,attribute_date3
                             ,attribute_date4
                             ,attribute_date5
                             ,attribute_date6
                             ,attribute_date7
                             ,attribute_date8
                             ,attribute_date9
                             ,attribute_date10
                             ,attribute_date11
                             ,attribute_date12
                             ,rel_orig_system
                             ,rel_orig_system_reference
                             ,ps_orig_system
                             ,ps_orig_system_reference
                             ,load_request_id
                             ,party_orig_system_reference
                             --,creation_date
                             --,created_by
                             --,last_update_date
                             --,last_updated_by
                  ) VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_org_contacts_tbl(i).insert_update_flag
                                 ,hz_org_contacts_tbl(i).contact_number
                                 ,hz_org_contacts_tbl(i).department_code
                                 ,hz_org_contacts_tbl(i).department
                                 ,hz_org_contacts_tbl(i).job_title
                                 ,hz_org_contacts_tbl(i).job_title_code
                                 ,hz_org_contacts_tbl(i).attribute_category
                                 ,hz_org_contacts_tbl(i).attribute1
                                 ,hz_org_contacts_tbl(i).attribute2
                                 ,hz_org_contacts_tbl(i).attribute3
                                 ,hz_org_contacts_tbl(i).attribute4
                                 ,hz_org_contacts_tbl(i).attribute5
                                 ,hz_org_contacts_tbl(i).attribute6
                                 ,hz_org_contacts_tbl(i).attribute7
                                 ,hz_org_contacts_tbl(i).attribute8
                                 ,hz_org_contacts_tbl(i).attribute9
                                 ,hz_org_contacts_tbl(i).attribute10
                                 ,hz_org_contacts_tbl(i).attribute11
                                 ,hz_org_contacts_tbl(i).attribute12
                                 ,hz_org_contacts_tbl(i).attribute13
                                 ,hz_org_contacts_tbl(i).attribute14
                                 ,hz_org_contacts_tbl(i).attribute15
                                 ,hz_org_contacts_tbl(i).attribute16
                                 ,hz_org_contacts_tbl(i).attribute17
                                 ,hz_org_contacts_tbl(i).attribute18
                                 ,hz_org_contacts_tbl(i).attribute19
                                 ,hz_org_contacts_tbl(i).attribute20
                                 ,hz_org_contacts_tbl(i).attribute21
                                 ,hz_org_contacts_tbl(i).attribute22
                                 ,hz_org_contacts_tbl(i).attribute23
                                 ,hz_org_contacts_tbl(i).attribute24
                                 ,hz_org_contacts_tbl(i).attribute25
                                 ,hz_org_contacts_tbl(i).attribute26
                                 ,hz_org_contacts_tbl(i).attribute27
                                 ,hz_org_contacts_tbl(i).attribute28
                                 ,hz_org_contacts_tbl(i).attribute29
                                 ,hz_org_contacts_tbl(i).attribute30
                                 ,hz_org_contacts_tbl(i).attribute_number1
                                 ,hz_org_contacts_tbl(i).attribute_number2
                                 ,hz_org_contacts_tbl(i).attribute_number3
                                 ,hz_org_contacts_tbl(i).attribute_number4
                                 ,hz_org_contacts_tbl(i).attribute_number5
                                 ,hz_org_contacts_tbl(i).attribute_number6
                                 ,hz_org_contacts_tbl(i).attribute_number7
                                 ,hz_org_contacts_tbl(i).attribute_number8
                                 ,hz_org_contacts_tbl(i).attribute_number9
                                 ,hz_org_contacts_tbl(i).attribute_number10
                                 ,hz_org_contacts_tbl(i).attribute_number11
                                 ,hz_org_contacts_tbl(i).attribute_number12
                                 ,hz_org_contacts_tbl(i).attribute_date1
                                 ,hz_org_contacts_tbl(i).attribute_date2
                                 ,hz_org_contacts_tbl(i).attribute_date3
                                 ,hz_org_contacts_tbl(i).attribute_date4
                                 ,hz_org_contacts_tbl(i).attribute_date5
                                 ,hz_org_contacts_tbl(i).attribute_date6
                                 ,hz_org_contacts_tbl(i).attribute_date7
                                 ,hz_org_contacts_tbl(i).attribute_date8
                                 ,hz_org_contacts_tbl(i).attribute_date9
                                 ,hz_org_contacts_tbl(i).attribute_date10
                                 ,hz_org_contacts_tbl(i).attribute_date11
                                 ,hz_org_contacts_tbl(i).attribute_date12
                                 ,hz_org_contacts_tbl(i).rel_orig_system
                                 ,hz_org_contacts_tbl(i).rel_orig_system_reference
                                 ,hz_org_contacts_tbl(i).ps_orig_system
                                 ,hz_org_contacts_tbl(i).ps_orig_system_reference
                                 ,hz_org_contacts_tbl(i).load_request_id
                                 ,hz_org_contacts_tbl(i).party_orig_system_reference
                                 --,hz_org_contacts_tbl(i).creation_date
                                 --,hz_org_contacts_tbl(i).created_by
                                 --,hz_org_contacts_tbl(i).last_update_date
                                 --,hz_org_contacts_tbl(i).last_updated_by
                    );
                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE hz_org_contacts_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_org_contacts_cur%ISOPEN
                    THEN
                        CLOSE hz_org_contacts_cur;
                    END IF;
                    ROLLBACK;
                    --
                   xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    if hz_org_contacts_cur%ISOPEN
                    THEN
                        CLOSE hz_org_contacts_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
          --
        END hz_org_contacts_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_CONTACT_ROLES >--------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_contact_roles_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_contact_roles_stg
              --
        CURSOR hz_org_contact_roles_cur
              IS
                    WITH selection as (
                        SELECT DISTINCT account_party_id party_id
                        FROM XXMX_CUSTOMER_SCOPE_TEMP_STG)
                    SELECT
                                NULL                                                      insert_update_code
                                ,src.insert_update_flag                                   insert_update_flag
                                ,gct_OrigSystem                                           contact_role_orig_system
                                ,src.contact_role_orig_sys_ref                            contact_role_orig_sys_ref
                                --,src.rel_orig_system                                          rel_orig_system
                                ,decode(src.rel_orig_system_reference,null,null,gct_OrigSystem) rel_orig_system
                                ,src.rel_orig_system_reference                            rel_orig_system_reference
                                ,src.role_type                                            role_type
                                ,src.role_level                                           role_level
                                ,src.primary_flag                                         primary_flag
                                ,src.primary_contact_per_role_type                        primary_contact_per_role_type
                                ,NULL/*src.attribute_category*/                           attribute_category
                                ,NULL/*src.attribute1*/                                   attribute1
                                ,NULL/*src.attribute2*/                                   attribute2
                                ,NULL/*src.attribute3*/                                   attribute3
                                ,NULL/*src.attribute4*/                                   attribute4
                                ,NULL/*src.attribute5*/                                   attribute5
                                ,NULL/*src.attribute6*/                                   attribute6
                                ,NULL/*src.attribute7*/                                   attribute7
                                ,NULL/*src.attribute8*/                                   attribute8
                                ,NULL/*src.attribute9*/                                   attribute9
                                ,NULL/*src.attribute10*/                                  attribute10
                                ,NULL/*src.attribute11*/                                  attribute11
                                ,NULL/*src.attribute12*/                                  attribute12
                                ,NULL/*src.attribute13*/                                  attribute13
                                ,NULL/*src.attribute14*/                                  attribute14
                                ,NULL/*src.attribute15*/                                  attribute15
                                ,NULL/*src.attribute16*/                                  attribute16
                                ,NULL/*src.attribute17*/                                  attribute17
                                ,NULL/*src.attribute18*/                                  attribute18
                                ,NULL/*src.attribute19*/                                  attribute19
                                ,NULL/*src.attribute20*/                                  attribute20
                                ,NULL/*src.attribute21*/                                  attribute21
                                ,NULL/*src.attribute22*/                                  attribute22
                                ,NULL/*src.attribute23*/                                  attribute23
                                ,NULL/*src.attribute24*/                                  attribute24
                                ,NULL/*src.attribute25*/                                  attribute25
                                ,NULL/*src.attribute26*/                                  attribute26
                                ,NULL/*src.attribute27*/                                  attribute27
                                ,NULL/*src.attribute28*/                                  attribute28
                                ,NULL/*src.attribute29*/                                  attribute29
                                ,NULL/*src.attribute30*/                                  attribute30
                                ,NULL/*src.attribute_number1*/                            attribute_number1
                                ,NULL/*src.attribute_number2*/                            attribute_number2
                                ,NULL/*src.attribute_number3*/                            attribute_number3
                                ,NULL/*src.attribute_number4*/                            attribute_number4
                                ,NULL/*src.attribute_number5*/                            attribute_number5
                                ,NULL/*src.attribute_number6*/                            attribute_number6
                                ,NULL/*src.attribute_number7*/                            attribute_number7
                                ,NULL/*src.attribute_number8*/                            attribute_number8
                                ,NULL/*src.attribute_number9*/                            attribute_number9
                                ,NULL/*src.attribute_number10*/                           attribute_number10
                                ,NULL/*src.attribute_number11*/                           attribute_number11
                                ,NULL/*src.attribute_number12*/                           attribute_number12
                                ,NULL/*src.attribute_date1*/                              attribute_date1
                                ,NULL/*src.attribute_date2*/                              attribute_date2
                                ,NULL/*src.attribute_date3*/                              attribute_date3
                                ,NULL/*src.attribute_date4*/                              attribute_date4
                                ,NULL/*src.attribute_date5*/                              attribute_date5
                                ,NULL/*src.attribute_date6*/                              attribute_date6
                                ,NULL/*src.attribute_date7*/                              attribute_date7
                                ,NULL/*src.attribute_date8*/                              attribute_date8
                                ,NULL/*src.attribute_date9*/                              attribute_date9
                                ,NULL/*src.attribute_date10*/                             attribute_date10
                                ,NULL/*src.attribute_date11*/                             attribute_date11
                                ,NULL/*src.attribute_date12*/                             attribute_date12
                                ,NULL                                                     load_request_id
                                ,src.party_orig_system_reference                           party_orig_system_reference
            FROM (
                        SELECT  NULL                                                     insert_update_flag
                               ,NULL                                                     contact_role_orig_system
                               ,hocr.org_contact_role_id                                 contact_role_orig_sys_ref
                               ,NULL                                                     rel_orig_system
                               ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id    rel_orig_system_reference
                               ,hocr.role_type                                           role_type
                               ,hocr.role_level                                          role_level
                               ,hocr.primary_flag                                        primary_flag
                               ,hocr.primary_contact_per_role_type                       primary_contact_per_role_type
                               ,hocr.attribute_category                                  attribute_category
                               ,hocr.attribute1                                          attribute1
                               ,hocr.attribute2                                          attribute2
                               ,hocr.attribute3                                          attribute3
                               ,hocr.attribute4                                          attribute4
                               ,hocr.attribute5                                          attribute5
                               ,hocr.attribute6                                          attribute6
                               ,hocr.attribute7                                          attribute7
                               ,hocr.attribute8                                          attribute8
                               ,hocr.attribute9                                          attribute9
                               ,hocr.attribute10                                         attribute10
                               ,hocr.attribute11                                         attribute11
                               ,hocr.attribute12                                         attribute12
                               ,hocr.attribute13                                         attribute13
                               ,hocr.attribute14                                         attribute14
                               ,hocr.attribute15                                         attribute15
                               ,NULL                                                     attribute16
                               ,NULL                                                     attribute17
                               ,NULL                                                     attribute18
                               ,NULL                                                     attribute19
                               ,NULL                                                     attribute20
                               ,NULL                                                     attribute21
                               ,NULL                                                     attribute22
                               ,NULL                                                     attribute23
                               ,NULL                                                     attribute24
                               ,NULL                                                     attribute25
                               ,NULL                                                     attribute26
                               ,NULL                                                     attribute27
                               ,NULL                                                     attribute28
                               ,NULL                                                     attribute29
                               ,NULL                                                     attribute30
                               ,NULL                                                     attribute_number1
                               ,NULL                                                     attribute_number2
                               ,NULL                                                     attribute_number3
                               ,NULL                                                     attribute_number4
                               ,NULL                                                     attribute_number5
                               ,NULL                                                     attribute_number6
                               ,NULL                                                     attribute_number7
                               ,NULL                                                     attribute_number8
                               ,NULL                                                     attribute_number9
                               ,NULL                                                     attribute_number10
                               ,NULL                                                     attribute_number11
                               ,NULL                                                     attribute_number12
                               ,NULL                                                     attribute_date1
                               ,NULL                                                     attribute_date2
                               ,NULL                                                     attribute_date3
                               ,NULL                                                     attribute_date4
                               ,NULL                                                     attribute_date5
                               ,NULL                                                     attribute_date6
                               ,NULL                                                     attribute_date7
                               ,NULL                                                     attribute_date8
                               ,NULL                                                     attribute_date9
                               ,NULL                                                     attribute_date10
                               ,NULL                                                     attribute_date11
                               ,NULL                                                     attribute_date12
                               ,selection.party_id                                       party_orig_system_reference
                        FROM   selection
                               ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT          hoc
                               ,apps.hz_org_contact_roles@MXDM_NVIS_EXTRACT     hocr
                               ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT    hcar
                               ,apps.hz_parties@MXDM_NVIS_EXTRACT               hp1
                               ,apps.hz_relationships@MXDM_NVIS_EXTRACT         hr
                        WHERE  1                           =  1
                        AND    hr.subject_id               =  hp1.party_id
                        AND    hr.object_id                =  selection.party_id
                        AND    hcar.party_id               =  hr.party_id
                        AND    hoc.org_contact_id          =  hocr.org_contact_id
                        AND    hoc.party_relationship_id   =  hr.relationship_id
                        AND    hcar.party_id               =  hr.party_id
                        AND    hcar.cust_acct_site_id      is NULL
                        AND    hp1.status                  = 'A'
                        AND    hr.status                   = 'A'
                        AND    hocr.status                 = 'A'
--                    and exists (select 1 from apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr where hcar.cust_account_role_id  = hrr.cust_account_role_id and  hrr.responsibility_type not in ('BOOKER','LEARNER'))
                    UNION
                    SELECT  NULL                                                     insert_update_flag
                           ,NULL                                                     contact_role_orig_system
                           ,hocr.org_contact_role_id                                 contact_role_orig_sys_ref
                           ,NULL                                                     rel_orig_system
                           ,selection.party_id||'_'||hr.subject_id ||'_'||hr.object_id          rel_orig_system_reference
                           ,hocr.role_type                                           role_type
                           ,hocr.role_level                                          role_level
                           ,hocr.primary_flag                                        primary_flag
                           ,hocr.primary_contact_per_role_type                       primary_contact_per_role_type
                           ,hocr.attribute_category                                  attribute_category
                           ,hocr.attribute1                                          attribute1
                           ,hocr.attribute2                                          attribute2
                           ,hocr.attribute3                                          attribute3
                           ,hocr.attribute4                                          attribute4
                           ,hocr.attribute5                                          attribute5
                           ,hocr.attribute6                                          attribute6
                           ,hocr.attribute7                                          attribute7
                           ,hocr.attribute8                                          attribute8
                           ,hocr.attribute9                                          attribute9
                           ,hocr.attribute10                                         attribute10
                           ,hocr.attribute11                                         attribute11
                           ,hocr.attribute12                                         attribute12
                           ,hocr.attribute13                                         attribute13
                           ,hocr.attribute14                                         attribute14
                           ,hocr.attribute15                                         attribute15
                           ,NULL                                                     attribute16
                           ,NULL                                                     attribute17
                           ,NULL                                                     attribute18
                           ,NULL                                                     attribute19
                           ,NULL                                                     attribute20
                           ,NULL                                                     attribute21
                           ,NULL                                                     attribute22
                           ,NULL                                                     attribute23
                           ,NULL                                                     attribute24
                           ,NULL                                                     attribute25
                           ,NULL                                                     attribute26
                           ,NULL                                                     attribute27
                           ,NULL                                                     attribute28
                           ,NULL                                                     attribute29
                           ,NULL                                                     attribute30
                           ,NULL                                                     attribute_number1
                           ,NULL                                                     attribute_number2
                           ,NULL                                                     attribute_number3
                           ,NULL                                                     attribute_number4
                           ,NULL                                                     attribute_number5
                           ,NULL                                                     attribute_number6
                           ,NULL                                                     attribute_number7
                           ,NULL                                                     attribute_number8
                           ,NULL                                                     attribute_number9
                           ,NULL                                                     attribute_number10
                           ,NULL                                                     attribute_number11
                           ,NULL                                                     attribute_number12
                           ,NULL                                                     attribute_date1
                           ,NULL                                                     attribute_date2
                           ,NULL                                                     attribute_date3
                           ,NULL                                                     attribute_date4
                           ,NULL                                                     attribute_date5
                           ,NULL                                                     attribute_date6
                           ,NULL                                                     attribute_date7
                           ,NULL                                                     attribute_date8
                           ,NULL                                                     attribute_date9
                           ,NULL                                                     attribute_date10
                           ,NULL                                                     attribute_date11
                           ,NULL                                                     attribute_date12
                           ,selection.party_id                                      party_orig_system_reference
                    FROM    selection
                           ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT          hoc
                           ,apps.hz_org_contact_roles@MXDM_NVIS_EXTRACT     hocr
                           ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT    hcar
                           ,apps.hz_parties@MXDM_NVIS_EXTRACT               hp1
                           ,apps.hz_relationships@MXDM_NVIS_EXTRACT         hr
                    WHERE  1                           =  1
                    AND    hr.subject_id               =  hp1.party_id
                    AND    hr.object_id                =  selection.party_id
                    AND    hcar.party_id               =  hr.party_id
                    AND    hoc.org_contact_id          =  hocr.org_contact_id
                    AND    hoc.party_relationship_id   =  hr.relationship_id
                    AND    hp1.status                  = 'A'
                    AND    hr.status                   = 'A'
                    AND    hocr.status                 = 'A'
--                    and exists (select 1 from apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr where hcar.cust_account_role_id  = hrr.cust_account_role_id and  hrr.responsibility_type not in ('BOOKER','LEARNER'))
                    ) src;
                   --
                   --
              --** END CURSOR **
              --
              --
              --********************
              --** Type Declarations
              --********************
              --
          TYPE hz_org_contact_roles_tt IS TABLE OF hz_org_contact_roles_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_contact_roles_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_org_contact_roles_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_org_contact_roles_tbl hz_org_contact_roles_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError        => NULL
                    );
               --
               open hz_org_contact_roles_cur;
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH hz_org_contact_roles_cur
                    BULK COLLECT
                    INTO hz_org_contact_roles_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_org_contact_roles_tbl.count=0;
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    FORALL i in 1..hz_org_contact_roles_tbl.count
                    INSERT
                    INTO xxmx_hz_org_contact_roles_stg
                        (
                              migration_set_id
                             ,migration_set_name
                             ,migration_status
                             ,insert_update_code
                             ,insert_update_flag
                             ,contact_role_orig_system
                             ,contact_role_orig_sys_ref
                             ,rel_orig_system
                             ,rel_orig_system_reference
                             ,role_type
                             ,role_level
                             ,primary_flag
                             ,primary_contact_per_role_type
                             ,attribute_category
                             ,attribute1
                             ,attribute2
                             ,attribute3
                             ,attribute4
                             ,attribute5
                             ,attribute6
                             ,attribute7
                             ,attribute8
                             ,attribute9
                             ,attribute10
                             ,attribute11
                             ,attribute12
                             ,attribute13
                             ,attribute14
                             ,attribute15
                             ,attribute16
                             ,attribute17
                             ,attribute18
                             ,attribute19
                             ,attribute20
                             ,attribute21
                             ,attribute22
                             ,attribute23
                             ,attribute24
                             ,attribute25
                             ,attribute26
                             ,attribute27
                             ,attribute28
                             ,attribute29
                             ,attribute30
                             ,attribute_number1
                             ,attribute_number2
                             ,attribute_number3
                             ,attribute_number4
                             ,attribute_number5
                             ,attribute_number6
                             ,attribute_number7
                             ,attribute_number8
                             ,attribute_number9
                             ,attribute_number10
                             ,attribute_number11
                             ,attribute_number12
                             ,attribute_date1
                             ,attribute_date2
                             ,attribute_date3
                             ,attribute_date4
                             ,attribute_date5
                             ,attribute_date6
                             ,attribute_date7
                             ,attribute_date8
                             ,attribute_date9
                             ,attribute_date10
                             ,attribute_date11
                             ,attribute_date12
                             ,load_request_id
                             ,Party_Orig_System_Reference
                             --,creation_date
                             --,created_by
                             --,last_update_date
                             --,last_updated_by
                    )
                    VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_org_contact_roles_tbl(i).insert_update_code
                                 ,hz_org_contact_roles_tbl(i).insert_update_flag
                                 ,hz_org_contact_roles_tbl(i).contact_role_orig_system
                                 ,hz_org_contact_roles_tbl(i).contact_role_orig_sys_ref
                                 ,hz_org_contact_roles_tbl(i).rel_orig_system
                                 ,hz_org_contact_roles_tbl(i).rel_orig_system_reference
                                 ,hz_org_contact_roles_tbl(i).role_type
                                 ,hz_org_contact_roles_tbl(i).role_level
                                 ,hz_org_contact_roles_tbl(i).primary_flag
                                 ,hz_org_contact_roles_tbl(i).primary_contact_per_role_type
                                 ,hz_org_contact_roles_tbl(i).attribute_category
                                 ,hz_org_contact_roles_tbl(i).attribute1
                                 ,hz_org_contact_roles_tbl(i).attribute2
                                 ,hz_org_contact_roles_tbl(i).attribute3
                                 ,hz_org_contact_roles_tbl(i).attribute4
                                 ,hz_org_contact_roles_tbl(i).attribute5
                                 ,hz_org_contact_roles_tbl(i).attribute6
                                 ,hz_org_contact_roles_tbl(i).attribute7
                                 ,hz_org_contact_roles_tbl(i).attribute8
                                 ,hz_org_contact_roles_tbl(i).attribute9
                                 ,hz_org_contact_roles_tbl(i).attribute10
                                 ,hz_org_contact_roles_tbl(i).attribute11
                                 ,hz_org_contact_roles_tbl(i).attribute12
                                 ,hz_org_contact_roles_tbl(i).attribute13
                                 ,hz_org_contact_roles_tbl(i).attribute14
                                 ,hz_org_contact_roles_tbl(i).attribute15
                                 ,hz_org_contact_roles_tbl(i).attribute16
                                 ,hz_org_contact_roles_tbl(i).attribute17
                                 ,hz_org_contact_roles_tbl(i).attribute18
                                 ,hz_org_contact_roles_tbl(i).attribute19
                                 ,hz_org_contact_roles_tbl(i).attribute20
                                 ,hz_org_contact_roles_tbl(i).attribute21
                                 ,hz_org_contact_roles_tbl(i).attribute22
                                 ,hz_org_contact_roles_tbl(i).attribute23
                                 ,hz_org_contact_roles_tbl(i).attribute24
                                 ,hz_org_contact_roles_tbl(i).attribute25
                                 ,hz_org_contact_roles_tbl(i).attribute26
                                 ,hz_org_contact_roles_tbl(i).attribute27
                                 ,hz_org_contact_roles_tbl(i).attribute28
                                 ,hz_org_contact_roles_tbl(i).attribute29
                                 ,hz_org_contact_roles_tbl(i).attribute30
                                 ,hz_org_contact_roles_tbl(i).attribute_number1
                                 ,hz_org_contact_roles_tbl(i).attribute_number2
                                 ,hz_org_contact_roles_tbl(i).attribute_number3
                                 ,hz_org_contact_roles_tbl(i).attribute_number4
                                 ,hz_org_contact_roles_tbl(i).attribute_number5
                                 ,hz_org_contact_roles_tbl(i).attribute_number6
                                 ,hz_org_contact_roles_tbl(i).attribute_number7
                                 ,hz_org_contact_roles_tbl(i).attribute_number8
                                 ,hz_org_contact_roles_tbl(i).attribute_number9
                                 ,hz_org_contact_roles_tbl(i).attribute_number10
                                 ,hz_org_contact_roles_tbl(i).attribute_number11
                                 ,hz_org_contact_roles_tbl(i).attribute_number12
                                 ,hz_org_contact_roles_tbl(i).attribute_date1
                                 ,hz_org_contact_roles_tbl(i).attribute_date2
                                 ,hz_org_contact_roles_tbl(i).attribute_date3
                                 ,hz_org_contact_roles_tbl(i).attribute_date4
                                 ,hz_org_contact_roles_tbl(i).attribute_date5
                                 ,hz_org_contact_roles_tbl(i).attribute_date6
                                 ,hz_org_contact_roles_tbl(i).attribute_date7
                                 ,hz_org_contact_roles_tbl(i).attribute_date8
                                 ,hz_org_contact_roles_tbl(i).attribute_date9
                                 ,hz_org_contact_roles_tbl(i).attribute_date10
                                 ,hz_org_contact_roles_tbl(i).attribute_date11
                                 ,hz_org_contact_roles_tbl(i).attribute_date12
                                 ,hz_org_contact_roles_tbl(i).load_request_id
                                 ,hz_org_contact_roles_tbl(i).Party_Orig_System_Reference
                                 --,hz_org_contact_roles_tbl(i).creation_date
                                 --,hz_org_contact_roles_tbl(i).created_by
                                 --,hz_org_contact_roles_tbl(i).last_update_date
                                 --,hz_org_contact_roles_tbl(i).last_updated_by
                    );
                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
                --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE hz_org_contact_roles_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
                --
          ELSE
                --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
               --
          END IF;
           --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_org_contact_roles_cur%ISOPEN
                    THEN
                        CLOSE hz_org_contact_roles_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    if hz_org_contact_roles_cur%ISOPEN
                    THEN
                        CLOSE hz_org_contact_roles_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                               ,1
                                              ,4000
                                             );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_contact_roles_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_CONTACT_POINTS >-------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_contact_points_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_contact_points_stg
              --
        cursor hz_contact_points_cur
              IS
                    SELECT
                             gct_OrigSystem                                                         cp_orig_system
                            ,src.cp_orig_system_reference                                           cp_orig_system_reference
                            --,src.party_orig_system                                                  party_orig_system
                            ,decode(src.party_orig_system_reference,null,null,gct_OrigSystem)       party_orig_system
                            ,src.party_orig_system_reference                                        party_orig_system_reference
                            --,src.site_orig_system                                                   site_orig_system
                            ,decode(src.site_orig_system_reference,null,null,gct_OrigSystem)        site_orig_system
                            ,src.site_orig_system_reference                                         site_orig_system_reference
                            ,src.primary_flag                                                       primary_flag
                            ,src.insert_update_flag                                                 insert_update_flag
                            ,src.contact_point_type                                                 contact_point_type
                            ,src.contact_point_purpose                                              contact_point_purpose
                            ,src.email_address                                                      email_address
                            ,src.email_format                                                       email_format
                            ,src.phone_area_code                                                    phone_area_code
                            ,src.phone_country_code                                                 phone_country_code
                            ,src.phone_extension                                                    phone_extension
                            ,src.phone_line_type                                                    phone_line_type
                            ,src.phone_number                                                       phone_number
                            ,src.url                                                                url
                            ,src.phone_calling_calendar                                             phone_calling_calendar
                            ,src.start_date                                                         start_date
                            ,src.end_date                                                           end_date
                            ,NULL/*src.attribute_category*/                                         attribute_category
                            ,NULL/*src.attribute1*/                                                 attribute1
                            ,NULL/*src.attribute2*/                                                 attribute2
                            ,NULL/*src.attribute3*/                                                 attribute3
                            ,NULL/*src.attribute4*/                                                 attribute4
                            ,NULL/*src.attribute5*/                                                 attribute5
                            ,NULL/*src.attribute6*/                                                 attribute6
                            ,NULL/*src.attribute7*/                                                 attribute7
                            ,NULL/*src.attribute8*/                                                 attribute8
                            ,NULL/*src.attribute9*/                                                 attribute9
                            ,NULL/*src.attribute10*/                                                attribute10
                            ,NULL/*src.attribute11*/                                                attribute11
                            ,NULL/*src.attribute12*/                                                attribute12
                            ,NULL/*src.attribute13*/                                                attribute13
                            ,NULL/*src.attribute14*/                                                attribute14
                            ,NULL/*src.attribute15*/                                                attribute15
                            ,NULL/*src.attribute16*/                                                attribute16
                            ,NULL/*src.attribute17*/                                                attribute17
                            ,NULL/*src.attribute18*/                                                attribute18
                            ,NULL/*src.attribute19*/                                                attribute19
                            ,NULL/*src.attribute20*/                                                attribute20
                            ,NULL/*src.attribute21*/                                                attribute21
                            ,NULL/*src.attribute22*/                                                attribute22
                            ,NULL/*src.attribute23*/                                                attribute23
                            ,NULL/*src.attribute24*/                                                attribute24
                            ,NULL/*src.attribute25*/                                                attribute25
                            ,NULL/*src.attribute26*/                                                attribute26
                            ,NULL/*src.attribute27*/                                                attribute27
                            ,NULL/*src.attribute28*/                                                attribute28
                            ,NULL/*src.attribute29*/                                                attribute29
                            ,NULL/*src.attribute30*/                                                attribute30
                            ,NULL/*src.attribute_number1*/                                          attribute_number1
                            ,NULL/*src.attribute_number2*/                                          attribute_number2
                            ,NULL/*src.attribute_number3*/                                          attribute_number3
                            ,NULL/*src.attribute_number4*/                                          attribute_number4
                            ,NULL/*src.attribute_number5*/                                          attribute_number5
                            ,NULL/*src.attribute_number6*/                                          attribute_number6
                            ,NULL/*src.attribute_number7*/                                          attribute_number7
                            ,NULL/*src.attribute_number8*/                                          attribute_number8
                            ,NULL/*src.attribute_number9*/                                          attribute_number9
                            ,NULL/*src.attribute_number10*/                                         attribute_number10
                            ,NULL/*src.attribute_number11*/                                         attribute_number11
                            ,NULL/*src.attribute_number12*/                                         attribute_number12
                            ,NULL/*src.attribute_date1*/                                            attribute_date1
                            ,NULL/*src.attribute_date2*/                                            attribute_date2
                            ,NULL/*src.attribute_date3*/                                            attribute_date3
                            ,NULL/*src.attribute_date4*/                                            attribute_date4
                            ,NULL/*src.attribute_date5*/                                            attribute_date5
                            ,NULL/*src.attribute_date6*/                                            attribute_date6
                            ,NULL/*src.attribute_date7*/                                            attribute_date7
                            ,NULL/*src.attribute_date8*/                                            attribute_date8
                            ,NULL/*src.attribute_date9*/                                            attribute_date9
                            ,NULL/*src.attribute_date10*/                                           attribute_date10
                            ,NULL/*src.attribute_date11*/                                           attribute_date11
                            ,NULL/*src.attribute_date12*/                                           attribute_date12
                            --,src.rel_orig_system                                                    rel_orig_system
                            ,decode(src.rel_orig_system_reference,null,null,gct_OrigSystem)         rel_orig_system
                            ,src.rel_orig_system_reference                                          rel_orig_system_reference
                            ,NULL                                                                   load_request_id
            FROM (
                    SELECT  NULL                                                           cp_orig_system
                           ,hcp.contact_point_id                                           cp_orig_system_reference
                           ,NULL                                                           party_orig_system
                           ,selection.party_id                                             party_orig_system_reference
                           ,NULL                                                           site_orig_system
                           ,NULL                                                           site_orig_system_reference
                           ,hcp.primary_flag                                               primary_flag
                           ,NULL                                                           insert_update_flag
                           ,hcp.contact_point_type                                         contact_point_type
                           ,hcp.contact_point_purpose                                      contact_point_purpose
                           ,hcp.email_address                                              email_address
                           ,hcp.email_format                                               email_format
                           ,hcp.phone_area_code                                            phone_area_code
                           ,hcp.phone_country_code                                         phone_country_code
                           ,hcp.phone_extension                                            phone_extension
                           ,hcp.phone_line_type                                            phone_line_type
                           ,hcp.phone_number                                               phone_number
                           ,hcp.url                                                        url
                           ,hcp.phone_calling_calendar                                     phone_calling_calendar
                           ,NULL                                                           start_date
                           ,NULL                                                           end_date
                           ,hcp.attribute_category                                         attribute_category
                           ,hcp.attribute1                                                 attribute1
                           ,hcp.attribute2                                                 attribute2
                           ,hcp.attribute3                                                 attribute3
                           ,hcp.attribute4                                                 attribute4
                           ,hcp.attribute5                                                 attribute5
                           ,hcp.attribute6                                                 attribute6
                           ,hcp.attribute7                                                 attribute7
                           ,hcp.attribute8                                                 attribute8
                           ,hcp.attribute9                                                 attribute9
                           ,hcp.attribute10                                                attribute10
                           ,hcp.attribute11                                                attribute11
                           ,hcp.attribute12                                                attribute12
                           ,hcp.attribute13                                                attribute13
                           ,hcp.attribute14                                                attribute14
                           ,hcp.attribute15                                                attribute15
                           ,hcp.attribute16                                                attribute16
                           ,hcp.attribute17                                                attribute17
                           ,hcp.attribute18                                                attribute18
                           ,hcp.attribute19                                                attribute19
                           ,hcp.attribute20                                                attribute20
                           ,NULL                                                           attribute21
                           ,NULL                                                           attribute22
                           ,NULL                                                           attribute23
                           ,NULL                                                           attribute24
                           ,NULL                                                           attribute25
                           ,NULL                                                           attribute26
                           ,NULL                                                           attribute27
                           ,NULL                                                           attribute28
                           ,NULL                                                           attribute29
                           ,NULL                                                           attribute30
                           ,NULL                                                           attribute_number1
                           ,NULL                                                           attribute_number2
                           ,NULL                                                           attribute_number3
                           ,NULL                                                           attribute_number4
                           ,NULL                                                           attribute_number5
                           ,NULL                                                           attribute_number6
                           ,NULL                                                           attribute_number7
                           ,NULL                                                           attribute_number8
                           ,NULL                                                           attribute_number9
                           ,NULL                                                           attribute_number10
                           ,NULL                                                           attribute_number11
                           ,NULL                                                           attribute_number12
                           ,NULL                                                           attribute_date1
                           ,NULL                                                           attribute_date2
                           ,NULL                                                           attribute_date3
                           ,NULL                                                           attribute_date4
                           ,NULL                                                           attribute_date5
                           ,NULL                                                           attribute_date6
                           ,NULL                                                           attribute_date7
                           ,NULL                                                           attribute_date8
                           ,NULL                                                           attribute_date9
                           ,NULL                                                           attribute_date10
                           ,NULL                                                           attribute_date11
                           ,NULL                                                           attribute_date12
                           ,NULL                                                           rel_orig_system
                           ,NULL                                                           rel_orig_system_reference
                    FROM   (select distinct account_party_id party_id
                            from XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                           ,apps.hz_contact_points@MXDM_NVIS_EXTRACT        hcp
                    WHERE  1 = 1
                    AND    hcp.owner_table_id          =  selection.party_id
                    AND    hcp.owner_table_name        =  'HZ_PARTIES'
                    AND    hcp.status                  = 'A'
                    UNION
                    SELECT  NULL                                                           cp_orig_system
                           ,hcp.contact_point_id                                           cp_orig_system_reference
                           ,NULL                                                           party_orig_system
                           ,selection.party_id                                             party_orig_system_reference
                           ,NULL                                                           site_orig_system
--                           ,selection.party_site_id                                        site_orig_system_reference
                           ,hps.party_id||'-'||hps.party_site_number                       site_orig_system_reference -- CPL
                           ,hcp.primary_flag                                               primary_flag
                           ,NULL                                                           insert_update_flag
                           ,hcp.contact_point_type                                         contact_point_type
                           ,hcp.contact_point_purpose                                      contact_point_purpose
                           ,hcp.email_address                                              email_address
                           ,hcp.email_format                                               email_format
                           ,hcp.phone_area_code                                            phone_area_code
                           ,hcp.phone_country_code                                         phone_country_code
                           ,hcp.phone_extension                                            phone_extension
                           ,hcp.phone_line_type                                            phone_line_type
                           ,hcp.phone_number                                               phone_number
                           ,hcp.url                                                        url
                           ,hcp.phone_calling_calendar                                     phone_calling_calendar
                           ,NULL                                                           start_date
                           ,NULL                                                           end_date
                           ,hcp.attribute_category                                         attribute_category
                           ,hcp.attribute1                                                 attribute1
                           ,hcp.attribute2                                                 attribute2
                           ,hcp.attribute3                                                 attribute3
                           ,hcp.attribute4                                                 attribute4
                           ,hcp.attribute5                                                 attribute5
                           ,hcp.attribute6                                                 attribute6
                           ,hcp.attribute7                                                 attribute7
                           ,hcp.attribute8                                                 attribute8
                           ,hcp.attribute9                                                 attribute9
                           ,hcp.attribute10                                                attribute10
                           ,hcp.attribute11                                                attribute11
                           ,hcp.attribute12                                                attribute12
                           ,hcp.attribute13                                                attribute13
                           ,hcp.attribute14                                                attribute14
                           ,hcp.attribute15                                                attribute15
                           ,hcp.attribute16                                                attribute16
                           ,hcp.attribute17                                                attribute17
                           ,hcp.attribute18                                                attribute18
                           ,hcp.attribute19                                                attribute19
                           ,hcp.attribute20                                                attribute20
                           ,NULL                                                           attribute21
                           ,NULL                                                           attribute22
                           ,NULL                                                           attribute23
                           ,NULL                                                           attribute24
                           ,NULL                                                           attribute25
                           ,NULL                                                           attribute26
                           ,NULL                                                           attribute27
                           ,NULL                                                           attribute28
                           ,NULL                                                           attribute29
                           ,NULL                                                           attribute30
                           ,NULL                                                           attribute_number1
                           ,NULL                                                           attribute_number2
                           ,NULL                                                           attribute_number3
                           ,NULL                                                           attribute_number4
                           ,NULL                                                           attribute_number5
                           ,NULL                                                           attribute_number6
                           ,NULL                                                           attribute_number7
                           ,NULL                                                           attribute_number8
                           ,NULL                                                           attribute_number9
                           ,NULL                                                           attribute_number10
                           ,NULL                                                           attribute_number11
                           ,NULL                                                           attribute_number12
                           ,NULL                                                           attribute_date1
                           ,NULL                                                           attribute_date2
                           ,NULL                                                           attribute_date3
                           ,NULL                                                           attribute_date4
                           ,NULL                                                           attribute_date5
                           ,NULL                                                           attribute_date6
                           ,NULL                                                           attribute_date7
                           ,NULL                                                           attribute_date8
                           ,NULL                                                           attribute_date9
                           ,NULL                                                           attribute_date10
                           ,NULL                                                           attribute_date11
                           ,NULL                                                           attribute_date12
                           ,NULL                                                           rel_orig_system
                           ,NULL                                                           rel_orig_system_reference
                    FROM   (select distinct account_party_id party_id, party_site_id
                            from XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                           ,apps.hz_contact_points@MXDM_NVIS_EXTRACT        hcp
                           ,apps.hz_party_sites@MXDM_NVIS_EXTRACT           hps
                    WHERE  1 = 1
                    AND    hcp.owner_table_id          =  selection.party_site_id
                    AND    hcp.owner_table_name        =  'HZ_PARTY_SITES'
                    AND    hcp.status                  = 'A'
                    AND    hps.party_Site_Id           = selection.party_site_id
                  )src;
                   --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
          TYPE hz_contact_points_tt IS TABLE OF hz_contact_points_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_contact_points_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_contact_points_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_contact_points_tbl hz_contact_points_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                           ||'.'
                                           ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator :='0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_contact_points_cur;
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH hz_contact_points_cur
                    BULK COLLECT
                    INTO hz_contact_points_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_contact_points_tbl.count=0;
                    --
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    --
                    FORALL i IN 1..hz_contact_points_tbl.count
                    INSERT
                    INTO xxmx_hz_contact_points_stg
                        (
                             migration_set_id
                             ,migration_set_name
                             ,migration_status
                             ,cp_orig_system
                             ,cp_orig_system_reference
                             ,party_orig_system
                             ,party_orig_system_reference
                             ,site_orig_system
                             ,site_orig_system_reference
                             ,primary_flag
                             ,insert_update_flag
                             ,contact_point_type
                             ,contact_point_purpose
                             ,email_address
                             ,email_format
                             ,phone_area_code
                             ,phone_country_code
                             ,phone_extension
                             ,phone_line_type
                             ,phone_number
                             ,url
                             ,phone_calling_calendar
                             ,start_date
                             ,end_date
                             ,attribute_category
                             ,attribute1
                             ,attribute2
                             ,attribute3
                             ,attribute4
                             ,attribute5
                             ,attribute6
                             ,attribute7
                             ,attribute8
                             ,attribute9
                             ,attribute10
                             ,attribute11
                             ,attribute12
                             ,attribute13
                             ,attribute14
                             ,attribute15
                             ,attribute16
                             ,attribute17
                             ,attribute18
                             ,attribute19
                             ,attribute20
                             ,attribute21
                             ,attribute22
                             ,attribute23
                             ,attribute24
                             ,attribute25
                             ,attribute26
                             ,attribute27
                             ,attribute28
                             ,attribute29
                             ,attribute30
                             ,attribute_number1
                             ,attribute_number2
                             ,attribute_number3
                             ,attribute_number4
                             ,attribute_number5
                             ,attribute_number6
                             ,attribute_number7
                             ,attribute_number8
                             ,attribute_number9
                             ,attribute_number10
                             ,attribute_number11
                             ,attribute_number12
                             ,attribute_date1
                             ,attribute_date2
                             ,attribute_date3
                             ,attribute_date4
                             ,attribute_date5
                             ,attribute_date6
                             ,attribute_date7
                             ,attribute_date8
                             ,attribute_date9
                             ,attribute_date10
                             ,attribute_date11
                             ,attribute_date12
                             ,rel_orig_system
                             ,rel_orig_system_reference
                             ,load_request_id
                             --,migration_set_name
                             --,creation_date
                             --,created_by
                             --,last_update_date
                             --,last_updated_by
                    )
                    VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_contact_points_tbl(i).cp_orig_system
                                 ,hz_contact_points_tbl(i).cp_orig_system_reference
                                 ,hz_contact_points_tbl(i).party_orig_system
                                 ,hz_contact_points_tbl(i).party_orig_system_reference
                                 ,hz_contact_points_tbl(i).site_orig_system
                                 ,hz_contact_points_tbl(i).site_orig_system_reference
                                 ,hz_contact_points_tbl(i).primary_flag
                                 ,hz_contact_points_tbl(i).insert_update_flag
                                 ,hz_contact_points_tbl(i).contact_point_type
                                 ,hz_contact_points_tbl(i).contact_point_purpose
                                 ,hz_contact_points_tbl(i).email_address
                                 ,hz_contact_points_tbl(i).email_format
                                 ,hz_contact_points_tbl(i).phone_area_code
                                 ,hz_contact_points_tbl(i).phone_country_code
                                 ,hz_contact_points_tbl(i).phone_extension
                                 ,hz_contact_points_tbl(i).phone_line_type
                                 ,hz_contact_points_tbl(i).phone_number
                                 ,hz_contact_points_tbl(i).url
                                 ,hz_contact_points_tbl(i).phone_calling_calendar
                                 ,hz_contact_points_tbl(i).start_date
                                 ,hz_contact_points_tbl(i).end_date
                                 ,hz_contact_points_tbl(i).attribute_category
                                 ,hz_contact_points_tbl(i).attribute1
                                 ,hz_contact_points_tbl(i).attribute2
                                 ,hz_contact_points_tbl(i).attribute3
                                 ,hz_contact_points_tbl(i).attribute4
                                 ,hz_contact_points_tbl(i).attribute5
                                 ,hz_contact_points_tbl(i).attribute6
                                 ,hz_contact_points_tbl(i).attribute7
                                 ,hz_contact_points_tbl(i).attribute8
                                 ,hz_contact_points_tbl(i).attribute9
                                 ,hz_contact_points_tbl(i).attribute10
                                 ,hz_contact_points_tbl(i).attribute11
                                 ,hz_contact_points_tbl(i).attribute12
                                 ,hz_contact_points_tbl(i).attribute13
                                 ,hz_contact_points_tbl(i).attribute14
                                 ,hz_contact_points_tbl(i).attribute15
                                 ,hz_contact_points_tbl(i).attribute16
                                 ,hz_contact_points_tbl(i).attribute17
                                 ,hz_contact_points_tbl(i).attribute18
                                 ,hz_contact_points_tbl(i).attribute19
                                 ,hz_contact_points_tbl(i).attribute20
                                 ,hz_contact_points_tbl(i).attribute21
                                 ,hz_contact_points_tbl(i).attribute22
                                 ,hz_contact_points_tbl(i).attribute23
                                 ,hz_contact_points_tbl(i).attribute24
                                 ,hz_contact_points_tbl(i).attribute25
                                 ,hz_contact_points_tbl(i).attribute26
                                 ,hz_contact_points_tbl(i).attribute27
                                 ,hz_contact_points_tbl(i).attribute28
                                 ,hz_contact_points_tbl(i).attribute29
                                 ,hz_contact_points_tbl(i).attribute30
                                 ,hz_contact_points_tbl(i).attribute_number1
                                 ,hz_contact_points_tbl(i).attribute_number2
                                 ,hz_contact_points_tbl(i).attribute_number3
                                 ,hz_contact_points_tbl(i).attribute_number4
                                 ,hz_contact_points_tbl(i).attribute_number5
                                 ,hz_contact_points_tbl(i).attribute_number6
                                 ,hz_contact_points_tbl(i).attribute_number7
                                 ,hz_contact_points_tbl(i).attribute_number8
                                 ,hz_contact_points_tbl(i).attribute_number9
                                 ,hz_contact_points_tbl(i).attribute_number10
                                 ,hz_contact_points_tbl(i).attribute_number11
                                 ,hz_contact_points_tbl(i).attribute_number12
                                 ,hz_contact_points_tbl(i).attribute_date1
                                 ,hz_contact_points_tbl(i).attribute_date2
                                 ,hz_contact_points_tbl(i).attribute_date3
                                 ,hz_contact_points_tbl(i).attribute_date4
                                 ,hz_contact_points_tbl(i).attribute_date5
                                 ,hz_contact_points_tbl(i).attribute_date6
                                 ,hz_contact_points_tbl(i).attribute_date7
                                 ,hz_contact_points_tbl(i).attribute_date8
                                 ,hz_contact_points_tbl(i).attribute_date9
                                 ,hz_contact_points_tbl(i).attribute_date10
                                 ,hz_contact_points_tbl(i).attribute_date11
                                 ,hz_contact_points_tbl(i).attribute_date12
                                 ,hz_contact_points_tbl(i).rel_orig_system
                                 ,hz_contact_points_tbl(i).rel_orig_system_reference
                                 ,hz_contact_points_tbl(i).load_request_id
                                 --,hz_contact_points_tbl(i).creation_date
                                 --,hz_contact_points_tbl(i).created_by
                                 --,hz_contact_points_tbl(i).last_update_date
                                 --,hz_contact_points_tbl(i).last_updated_by
                    );
                         --
                         --
                    --** END FORALL
                    --
                    --
               END LOOP;
               --
               --
               gvv_ProgressIndicator :='0090';
               --
               --
               --
               COMMIT;
               --
               --
               gvv_ProgressIndicator :='0100';
               --
               --
                CLOSE hz_contact_points_cur;
               --
               --
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_contact_points_cur%ISOPEN
                    THEN
                        CLOSE hz_contact_points_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
                --
               WHEN OTHERS
               THEN
                    --
                    if hz_contact_points_cur%ISOPEN
                    THEN
                        CLOSE hz_contact_points_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                              ,1
                                              ,4000
                                              );
                   --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    --
                    RAISE;
                    --
                    --
               --** END OTHERS Exception
               --
               --
          --** END Exception Handler
          --
          --
        END hz_contact_points_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_PERSON_LANG >----------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_person_language_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_person_language_stg
              --
        cursor hz_person_language_cur
              IS
                SELECT
                     gct_OrigSystem                                           party_orig_system
                    ,hpl.party_id                                             party_orig_system_reference
                    ,hpl.language_name                                        language_name
                    ,hpl.native_language                                      native_language_flag
                    ,hpl.primary_language_indicator                           primary_language_indicator
                    ,NULL                                                     load_request_id
                FROM  XXMX_HZ_PARTIES_STG xhps
                     ,apps.hz_person_language@MXDM_NVIS_EXTRACT hpl
                WHERE xhps.migration_set_id = pt_i_MigrationSetID
                AND   xhps.party_type = 'PERSON'
                AND   hpl.party_id    = xhps.PARTY_ORIG_SYSTEM_REFERENCE
                AND   hpl.status      = 'A';
              --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
          TYPE hz_person_language_tt IS TABLE OF hz_person_language_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_person_language_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_person_language_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_person_language_tbl hz_person_language_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0020';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          gvv_ProgressIndicator :='0030';
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError       => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               /*
               ** The Migration Set has been initialised, so now initialize the detail record
               ** for the current entity.
               */
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_person_language_cur;
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH hz_person_language_cur
                    BULK COLLECT
                    INTO hz_person_language_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_person_language_tbl.count=0;
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    FORALL i in 1..hz_person_language_tbl.count
                    INSERT
                    INTO xxmx_hz_person_language_stg
                        (
                         migration_set_id
                        ,migration_set_name
                        ,migration_status
                        ,party_orig_system
                        ,party_orig_system_reference
                        ,language_name
                        ,native_language_flag
                        ,primary_language_indicator
                        ,load_request_id
                        --,creation_date
                        --,created_by
                        --,last_update_date
                        --,last_updated_by
                  ) VALUES (
                             pt_i_MigrationSetID                               --MIGRATION_SET_ID
                            ,gvt_MigrationSetName                               --migration_set_name
                            ,'EXTRACTED'                                       --MIGRATION_STATUS
                            ,hz_person_language_tbl(i).party_orig_system
                            ,hz_person_language_tbl(i).party_orig_system_reference
                            ,hz_person_language_tbl(i).language_name
                            ,hz_person_language_tbl(i).native_language_flag
                            ,hz_person_language_tbl(i).primary_language_indicator
                            ,hz_person_language_tbl(i).load_request_id
                            --,hz_person_language_tbl(i).migration_set_name
                            --,hz_person_language_tbl(i).creation_date
                            --,hz_person_language_tbl(i).created_by
                            --,hz_person_language_tbl(i).last_update_date
                            --,hz_person_language_tbl(i).last_updated_by
                           );
                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
                --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE hz_person_language_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
          ELSE
               --
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    IF hz_person_language_cur%ISOPEN
                    THEN
                        CLOSE hz_person_language_cur;
                    END IF;
                    ROLLBACK;
                    --
                   xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    IF hz_person_language_cur%ISOPEN
                    THEN
                        CLOSE hz_person_language_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                             SQLERRM
                                           ||'** ERROR_BACKTRACE: '
                                           ||dbms_utility.format_error_backtrace
                                            ,1
                                            ,4000
                                            );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_person_language_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_CLASSIFICATION >-------------------
    -- ------------------------------------------------------------------------------
    PROCEDURE hz_party_classifs_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_party_classifs_stg
              --
                cursor hz_party_classifs_cur
                IS
                    SELECT
                             gct_OrigSystem                                                                                                    party_orig_system
                            ,hcassign.owner_table_id                                                                                           party_orig_system_reference
                            ,gct_OrigSystem                                                                                                    classific_orig_system
                            ,hcassign.code_assignment_id                                                                                       classific_orig_system_ref
                            ,hcassign.class_category                                                                                           class_category
                            ,hcassign.class_code                                                                                               class_code
                            ,hcassign.start_date_active                                                                                        start_date_active
                            ,NULL                                                                                                              insert_update_flag
                            ,hcassign.primary_flag                                                                                             primary_flag
                            ,hcassign.end_date_active                                                                                          end_date_active
                            ,hcassign.rank                                                                                                     rank
                            ,NULL                                                                                                              attribute_category
                            ,NULL                                                                                                              attribute1
                            ,NULL                                                                                                              attribute2
                            ,NULL                                                                                                              attribute3
                            ,NULL                                                                                                              attribute4
                            ,NULL                                                                                                              attribute5
                            ,NULL                                                                                                              attribute6
                            ,NULL                                                                                                              attribute7
                            ,NULL                                                                                                              attribute8
                            ,NULL                                                                                                              attribute9
                            ,NULL                                                                                                              attribute10
                            ,NULL                                                                                                              attribute11
                            ,NULL                                                                                                              attribute12
                            ,NULL                                                                                                              attribute13
                            ,NULL                                                                                                              attribute14
                            ,NULL                                                                                                              attribute15
                            ,NULL                                                                                                              attribute16
                            ,NULL                                                                                                              attribute17
                            ,NULL                                                                                                              attribute18
                            ,NULL                                                                                                              attribute19
                            ,NULL                                                                                                              attribute20
                            ,NULL                                                                                                              attribute21
                            ,NULL                                                                                                              attribute22
                            ,NULL                                                                                                              attribute23
                            ,NULL                                                                                                              attribute24
                            ,NULL                                                                                                              attribute25
                            ,NULL                                                                                                              attribute26
                            ,NULL                                                                                                              attribute27
                            ,NULL                                                                                                              attribute28
                            ,NULL                                                                                                              attribute29
                            ,NULL                                                                                                              attribute30
                            ,NULL                                                                                                              attribute_number1
                            ,NULL                                                                                                              attribute_number2
                            ,NULL                                                                                                              attribute_number3
                            ,NULL                                                                                                              attribute_number4
                            ,NULL                                                                                                              attribute_number5
                            ,NULL                                                                                                              attribute_number6
                            ,NULL                                                                                                              attribute_number7
                            ,NULL                                                                                                              attribute_number8
                            ,NULL                                                                                                              attribute_number9
                            ,NULL                                                                                                              attribute_number10
                            ,NULL                                                                                                              attribute_number11
                            ,NULL                                                                                                              attribute_number12
                            ,NULL                                                                                                              attribute_date1
                            ,NULL                                                                                                              attribute_date2
                            ,NULL                                                                                                              attribute_date3
                            ,NULL                                                                                                              attribute_date4
                            ,NULL                                                                                                              attribute_date5
                            ,NULL                                                                                                              attribute_date6
                            ,NULL                                                                                                              attribute_date7
                            ,NULL                                                                                                              attribute_date8
                            ,NULL                                                                                                              attribute_date9
                            ,NULL                                                                                                              attribute_date10
                            ,NULL                                                                                                              attribute_date11
                            ,NULL                                                                                                              attribute_date12
                            ,NULL                                                                                                              load_request_id
                    FROM   XXMX_HZ_PARTIES_STG                           xhps
                          ,apps.hz_code_assignments@MXDM_NVIS_EXTRACT    hcassign
                    WHERE  xhps.migration_set_id = pt_i_MigrationSetID
                    AND   hcassign.owner_table_id   = xhps.PARTY_ORIG_SYSTEM_REFERENCE
                    AND    hcassign.owner_table_name = 'HZ_PARTIES'
                    AND    hcassign.status              = 'A';
                   --
                   --
              --** END CURSOR **
              --
              --
              --********************
              --** Type Declarations
              --********************
              --
            TYPE hz_party_classifs_tt IS TABLE OF hz_party_classifs_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --
              --************************
              --** Constant Declarations
              --************************
            cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_party_classifs_stg';
            ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
            ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_party_classifs_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_party_classifs_tbl hz_party_classifs_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               --
               RAISE e_ModuleError;
               --
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError       => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_party_classifs_cur;
                   --
                   LOOP
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    FETCH hz_party_classifs_cur
                    BULK COLLECT
                    INTO hz_party_classifs_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_party_classifs_tbl.count=0;
                    --
                    gvv_ProgressIndicator :='0070';
                    --
                    FORALL i in 1..hz_party_classifs_tbl.count
                    INSERT
                    INTO xxmx_hz_party_classifs_stg
                        (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                 ,party_orig_system
                                 ,party_orig_system_reference
                                 ,classific_orig_system
                                 ,classific_orig_system_ref
                                 ,class_category
                                 ,class_code
                                 ,start_date_active
                                 ,insert_update_flag
                                 ,primary_flag
                                 ,end_date_active
                                 ,rank
                                 ,attribute_category
                                 ,attribute1
                                 ,attribute2
                                 ,attribute3
                                 ,attribute4
                                 ,attribute5
                                 ,attribute6
                                 ,attribute7
                                 ,attribute8
                                 ,attribute9
                                 ,attribute10
                                 ,attribute11
                                 ,attribute12
                                 ,attribute13
                                 ,attribute14
                                 ,attribute15
                                 ,attribute16
                                 ,attribute17
                                 ,attribute18
                                 ,attribute19
                                 ,attribute20
                                 ,attribute21
                                 ,attribute22
                                 ,attribute23
                                 ,attribute24
                                 ,attribute25
                                 ,attribute26
                                 ,attribute27
                                 ,attribute28
                                 ,attribute29
                                 ,attribute30
                                 ,attribute_number1
                                 ,attribute_number2
                                 ,attribute_number3
                                 ,attribute_number4
                                 ,attribute_number5
                                 ,attribute_number6
                                 ,attribute_number7
                                 ,attribute_number8
                                 ,attribute_number9
                                 ,attribute_number10
                                 ,attribute_number11
                                 ,attribute_number12
                                 ,attribute_date1
                                 ,attribute_date2
                                 ,attribute_date3
                                 ,attribute_date4
                                 ,attribute_date5
                                 ,attribute_date6
                                 ,attribute_date7
                                 ,attribute_date8
                                 ,attribute_date9
                                 ,attribute_date10
                                 ,attribute_date11
                                 ,attribute_date12
                                 ,load_request_id
                                 --,migration_set_name
                                 --,creation_date
                                 --,created_by
                                 --,last_update_date
                                 --,last_updated_by
                    )
                    VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_party_classifs_tbl(i).party_orig_system
                                 ,hz_party_classifs_tbl(i).party_orig_system_reference
                                 ,hz_party_classifs_tbl(i).classific_orig_system
                                 ,hz_party_classifs_tbl(i).classific_orig_system_ref
                                 ,hz_party_classifs_tbl(i).class_category
                                 ,hz_party_classifs_tbl(i).class_code
                                 ,hz_party_classifs_tbl(i).start_date_active
                                 ,hz_party_classifs_tbl(i).insert_update_flag
                                 ,hz_party_classifs_tbl(i).primary_flag
                                 ,hz_party_classifs_tbl(i).end_date_active
                                 ,hz_party_classifs_tbl(i).rank
                                 ,hz_party_classifs_tbl(i).attribute_category
                                 ,hz_party_classifs_tbl(i).attribute1
                                 ,hz_party_classifs_tbl(i).attribute2
                                 ,hz_party_classifs_tbl(i).attribute3
                                 ,hz_party_classifs_tbl(i).attribute4
                                 ,hz_party_classifs_tbl(i).attribute5
                                 ,hz_party_classifs_tbl(i).attribute6
                                 ,hz_party_classifs_tbl(i).attribute7
                                 ,hz_party_classifs_tbl(i).attribute8
                                 ,hz_party_classifs_tbl(i).attribute9
                                 ,hz_party_classifs_tbl(i).attribute10
                                 ,hz_party_classifs_tbl(i).attribute11
                                 ,hz_party_classifs_tbl(i).attribute12
                                 ,hz_party_classifs_tbl(i).attribute13
                                 ,hz_party_classifs_tbl(i).attribute14
                                 ,hz_party_classifs_tbl(i).attribute15
                                 ,hz_party_classifs_tbl(i).attribute16
                                 ,hz_party_classifs_tbl(i).attribute17
                                 ,hz_party_classifs_tbl(i).attribute18
                                 ,hz_party_classifs_tbl(i).attribute19
                                 ,hz_party_classifs_tbl(i).attribute20
                                 ,hz_party_classifs_tbl(i).attribute21
                                 ,hz_party_classifs_tbl(i).attribute22
                                 ,hz_party_classifs_tbl(i).attribute23
                                 ,hz_party_classifs_tbl(i).attribute24
                                 ,hz_party_classifs_tbl(i).attribute25
                                 ,hz_party_classifs_tbl(i).attribute26
                                 ,hz_party_classifs_tbl(i).attribute27
                                 ,hz_party_classifs_tbl(i).attribute28
                                 ,hz_party_classifs_tbl(i).attribute29
                                 ,hz_party_classifs_tbl(i).attribute30
                                 ,hz_party_classifs_tbl(i).attribute_number1
                                 ,hz_party_classifs_tbl(i).attribute_number2
                                 ,hz_party_classifs_tbl(i).attribute_number3
                                 ,hz_party_classifs_tbl(i).attribute_number4
                                 ,hz_party_classifs_tbl(i).attribute_number5
                                 ,hz_party_classifs_tbl(i).attribute_number6
                                 ,hz_party_classifs_tbl(i).attribute_number7
                                 ,hz_party_classifs_tbl(i).attribute_number8
                                 ,hz_party_classifs_tbl(i).attribute_number9
                                 ,hz_party_classifs_tbl(i).attribute_number10
                                 ,hz_party_classifs_tbl(i).attribute_number11
                                 ,hz_party_classifs_tbl(i).attribute_number12
                                 ,hz_party_classifs_tbl(i).attribute_date1
                                 ,hz_party_classifs_tbl(i).attribute_date2
                                 ,hz_party_classifs_tbl(i).attribute_date3
                                 ,hz_party_classifs_tbl(i).attribute_date4
                                 ,hz_party_classifs_tbl(i).attribute_date5
                                 ,hz_party_classifs_tbl(i).attribute_date6
                                 ,hz_party_classifs_tbl(i).attribute_date7
                                 ,hz_party_classifs_tbl(i).attribute_date8
                                 ,hz_party_classifs_tbl(i).attribute_date9
                                 ,hz_party_classifs_tbl(i).attribute_date10
                                 ,hz_party_classifs_tbl(i).attribute_date11
                                 ,hz_party_classifs_tbl(i).attribute_date12
                                 ,hz_party_classifs_tbl(i).load_request_id
                             -- ,hz_party_classifs_tbl(i).creation_date
                             -- ,hz_party_classifs_tbl(i).created_by
                             --,hz_party_classifs_tbl(i).last_update_date
                             -- ,hz_party_classifs_tbl(i).last_updated_by
                            );
                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE hz_party_classifs_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               --** DSF 30/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0100';
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          EXCEPTION
               --
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_party_classifs_cur%ISOPEN
                    THEN
                        CLOSE hz_party_classifs_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError        => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               --
               WHEN OTHERS
               THEN
                    --
                    if hz_party_classifs_cur%ISOPEN
                    THEN
                        CLOSE hz_party_classifs_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                             ,1
                                             ,4000
                                             );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_party_classifs_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< SRC_AR_ROLERESP >-------------------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_role_resps_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_role_resps_stg
              --
        cursor hz_role_resps_cur
              IS
                    SELECT
                             src.insert_update_code                                       insert_update_code
                            ,src.insert_update_flag                                       insert_update_flag
                            ,gct_OrigSystem                                               cust_contact_orig_system
                            ,src.cust_contact_orig_sys_ref                                cust_contact_orig_sys_ref
                            ,gct_OrigSystem                                               role_resp_orig_system
                            ,src.role_resp_orig_sys_ref                                   role_resp_orig_sys_ref
                            ,src.responsibility_type                                      responsibility_type
                            ,src.primary_flag                                             primary_flag
                            ,NULL/*src.attribute_category*/                               attribute_category
                            ,NULL/*src.attribute1*/                                       attribute1
                            ,NULL/*src.attribute2*/                                       attribute2
                            ,NULL/*src.attribute3*/                                       attribute3
                            ,NULL/*src.attribute4*/                                       attribute4
                            ,NULL/*src.attribute5*/                                       attribute5
                            ,NULL/*src.attribute6*/                                       attribute6
                            ,NULL/*src.attribute7*/                                       attribute7
                            ,NULL/*src.attribute8*/                                       attribute8
                            ,NULL/*src.attribute9*/                                       attribute9
                            ,NULL/*src.attribute10*/                                      attribute10
                            ,NULL/*src.attribute11*/                                      attribute11
                            ,NULL/*src.attribute12*/                                      attribute12
                            ,NULL/*src.attribute13*/                                      attribute13
                            ,NULL/*src.attribute14*/                                      attribute14
                            ,NULL/*src.attribute15*/                                      attribute15
                            ,NULL/*src.attribute16*/                                      attribute16
                            ,NULL/*src.attribute17*/                                      attribute17
                            ,NULL/*src.attribute18*/                                      attribute18
                            ,NULL/*src.attribute19*/                                      attribute19
                            ,NULL/*src.attribute20*/                                      attribute20
                            ,NULL/*src.attribute21*/                                      attribute21
                            ,NULL/*src.attribute22*/                                      attribute22
                            ,NULL/*src.attribute23*/                                      attribute23
                            ,NULL/*src.attribute24*/                                      attribute24
                            ,NULL/*src.attribute25*/                                      attribute25
                            ,NULL/*src.attribute26*/                                      attribute26
                            ,NULL/*src.attribute27*/                                      attribute27
                            ,NULL/*src.attribute28*/                                      attribute28
                            ,NULL/*src.attribute29*/                                      attribute29
                            ,NULL/*src.attribute30*/                                      attribute30
                            ,NULL/*src.attribute_number1*/                                attribute_number1
                            ,NULL/*src.attribute_number2*/                                attribute_number2
                            ,NULL/*src.attribute_number3*/                                attribute_number3
                            ,NULL/*src.attribute_number4*/                                attribute_number4
                            ,NULL/*src.attribute_number5*/                                attribute_number5
                            ,NULL/*src.attribute_number6*/                                attribute_number6
                            ,NULL/*src.attribute_number7*/                                attribute_number7
                            ,NULL/*src.attribute_number8*/                                attribute_number8
                            ,NULL/*src.attribute_number9*/                                attribute_number9
                            ,NULL/*src.attribute_number10*/                               attribute_number10
                            ,NULL/*src.attribute_number11*/                               attribute_number11
                            ,NULL/*src.attribute_number12*/                               attribute_number12
                            ,NULL/*src.attribute_date1*/                                  attribute_date1
                            ,NULL/*src.attribute_date2*/                                  attribute_date2
                            ,NULL/*src.attribute_date3*/                                  attribute_date3
                            ,NULL/*src.attribute_date4*/                                  attribute_date4
                            ,NULL/*src.attribute_date5*/                                  attribute_date5
                            ,NULL/*src.attribute_date6*/                                  attribute_date6
                            ,NULL/*src.attribute_date7*/                                  attribute_date7
                            ,NULL/*src.attribute_date8*/                                  attribute_date8
                            ,NULL/*src.attribute_date9*/                                  attribute_date9
                            ,NULL/*src.attribute_date10*/                                 attribute_date10
                            ,NULL/*src.attribute_date11*/                                 attribute_date11
                            ,NULL/*src.attribute_date12*/                                 attribute_date12
                            ,NULL                                                         load_request_id
                            ,src.party_orig_system_reference                              party_orig_system_reference
            FROM
                (
                    SELECT  NULL                                                     insert_update_code
                            ,NULL                                                     insert_update_flag
                            ,NULL                                                     cust_contact_orig_system
                            ,hoc.org_contact_id                                       cust_contact_orig_sys_ref
                            ,NULL                                                     role_resp_orig_system
                            ,hrr.responsibility_id                                    role_resp_orig_sys_ref
                            ,hrr.responsibility_type                                  responsibility_type
                            ,hrr.primary_flag                                         primary_flag
                            ,hrr.attribute_category                                   attribute_category
                            ,hrr.attribute1                                           attribute1
                            ,hrr.attribute2                                           attribute2
                            ,hrr.attribute3                                           attribute3
                            ,hrr.attribute4                                           attribute4
                            ,hrr.attribute5                                           attribute5
                            ,hrr.attribute6                                           attribute6
                            ,hrr.attribute7                                           attribute7
                            ,hrr.attribute8                                           attribute8
                            ,hrr.attribute9                                           attribute9
                            ,hrr.attribute10                                          attribute10
                            ,hrr.attribute11                                          attribute11
                            ,hrr.attribute12                                          attribute12
                            ,hrr.attribute13                                          attribute13
                            ,hrr.attribute14                                          attribute14
                            ,hrr.attribute15                                          attribute15
                            ,NULL                                                     attribute16
                            ,NULL                                                     attribute17
                            ,NULL                                                     attribute18
                            ,NULL                                                     attribute19
                            ,NULL                                                     attribute20
                            ,NULL                                                     attribute21
                            ,NULL                                                     attribute22
                            ,NULL                                                     attribute23
                            ,NULL                                                     attribute24
                            ,NULL                                                     attribute25
                            ,NULL                                                     attribute26
                            ,NULL                                                     attribute27
                            ,NULL                                                     attribute28
                            ,NULL                                                     attribute29
                            ,NULL                                                     attribute30
                            ,NULL                                                     attribute_number1
                            ,NULL                                                     attribute_number2
                            ,NULL                                                     attribute_number3
                            ,NULL                                                     attribute_number4
                            ,NULL                                                     attribute_number5
                            ,NULL                                                     attribute_number6
                            ,NULL                                                     attribute_number7
                            ,NULL                                                     attribute_number8
                            ,NULL                                                     attribute_number9
                            ,NULL                                                     attribute_number10
                            ,NULL                                                     attribute_number11
                            ,NULL                                                     attribute_number12
                            ,NULL                                                     attribute_date1
                            ,NULL                                                     attribute_date2
                            ,NULL                                                     attribute_date3
                            ,NULL                                                     attribute_date4
                            ,NULL                                                     attribute_date5
                            ,NULL                                                     attribute_date6
                            ,NULL                                                     attribute_date7
                            ,NULL                                                     attribute_date8
                            ,NULL                                                     attribute_date9
                            ,NULL                                                     attribute_date10
                            ,NULL                                                     attribute_date11
                            ,NULL                                                     attribute_date12
                             ,selection.party_id                                      party_orig_system_reference
                FROM   (select distinct account_party_id party_id
                        from XXMX_CUSTOMER_SCOPE_TEMP_STG)                     selection
                       ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT          hoc
                       ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT    hcar
                       ,apps.hz_role_responsibility@MXDM_NVIS_EXTRACT   hrr
                       ,apps.hz_parties@MXDM_NVIS_EXTRACT               hp1
                       ,apps.hz_relationships@MXDM_NVIS_EXTRACT         hr
                WHERE  1                           = 1
                AND    hr.subject_id               = hp1.party_id
                AND    hr.object_id                = selection.party_id
                AND    hcar.party_id               = selection.party_id  -- is this the correct party?
                AND    hoc.party_relationship_id   = hr.relationship_id
                AND    hcar.cust_account_role_id   = hrr.cust_account_role_id
                AND    hcar.cust_acct_site_id      is NULL
                AND    hp1.status                  = 'A'
                AND    hr.status                   = 'A'
                AND    hoc.status                  = 'A'
                AND    hcar.status                 = 'A'
                UNION
                SELECT  NULL                                                                                                        insert_update_code
                       ,NULL                                                                                                        insert_update_flag
                       ,NULL                                                                                                        cust_contact_orig_system
                       ,hoc.org_contact_id                                                                                          cust_contact_orig_sys_ref
                       ,NULL                                                                                                        role_resp_orig_system
                       ,hrr.responsibility_id                                                                                       role_resp_orig_sys_ref
                       ,hrr.responsibility_type                                                                                     responsibility_type
                       ,hrr.primary_flag                                                                                            primary_flag
                       ,hrr.attribute_category                                                                                      attribute_category
                       ,hrr.attribute1                                                                                              attribute1
                       ,hrr.attribute2                                                                                              attribute2
                       ,hrr.attribute3                                                                                              attribute3
                       ,hrr.attribute4                                                                                              attribute4
                       ,hrr.attribute5                                                                                              attribute5
                       ,hrr.attribute6                                                                                              attribute6
                       ,hrr.attribute7                                                                                              attribute7
                       ,hrr.attribute8                                                                                              attribute8
                       ,hrr.attribute9                                                                                              attribute9
                       ,hrr.attribute10                                                                                             attribute10
                       ,hrr.attribute11                                                                                             attribute11
                       ,hrr.attribute12                                                                                             attribute12
                       ,hrr.attribute13                                                                                             attribute13
                       ,hrr.attribute14                                                                                             attribute14
                       ,hrr.attribute15                                                                                             attribute15
                       ,NULL                                                                                                        attribute16
                       ,NULL                                                                                                        attribute17
                       ,NULL                                                                                                        attribute18
                       ,NULL                                                                                                        attribute19
                       ,NULL                                                                                                        attribute20
                       ,NULL                                                                                                        attribute21
                       ,NULL                                                                                                        attribute22
                       ,NULL                                                                                                        attribute23
                       ,NULL                                                                                                        attribute24
                       ,NULL                                                                                                        attribute25
                       ,NULL                                                                                                        attribute26
                       ,NULL                                                                                                        attribute27
                       ,NULL                                                                                                        attribute28
                       ,NULL                                                                                                        attribute29
                       ,NULL                                                                                                        attribute30
                       ,NULL                                                                                                        attribute_number1
                       ,NULL                                                                                                        attribute_number2
                       ,NULL                                                                                                        attribute_number3
                       ,NULL                                                                                                        attribute_number4
                       ,NULL                                                                                                        attribute_number5
                       ,NULL                                                                                                        attribute_number6
                       ,NULL                                                                                                        attribute_number7
                       ,NULL                                                                                                        attribute_number8
                       ,NULL                                                                                                        attribute_number9
                       ,NULL                                                                                                        attribute_number10
                       ,NULL                                                                                                        attribute_number11
                       ,NULL                                                                                                        attribute_number12
                       ,NULL                                                                                                        attribute_date1
                       ,NULL                                                                                                        attribute_date2
                       ,NULL                                                                                                        attribute_date3
                       ,NULL                                                                                                        attribute_date4
                       ,NULL                                                                                                        attribute_date5
                       ,NULL                                                                                                        attribute_date6
                       ,NULL                                                                                                        attribute_date7
                       ,NULL                                                                                                        attribute_date8
                       ,NULL                                                                                                        attribute_date9
                       ,NULL                                                                                                        attribute_date10
                       ,NULL                                                                                                        attribute_date11
                       ,NULL                                                                                                        attribute_date12
                       ,selection.party_id                                                                                          party_orig_system_reference
                FROM  (select distinct cust_acct_site_id, account_party_id party_id
                       from XXMX_CUSTOMER_SCOPE_TEMP_STG)                   selection
                     ,apps.hz_org_contacts@MXDM_NVIS_EXTRACT         hoc
                     ,apps.hz_cust_account_roles@MXDM_NVIS_EXTRACT   hcar
                     ,apps.hz_role_responsibility@MXDM_NVIS_EXTRACT  hrr
                     ,apps.hz_parties@MXDM_NVIS_EXTRACT              hp1
                     ,apps.hz_relationships@MXDM_NVIS_EXTRACT        hr
                WHERE hcar.cust_acct_site_id     = selection.cust_acct_site_id
                AND   hrr.cust_account_role_id   = hcar.cust_account_role_id
                AND   hr.subject_id              = hp1.party_id
                AND   hr.object_id               = selection.party_id
                AND   hcar.party_id              = hr.party_id
                AND   hoc.party_relationship_id  = hr.relationship_id
                AND   hp1.status                 = 'A'
                AND   hr.status                  = 'A'
                AND   hcar.status                = 'A'
            ) src;
              --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
          TYPE hz_role_resps_tt IS TABLE OF hz_role_resps_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_role_resps_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_role_resps_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_role_resps_tbl hz_role_resps_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_role_resps_cur;
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH hz_role_resps_cur
                    BULK COLLECT
                    INTO hz_role_resps_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    EXIT WHEN hz_role_resps_tbl.count=0;
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    FORALL i in 1..hz_role_resps_tbl.count
                    insert
                    INTO xxmx_hz_role_resps_stg
                        (
                                  migration_set_id
                                 ,migration_set_name
                                 ,migration_status
                                ,insert_update_code
                                ,insert_update_flag
                                ,cust_contact_orig_system
                                ,cust_contact_orig_sys_ref
                                ,role_resp_orig_system
                                ,role_resp_orig_sys_ref
                                ,responsibility_type
                                ,primary_flag
                                ,attribute_category
                                ,attribute1
                                ,attribute2
                                ,attribute3
                                ,attribute4
                                ,attribute5
                                ,attribute6
                                ,attribute7
                                ,attribute8
                                ,attribute9
                                ,attribute10
                                ,attribute11
                                ,attribute12
                                ,attribute13
                                ,attribute14
                                ,attribute15
                                ,attribute16
                                ,attribute17
                                ,attribute18
                                ,attribute19
                                ,attribute20
                                ,attribute21
                                ,attribute22
                                ,attribute23
                                ,attribute24
                                ,attribute25
                                ,attribute26
                                ,attribute27
                                ,attribute28
                                ,attribute29
                                ,attribute30
                                ,attribute_number1
                                ,attribute_number2
                                ,attribute_number3
                                ,attribute_number4
                                ,attribute_number5
                                ,attribute_number6
                                ,attribute_number7
                                ,attribute_number8
                                ,attribute_number9
                                ,attribute_number10
                                ,attribute_number11
                                ,attribute_number12
                                ,attribute_date1
                                ,attribute_date2
                                ,attribute_date3
                                ,attribute_date4
                                ,attribute_date5
                                ,attribute_date6
                                ,attribute_date7
                                ,attribute_date8
                                ,attribute_date9
                                ,attribute_date10
                                ,attribute_date11
                                ,attribute_date12
                                ,load_request_id
                                ,party_orig_system_reference
                                --,migration_set_name
                                --,creation_date
                                --,created_by
                                --,last_update_date
                                --,last_updated_by
                    )
                    VALUES (
                                  pt_i_MigrationSetID                               --MIGRATION_SET_ID
                                 ,gvt_MigrationSetName                               --migration_set_name
                                 ,'EXTRACTED'                                       --MIGRATION_STATUS
                                 ,hz_role_resps_tbl(i).insert_update_code
                                 ,hz_role_resps_tbl(i).insert_update_flag
                                 ,hz_role_resps_tbl(i).cust_contact_orig_system
                                 ,hz_role_resps_tbl(i).cust_contact_orig_sys_ref
                                 ,hz_role_resps_tbl(i).role_resp_orig_system
                                 ,hz_role_resps_tbl(i).role_resp_orig_sys_ref
                                 ,hz_role_resps_tbl(i).responsibility_type
                                 ,hz_role_resps_tbl(i).primary_flag
                                 ,hz_role_resps_tbl(i).attribute_category
                                 ,hz_role_resps_tbl(i).attribute1
                                 ,hz_role_resps_tbl(i).attribute2
                                 ,hz_role_resps_tbl(i).attribute3
                                 ,hz_role_resps_tbl(i).attribute4
                                 ,hz_role_resps_tbl(i).attribute5
                                 ,hz_role_resps_tbl(i).attribute6
                                 ,hz_role_resps_tbl(i).attribute7
                                 ,hz_role_resps_tbl(i).attribute8
                                 ,hz_role_resps_tbl(i).attribute9
                                 ,hz_role_resps_tbl(i).attribute10
                                 ,hz_role_resps_tbl(i).attribute11
                                 ,hz_role_resps_tbl(i).attribute12
                                 ,hz_role_resps_tbl(i).attribute13
                                 ,hz_role_resps_tbl(i).attribute14
                                 ,hz_role_resps_tbl(i).attribute15
                                 ,hz_role_resps_tbl(i).attribute16
                                 ,hz_role_resps_tbl(i).attribute17
                                 ,hz_role_resps_tbl(i).attribute18
                                 ,hz_role_resps_tbl(i).attribute19
                                 ,hz_role_resps_tbl(i).attribute20
                                 ,hz_role_resps_tbl(i).attribute21
                                 ,hz_role_resps_tbl(i).attribute22
                                 ,hz_role_resps_tbl(i).attribute23
                                 ,hz_role_resps_tbl(i).attribute24
                                 ,hz_role_resps_tbl(i).attribute25
                                 ,hz_role_resps_tbl(i).attribute26
                                 ,hz_role_resps_tbl(i).attribute27
                                 ,hz_role_resps_tbl(i).attribute28
                                 ,hz_role_resps_tbl(i).attribute29
                                 ,hz_role_resps_tbl(i).attribute30
                                 ,hz_role_resps_tbl(i).attribute_number1
                                 ,hz_role_resps_tbl(i).attribute_number2
                                 ,hz_role_resps_tbl(i).attribute_number3
                                 ,hz_role_resps_tbl(i).attribute_number4
                                 ,hz_role_resps_tbl(i).attribute_number5
                                 ,hz_role_resps_tbl(i).attribute_number6
                                 ,hz_role_resps_tbl(i).attribute_number7
                                 ,hz_role_resps_tbl(i).attribute_number8
                                 ,hz_role_resps_tbl(i).attribute_number9
                                 ,hz_role_resps_tbl(i).attribute_number10
                                 ,hz_role_resps_tbl(i).attribute_number11
                                 ,hz_role_resps_tbl(i).attribute_number12
                                 ,hz_role_resps_tbl(i).attribute_date1
                                 ,hz_role_resps_tbl(i).attribute_date2
                                 ,hz_role_resps_tbl(i).attribute_date3
                                 ,hz_role_resps_tbl(i).attribute_date4
                                 ,hz_role_resps_tbl(i).attribute_date5
                                 ,hz_role_resps_tbl(i).attribute_date6
                                 ,hz_role_resps_tbl(i).attribute_date7
                                 ,hz_role_resps_tbl(i).attribute_date8
                                 ,hz_role_resps_tbl(i).attribute_date9
                                 ,hz_role_resps_tbl(i).attribute_date10
                                 ,hz_role_resps_tbl(i).attribute_date11
                                 ,hz_role_resps_tbl(i).attribute_date12
                                 ,hz_role_resps_tbl(i).load_request_id
                                 ,hz_role_resps_tbl(i).party_orig_system_reference
                                 --,hz_role_resps_tbl(i).migration_set_name
                                 --,hz_role_resps_tbl(i).creation_date
                                 --,hz_role_resps_tbl(i).created_by
                                 --,hz_role_resps_tbl(i).last_update_date
                                 --,hz_role_resps_tbl(i).last_updated_by
                            );
                         --
                         --
                    --** END FORALL
                    --
                    --
               END LOOP;
               --
               --
               gvv_ProgressIndicator :='0090';
               --
               --
               COMMIT;
               --
               --
               gvv_ProgressIndicator :='0100';
               --
               --
                CLOSE hz_role_resps_cur;
               --
               --
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
               --
          END IF;
           --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
                --
               WHEN e_ModuleError
               THEN
                    --
                   xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    if hz_role_resps_cur%ISOPEN
                    THEN
                        CLOSE hz_role_resps_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                             ,1
                                             ,4000
                                             );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_role_resps_stg;
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< hz_cust_acct_relate_stg >-----------------
    -- ------------------------------------------------------------------------------
        PROCEDURE hz_cust_acct_relate_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail hz_cust_acct_relate_stg
              --
        cursor hz_cust_acct_relate_cur
              IS
                   WITH selection as (
                           select distinct cust_account_id, account_number,account_party_id
                           from   XXMX_CUSTOMER_SCOPE_TEMP_STG),
                        related as (
                            select distinct cust_account_id, account_number
                            from   XXMX_CUSTOMER_SCOPE_TEMP_STG)
                   SELECT    DISTINCT
                             NULL                                                                          insert_update_code
                            ,gct_OrigSystem                                                                cust_acct_rel_orig_system
                            ,hcara.cust_account_id||hcara.related_cust_account_id                          cust_acct_rel_orig_sys_ref
                            ,gct_OrigSystem                                                                cust_orig_system
                            ,selection.account_number                                                      cust_orig_system_reference
                            ,decode(hcara.related_cust_account_id,null,null,gct_OrigSystem)                related_cust_orig_system
                            ,hcara.related_cust_account_id                                                 related_cust_orig_sys_ref
                            /*,(SELECT account_number
                              FROM   apps.hz_cust_accounts@MXDM_NVIS_EXTRACT
                              WHERE  cust_account_id = hcara.related_cust_account_id )                     related_cust_orig_sys_ref*/
                            ,hcara.relationship_type                                                       relationship_type
                            --,hcara.customer_reciprocal_flag                                              customer_reciprocal_flag
                            ,'Y'                                                                           customer_reciprocal_flag
                            ,NULL                                                                          set_code
                            ,null                                                                          start_date
                            ,NULL                                                                          end_date
                            ,NULL                                                                          attribute_category
                            ,NULL                                                                          attribute1
                            ,NULL                                                                          attribute2
                            ,NULL                                                                          attribute3
                            ,NULL                                                                          attribute4
                            ,NULL                                                                          attribute5
                            ,NULL                                                                          attribute6
                            ,NULL                                                                          attribute7
                            ,NULL                                                                          attribute8
                            ,NULL                                                                          attribute9
                            ,NULL                                                                          attribute10
                            ,NULL                                                                          attribute11
                            ,NULL                                                                          attribute12
                            ,NULL                                                                          attribute13
                            ,NULL                                                                          attribute14
                            ,NULL                                                                          attribute15
                            ,NULL                                                                          attribute16
                            ,NULL                                                                          attribute17
                            ,NULL                                                                          attribute18
                            ,NULL                                                                          attribute19
                            ,NULL                                                                          attribute20
                            ,NULL                                                                          attribute21
                            ,NULL                                                                          attribute22
                            ,NULL                                                                          attribute23
                            ,NULL                                                                          attribute24
                            ,NULL                                                                          attribute25
                            ,NULL                                                                          attribute26
                            ,NULL                                                                          attribute27
                            ,NULL                                                                          attribute28
                            ,NULL                                                                          attribute29
                            ,NULL                                                                          attribute30
                            ,hcara.bill_to_flag                                                            bill_to_flag
                            ,hcara.ship_to_flag                                                            ship_to_flag
                            ,NULL                                                                          load_request_id
                            ,org.name                                                                      ou_name
                            ,selection.Account_Party_Id                                                      party_orig_system_reference
                        FROM selection
                            ,related
                            ,apps.hz_cust_acct_relate_all@MXDM_NVIS_EXTRACT    hcara
                            ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT  org
--                            ,apps.hz_parties@MXDM_NVIS_EXTRACT                 hp2
--                            ,apps.hz_cust_accounts@MXDM_NVIS_EXTRACT           hca2
                        WHERE    1  =  1
                            --AND  hca.cust_account_id  = hcara.cust_account_id
                        AND hcara.related_cust_account_id   = selection.cust_account_id
                        AND hcara.cust_account_id           = related.cust_account_id
--                        AND hca2.cust_account_id            = hcara.cust_account_id
--                        AND hp2.party_id                    = hca2.party_id
                        AND org.organization_id             = hcara.org_id
                        ;
                   --
              --** END CURSOR **
              --
              --********************
              --** Type Declarations
              --********************
              --
          TYPE hz_cust_acct_relate_tt IS TABLE OF hz_cust_acct_relate_cur%ROWTYPE INDEX BY BINARY_INTEGER;
              --
              --************************
              --** Constant Declarations
              --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'hz_cust_acct_relate_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_hz_cust_acct_relate_stg';
              --
              --************************
              --** Variable Declarations
              --************************
              --
              --
              --****************************
              --** Record Table Declarations
              --****************************
              --
              --
              --
              --****************************
              --** PL/SQL Table Declarations
              --****************************
              --

              hz_cust_acct_relate_tbl hz_cust_acct_relate_tt;
              --
              --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
               --
               --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open hz_cust_acct_relate_cur;
               --
               --
               --xxmx_utilities_pkg.out_message(' After OPEN hz_cust_acct_relate_cur');
               --
               --
                              gvv_ProgressIndicator :='0060';
               --
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH hz_cust_acct_relate_cur
                    BULK COLLECT
                    INTO hz_cust_acct_relate_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;

--                xxmx_utilities_pkg.log_module_message
--                    (
--                     pt_i_ApplicationSuite    => gct_ApplicationSuite
--                    ,pt_i_Application         => gct_Application
--                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
--                    ,pt_i_SubEntity           => pt_i_SubEntity
--                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
--                    ,pt_i_Phase               => ct_Phase
--                    ,pt_i_PackageName         => gcv_PackageName
--                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
--                    ,pt_i_Severity            => 'NOTIFICATION'
--                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
--                    ,pt_i_ModuleMessage       => '  - Fetching ' || hz_cust_acct_relate_tbl.count ||
--                                                 ' rows to "'
--                                                 ||ct_StgTable
--                                                 ||'".'
--                    ,pt_i_OracleError         => NULL
--                    );

                    EXIT WHEN hz_cust_acct_relate_tbl.count=0;
                    --
                    gvv_ProgressIndicator :='0080';
                    --
                    FORALL i in 1..hz_cust_acct_relate_tbl.count
                    insert
                    INTO xxmx_hz_cust_acct_relate_stg
                        (
                          migration_set_id
                         ,migration_set_name
                         ,migration_status
                         ,insert_update_code
                         ,cust_acct_rel_orig_system
                         ,cust_acct_rel_orig_sys_ref
                         ,cust_orig_system
                         ,cust_orig_system_reference
                         ,related_cust_orig_system
                         ,related_cust_orig_sys_ref
                         ,relationship_type
                         ,customer_reciprocal_flag
                         ,set_code
                         ,start_date
                         ,end_date
                         ,attribute_category
                         ,attribute1
                         ,attribute2
                         ,attribute3
                         ,attribute4
                         ,attribute5
                         ,attribute6
                         ,attribute7
                         ,attribute8
                         ,attribute9
                         ,attribute10
                         ,attribute11
                         ,attribute12
                         ,attribute13
                         ,attribute14
                         ,attribute15
                         ,attribute16
                         ,attribute17
                         ,attribute18
                         ,attribute19
                         ,attribute20
                         ,attribute21
                         ,attribute22
                         ,attribute23
                         ,attribute24
                         ,attribute25
                         ,attribute26
                         ,attribute27
                         ,attribute28
                         ,attribute29
                         ,attribute30
                         ,bill_to_flag
                         ,ship_to_flag
                         ,load_request_id
                         --,creation_date
                         --,created_by
                         --,last_update_date
                         --,last_updated_by
                         ,ou_name
                         ,party_orig_system_reference
                    )
                    VALUES (
                              pt_i_MigrationSetID                               --MIGRATION_SET_ID
                             ,gvt_MigrationSetName                               --migration_set_name
                             ,'EXTRACTED'                                       --MIGRATION_STATUS
                             ,hz_cust_acct_relate_tbl(i).insert_update_code
                             ,hz_cust_acct_relate_tbl(i).cust_acct_rel_orig_system
                             ,hz_cust_acct_relate_tbl(i).cust_acct_rel_orig_sys_ref
                             ,hz_cust_acct_relate_tbl(i).cust_orig_system
                             ,hz_cust_acct_relate_tbl(i).cust_orig_system_reference
                             ,hz_cust_acct_relate_tbl(i).related_cust_orig_system
                             ,hz_cust_acct_relate_tbl(i).related_cust_orig_sys_ref
                             ,hz_cust_acct_relate_tbl(i).relationship_type
                             ,hz_cust_acct_relate_tbl(i).customer_reciprocal_flag
                             ,hz_cust_acct_relate_tbl(i).set_code
                             ,hz_cust_acct_relate_tbl(i).start_date
                             ,hz_cust_acct_relate_tbl(i).end_date
                             ,hz_cust_acct_relate_tbl(i).attribute_category
                             ,hz_cust_acct_relate_tbl(i).attribute1
                             ,hz_cust_acct_relate_tbl(i).attribute2
                             ,hz_cust_acct_relate_tbl(i).attribute3
                             ,hz_cust_acct_relate_tbl(i).attribute4
                             ,hz_cust_acct_relate_tbl(i).attribute5
                             ,hz_cust_acct_relate_tbl(i).attribute6
                             ,hz_cust_acct_relate_tbl(i).attribute7
                             ,hz_cust_acct_relate_tbl(i).attribute8
                             ,hz_cust_acct_relate_tbl(i).attribute9
                             ,hz_cust_acct_relate_tbl(i).attribute10
                             ,hz_cust_acct_relate_tbl(i).attribute11
                             ,hz_cust_acct_relate_tbl(i).attribute12
                             ,hz_cust_acct_relate_tbl(i).attribute13
                             ,hz_cust_acct_relate_tbl(i).attribute14
                             ,hz_cust_acct_relate_tbl(i).attribute15
                             ,hz_cust_acct_relate_tbl(i).attribute16
                             ,hz_cust_acct_relate_tbl(i).attribute17
                             ,hz_cust_acct_relate_tbl(i).attribute18
                             ,hz_cust_acct_relate_tbl(i).attribute19
                             ,hz_cust_acct_relate_tbl(i).attribute20
                             ,hz_cust_acct_relate_tbl(i).attribute21
                             ,hz_cust_acct_relate_tbl(i).attribute22
                             ,hz_cust_acct_relate_tbl(i).attribute23
                             ,hz_cust_acct_relate_tbl(i).attribute24
                             ,hz_cust_acct_relate_tbl(i).attribute25
                             ,hz_cust_acct_relate_tbl(i).attribute26
                             ,hz_cust_acct_relate_tbl(i).attribute27
                             ,hz_cust_acct_relate_tbl(i).attribute28
                             ,hz_cust_acct_relate_tbl(i).attribute29
                             ,hz_cust_acct_relate_tbl(i).attribute30
                             ,hz_cust_acct_relate_tbl(i).bill_to_flag
                             ,hz_cust_acct_relate_tbl(i).ship_to_flag
                             ,hz_cust_acct_relate_tbl(i).load_request_id
                             --,hz_cust_acct_relate_tbl(i).migration_set_name
                             --,hz_cust_acct_relate_tbl(i).creation_date
                             --,hz_cust_acct_relate_tbl(i).created_by
                             --,hz_cust_acct_relate_tbl(i).last_update_date
                             --,hz_cust_acct_relate_tbl(i).last_updated_by
                             ,hz_cust_acct_relate_tbl(i).ou_name
                             ,hz_cust_acct_relate_tbl(i).party_orig_system_reference
                            );
                         --
                    --** END FORALL
                    --
               END LOOP;
                --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE hz_cust_acct_relate_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
                --
                --check duplicates
                --
               gvv_ProgressIndicator :='0110';
                --
--               DELETE FROM xxmx_hz_cust_acct_relate_stg
--               WHERE rowid not in
--               (SELECT MIN(rowid)
--               FROM xxmx_hz_cust_acct_relate_stg
--               GROUP BY
--                    --MIGRATION_SET_ID,
--                    insert_update_code,
--                    cust_acct_rel_orig_system,
--                    cust_acct_rel_orig_sys_ref,
--                    cust_orig_system,
--                    cust_orig_system_reference,
--                    related_cust_orig_system,
--                    related_cust_orig_sys_ref,
--                    relationship_type,
--                    customer_reciprocal_flag,
--                    set_code,
--                    start_date,
--                    end_date,
--                    attribute_category,
--                    attribute1,
--                    attribute2,
--                    attribute3,
--                    attribute4,
--                    attribute5,
--                    attribute6,
--                    attribute7,
--                    attribute8,
--                    attribute9,
--                    attribute10,
--                    attribute11,
--                    attribute12,
--                    attribute13,
--                    attribute14,
--                    attribute15,
--                    attribute16,
--                    attribute17,
--                    attribute18,
--                    attribute19,
--                    attribute20,
--                    attribute21,
--                    attribute22,
--                    attribute23,
--                    attribute24,
--                    attribute25,
--                    attribute26,
--                    attribute27,
--                    attribute28,
--                    attribute29,
--                    attribute30,
--                    bill_to_flag,
--                    ship_to_flag,
--                    load_request_id,
--                   -- migration_set_name,
--                   -- creation_date,
--                   -- created_by,
--                   -- last_update_date,
--                   -- last_updated_by,
--                    ou_name);
--               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0120';
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application, Business Entity and Sub-Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               xxmx_utilities_pkg.upd_migration_details
                    (
                 pt_i_MigrationSetID          => pt_i_MigrationSetID
                ,pt_i_BusinessEntity          => gcv_BusinessEntity
                ,pt_i_SubEntity               => pt_i_SubEntity
                ,pt_i_Phase                   => ct_Phase
                ,pt_i_ExtractCompletionDate   => SYSDATE
                ,pt_i_ExtractRowCount         => gvn_RowCount
                ,pt_i_TransformTable          => NULL
                ,pt_i_TransformStartDate      => NULL
                ,pt_i_TransformCompletionDate => NULL
                ,pt_i_ExportFileName          => NULL
                ,pt_i_ExportStartDate         => NULL
                ,pt_i_ExportCompletionDate    => NULL
                ,pt_i_ExportRowCount          => NULL
                ,pt_i_ErrorFlag               => NULL
                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    if hz_cust_acct_relate_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_relate_cur;
                    END IF;
                    ROLLBACK;
                    --
                    xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                     --
                    if hz_cust_acct_relate_cur%ISOPEN
                    THEN
                        CLOSE hz_cust_acct_relate_cur;
                    END IF;
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                             ,1
                                             ,4000
                                            );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
        END hz_cust_acct_relate_stg;
        --
        -- ------------------------------------------------------------------------------
        -- ----------------------------------< ra_cust_rcpt_methods_stg >-------------------
        -- ------------------------------------------------------------------------------
        PROCEDURE ra_cust_rcpt_methods_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
        IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail ra_cust_rcpt_methods_stg
              --
        cursor ra_cust_rcpt_methods_cur
              IS
			  SELECT
                             gct_OrigSystem                                              cust_orig_system
                            ,src.cust_orig_system_reference                              cust_orig_system_reference
                            ,src.payment_method_name                                     payment_method_name
                            ,src.primary_flag                                            primary_flag
                            ,decode(src.cust_site_orig_sys_ref,null,null,gct_OrigSystem) cust_site_orig_system
                            ,src.cust_site_orig_sys_ref                                  cust_site_orig_sys_ref
                            ,src.start_date                                              start_date
                            ,src.end_date                                                end_date
                            ,src.attribute_category                                      attribute_category
                            ,src.attribute1                                              attribute1
                            ,src.attribute2                                              attribute2
                            ,src.attribute3                                              attribute3
                            ,src.attribute4                                              attribute4
                            ,src.attribute5                                              attribute5
                            ,src.attribute6                                              attribute6
                            ,src.attribute7                                              attribute7
                            ,src.attribute8                                              attribute8
                            ,src.attribute9                                              attribute9
                            ,src.attribute10                                             attribute10
                            ,src.attribute11                                             attribute11
                            ,src.attribute12                                             attribute12
                            ,src.attribute13                                             attribute13
                            ,src.attribute14                                             attribute14
                            ,src.attribute15                                             attribute15
                            ,src.org_id                                                  org_id
                            ,null                                                        load_request_id
                            ,src.party_orig_system_reference                             party_orig_system_reference
                    FROM    (
/*
 * Removal of customer level receipt methods if Customer has only SITE level data
 *
                     SELECT  NULL                                             cust_orig_system
                           ,selection.account_number                         cust_orig_system_reference
                           ,arm.name                                         payment_method_name
                           ,rcrm.primary_flag                                primary_flag
                           ,NULL                                             cust_site_orig_system
                           ,NULL                                             cust_site_orig_sys_ref
                           ,rcrm.start_date                                  start_date
                           ,rcrm.end_date                                    end_date
                           ,rcrm.attribute_category                          attribute_category
                           ,rcrm.attribute1                                  attribute1
                           ,rcrm.attribute2                                  attribute2
                           ,rcrm.attribute3                                  attribute3
                           ,rcrm.attribute4                                  attribute4
                           ,rcrm.attribute5                                  attribute5
                           ,rcrm.attribute6                                  attribute6
                           ,rcrm.attribute7                                  attribute7
                           ,rcrm.attribute8                                  attribute8
                           ,rcrm.attribute9                                  attribute9
                           ,rcrm.attribute10                                 attribute10
                           ,rcrm.attribute11                                 attribute11
                           ,rcrm.attribute12                                 attribute12
                           ,rcrm.attribute13                                 attribute13
                           ,rcrm.attribute14                                 attribute14
                           ,rcrm.attribute15                                 attribute15
                           ,NULL                                             org_id
                    FROM   (select distinct cust_account_id, account_number
                            from XXMX_CUSTOMER_SCOPE_TEMP_STG)                                 selection
                          ,apps.ra_cust_receipt_methods@MXDM_NVIS_EXTRACT             rcrm
                          ,apps.ar_receipt_methods@MXDM_NVIS_EXTRACT                  arm
                    WHERE  rcrm.customer_id           = selection.cust_account_id
                    AND    rcrm.receipt_method_id     = arm.receipt_method_id
                    AND    rcrm.site_use_id           is NULL
                    AND    (rcrm.end_date is null or rcrm.end_date >= trunc(sysdate))   -- added 12/10/2021 - CLewis / STrahern requested
                    AND    (arm.end_date is null or arm.end_date >= trunc(sysdate))     -- added 12/10/2021 - CLewis / STrahern requested                   
                    UNION
*/
                    SELECT  NULL                                                                                                        cust_orig_system
                           ,selection.account_number                                                                                    cust_orig_system_reference
                           ,arm.name                                                                                                    payment_method_name
                           ,rcrm.primary_flag                                                                                           primary_flag
                           ,NULL                                                                                                        cust_site_orig_system
                           ,selection.cust_account_id||'-'||selection.cust_acct_site_id                                                 cust_site_orig_sys_ref
                           ,rcrm.start_date                                                                                             start_date
                           ,rcrm.end_date                                                                                               end_date
                           --,xxmx_utilities_pkg.gn_MigrationSetID                                                                                                        --MIGRATION_SET_ID
                           ,rcrm.attribute_category                                                                                     attribute_category
                           ,rcrm.attribute1                                                                                             attribute1
                           ,rcrm.attribute2                                                                                             attribute2
                           ,rcrm.attribute3                                                                                             attribute3
                           ,rcrm.attribute4                                                                                             attribute4
                           ,rcrm.attribute5                                                                                             attribute5
                           ,rcrm.attribute6                                                                                             attribute6
                           ,rcrm.attribute7                                                                                             attribute7
                           ,rcrm.attribute8                                                                                             attribute8
                           ,rcrm.attribute9                                                                                             attribute9
                           ,rcrm.attribute10                                                                                            attribute10
                           ,rcrm.attribute11                                                                                            attribute11
                           ,rcrm.attribute12                                                                                            attribute12
                           ,rcrm.attribute13                                                                                            attribute13
                           ,rcrm.attribute14                                                                                            attribute14
                           ,rcrm.attribute15                                                                                            attribute15
                           ,NULL                                                                                                        org_id
                           ,selection.account_party_id                                                                            party_orig_system_reference
                    FROM   (select distinct org_id, party_site_id, cust_account_id, account_number, cust_acct_site_id,account_party_id
                            from XXMX_CUSTOMER_SCOPE_TEMP_STG)                               selection
                          ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT             hcsua
                          ,apps.ra_cust_receipt_methods@MXDM_NVIS_EXTRACT           rcrm
                          ,apps.ar_receipt_methods@MXDM_NVIS_EXTRACT                arm
                    WHERE  hcsua.cust_acct_site_id   = selection.cust_acct_site_id
-- SMBC specific    AND    hcsua.status              = 'A'
                    AND    hcsua.org_id              = selection.org_id
                    AND    rcrm.receipt_method_id    = arm.receipt_method_id
                    AND    rcrm.customer_id          = selection.cust_account_id
                    AND    rcrm.site_use_id          = hcsua.site_use_id
                    AND    (rcrm.end_date is null or rcrm.end_date >= trunc(sysdate))   
                    AND    (arm.end_date is null or arm.end_date >= trunc(sysdate))                 
                    ) src;
              --
              --** END CURSOR **
          --
          --********************
          --** Type Declarations
          --********************
          --
          TYPE ra_cust_rcpt_methods_tt IS TABLE OF ra_cust_rcpt_methods_cur%ROWTYPE INDEX BY BINARY_INTEGER;
          --
          --************************
          --** Constant Declarations
          --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'ra_cust_rcpt_methods_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_ra_cust_rcpt_methods_stg';
          --
          --************************
          --** Variable Declarations
          --************************
          --
          --
          --****************************
          --** Record Table Declarations
          --****************************
          --
          --
          --
          --****************************
          --** PL/SQL Table Declarations
          --****************************
          --
          ra_cust_rcpt_methods_tbl ra_cust_rcpt_methods_tt;
          --
          --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
        --** END Declarations
        --
        --
        BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
           END IF;
           --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
                --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open ra_cust_rcpt_methods_cur;
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH        ra_cust_rcpt_methods_cur
                    BULK COLLECT
                    INTO         ra_cust_rcpt_methods_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    --
                    EXIT WHEN ra_cust_rcpt_methods_tbl.count=0;
                     --
                    gvv_ProgressIndicator :='0070';
                    --
                    FORALL i in 1..ra_cust_rcpt_methods_tbl.count
                    INSERT
                    INTO xxmx_ra_cust_rcpt_methods_stg
                        (
                         migration_set_id
                         ,migration_set_name
                         ,migration_status
                        ,cust_orig_system
                        ,cust_orig_system_reference
                        ,payment_method_name
                        ,primary_flag
                        ,cust_site_orig_system
                        ,cust_site_orig_sys_ref
                        ,start_date
                        ,end_date
                        ,attribute_category
                        ,attribute1
                        ,attribute2
                        ,attribute3
                        ,attribute4
                        ,attribute5
                        ,attribute6
                        ,attribute7
                        ,attribute8
                        ,attribute9
                        ,attribute10
                        ,attribute11
                        ,attribute12
                        ,attribute13
                        ,attribute14
                        ,attribute15
                        ,org_id
                        ,load_request_id
                        ,party_orig_system_reference
                        --,creation_date
                        --,created_by
                        --,last_update_date
                        --,last_updated_by
                    )
                    VALUES (
                              pt_i_MigrationSetID                               --MIGRATION_SET_ID
                             ,gvt_MigrationSetName                               --migration_set_name
                             ,'EXTRACTED'                                       --MIGRATION_STATUS
                             ,ra_cust_rcpt_methods_tbl(i).cust_orig_system
                             ,ra_cust_rcpt_methods_tbl(i).cust_orig_system_reference
                             ,ra_cust_rcpt_methods_tbl(i).payment_method_name
                             ,ra_cust_rcpt_methods_tbl(i).primary_flag
                             ,ra_cust_rcpt_methods_tbl(i).cust_site_orig_system
                             ,ra_cust_rcpt_methods_tbl(i).cust_site_orig_sys_ref
                             ,ra_cust_rcpt_methods_tbl(i).start_date
                             ,ra_cust_rcpt_methods_tbl(i).end_date
                             --,ra_cust_rcpt_methods_tbl(i).MIGRATION_SET_ID
                             ,ra_cust_rcpt_methods_tbl(i).attribute_category
                             ,ra_cust_rcpt_methods_tbl(i).attribute1
                             ,ra_cust_rcpt_methods_tbl(i).attribute2
                             ,ra_cust_rcpt_methods_tbl(i).attribute3
                             ,ra_cust_rcpt_methods_tbl(i).attribute4
                             ,ra_cust_rcpt_methods_tbl(i).attribute5
                             ,ra_cust_rcpt_methods_tbl(i).attribute6
                             ,ra_cust_rcpt_methods_tbl(i).attribute7
                             ,ra_cust_rcpt_methods_tbl(i).attribute8
                             ,ra_cust_rcpt_methods_tbl(i).attribute9
                             ,ra_cust_rcpt_methods_tbl(i).attribute10
                             ,ra_cust_rcpt_methods_tbl(i).attribute11
                             ,ra_cust_rcpt_methods_tbl(i).attribute12
                             ,ra_cust_rcpt_methods_tbl(i).attribute13
                             ,ra_cust_rcpt_methods_tbl(i).attribute14
                             ,ra_cust_rcpt_methods_tbl(i).attribute15
                             ,ra_cust_rcpt_methods_tbl(i).org_id
                             ,ra_cust_rcpt_methods_tbl(i).load_request_id
                             ,ra_cust_rcpt_methods_tbl(i).party_orig_system_reference
                             --,ra_cust_rcpt_methods_tbl(i).creation_date
                             --,ra_cust_rcpt_methods_tbl(i).created_by
                             --,ra_cust_rcpt_methods_tbl(i).last_update_date
                             --,ra_cust_rcpt_methods_tbl(i).last_updated_by
                           );
                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE ra_cust_rcpt_methods_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
               --
          END IF;
         --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
        --
        EXCEPTION
            --
            WHEN e_ModuleError
            THEN
                --
                if ra_cust_rcpt_methods_cur%ISOPEN
                THEN
                    CLOSE ra_cust_rcpt_methods_cur;
                END IF;
                ROLLBACK;
                --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => gvt_Severity
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => gvt_ModuleMessage
                    ,pt_i_OracleError         => NULL
                    );
                --
                 RAISE;
                --
                --
            --** END e_ModuleError Exception
            --
            WHEN OTHERS
            THEN
                --
                if ra_cust_rcpt_methods_cur%ISOPEN
                THEN
                    CLOSE ra_cust_rcpt_methods_cur;
                END IF;
                ROLLBACK;
                 --
                gvt_OracleError := SUBSTR(
                                          SQLERRM
                                          ||'** ERROR_BACKTRACE: '
                                          ||dbms_utility.format_error_backtrace
                                         ,1
                                         ,4000
                                         );
                --
                --
                xxmx_utilities_pkg.log_module_message
                     (
                      pt_i_ApplicationSuite    => gct_ApplicationSuite
                     ,pt_i_Application         => gct_Application
                     ,pt_i_BusinessEntity      => gcv_BusinessEntity
                     ,pt_i_SubEntity           => pt_i_SubEntity
                     ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                     ,pt_i_Phase               => ct_Phase
                     ,pt_i_PackageName         => gcv_PackageName
                     ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                     ,pt_i_Severity            => 'ERROR'
                     ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                     ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                     ,pt_i_OracleError         => gvt_OracleError
                     );
                --
                RAISE;
                --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
          --
        END ra_cust_rcpt_methods_stg;
         --
    --
    -- ------------------------------------------------------------------------------
    -- ----------------------------------< ar_cust_banks_stg >-----------------------
    -- ------------------------------------------------------------------------------
    --
        PROCEDURE ar_cust_banks_stg
                        (
                         pt_i_MigrationSetID   IN      xxmx_migration_headers.migration_set_id%TYPE
                        ,pt_i_SubEntity        IN      xxmx_migration_metadata.sub_entity%TYPE
                        )
         IS
              --
              --
              --**********************
              --** CURSOR Declarations
              --**********************
              --
              -- Cursor to get the detail ar_cust_banks_stg
              --
        cursor ar_cust_banks_cur
        IS
        select  gct_OrigSystem                                           cust_orig_system
               ,src.cust_orig_system_reference                           cust_orig_system_reference
               ,decode(src.cust_site_orig_sys_ref,null,null,gct_OrigSystem) cust_site_orig_system
               ,src.cust_site_orig_sys_ref                               cust_site_orig_sys_ref
               ,src.bank_account_name                                    bank_account_name
               ,src.primary_flag                                         primary_flag
               ,src.start_date                                           start_date
               ,src.end_date                                             end_date
               ,src.attribute_category                                   attribute_category
               ,src.attribute1                                           attribute1
               ,src.attribute2                                           attribute2
               ,src.attribute3                                           attribute3
               ,src.attribute4                                           attribute4
               ,src.attribute5                                           attribute5
               ,src.attribute6                                           attribute6
               ,src.attribute7                                           attribute7
               ,src.attribute8                                           attribute8
               ,src.attribute9                                           attribute9
               ,src.attribute10                                          attribute10
               ,src.attribute11                                          attribute11
               ,src.attribute12                                          attribute12
               ,src.attribute13                                          attribute13
               ,src.attribute14                                          attribute14
               ,src.attribute15                                          attribute15
               ,src.bank_account_num                                     bank_account_num
               ,src.bank_account_currency_code                           bank_account_currency_code
               ,src.bank_account_inactive_date                           bank_account_inactive_date
               ,src.bank_account_description                             bank_account_description
               ,src.bank_name                                            bank_name
               ,src.bank_branch_name                                     bank_branch_name
               ,src.bank_branch_number                                   bank_branch_number
               ,src.bank_branch_description                              bank_branch_description
               ,src.bank_branch_address1                                 bank_branch_address1
               ,src.bank_branch_address2                                 bank_branch_address2
               ,src.bank_branch_address3                                 bank_branch_address3
               ,src.bank_branch_city                                     bank_branch_city
               ,src.bank_branch_state                                    bank_branch_state
               ,src.bank_branch_zip                                      bank_branch_zip
               ,src.bank_branch_province                                 bank_branch_province
               ,src.bank_branch_country                                  bank_branch_country
               ,src.bank_branch_area_code                                bank_branch_area_code
               ,src.bank_branch_phone                                    bank_branch_phone
               ,src.bank_account_att_category                            bank_account_att_category
               ,src.bank_account_attribute1                              bank_account_attribute1
               ,src.bank_account_attribute10                             bank_account_attribute10
               ,src.bank_account_attribute11                             bank_account_attribute11
               ,src.bank_account_attribute12                             bank_account_attribute12
               ,src.bank_account_attribute13                             bank_account_attribute13
               ,src.bank_account_attribute14                             bank_account_attribute14
               ,src.bank_account_attribute15                             bank_account_attribute15
               ,src.bank_account_attribute2                              bank_account_attribute2
               ,src.bank_account_attribute3                              bank_account_attribute3
               ,src.bank_account_attribute4                              bank_account_attribute4
               ,src.bank_account_attribute5                              bank_account_attribute5
               ,src.bank_account_attribute6                              bank_account_attribute6
               ,src.bank_account_attribute7                              bank_account_attribute7
               ,src.bank_account_attribute8                              bank_account_attribute8
               ,src.bank_account_attribute9                              bank_account_attribute9
               ,src.bank_branch_att_category                             bank_branch_att_category
               ,src.bank_branch_attribute1                               bank_branch_attribute1
               ,src.bank_branch_attribute10                              bank_branch_attribute10
               ,src.bank_branch_attribute11                              bank_branch_attribute11
               ,src.bank_branch_attribute12                              bank_branch_attribute12
               ,src.bank_branch_attribute13                              bank_branch_attribute13
               ,src.bank_branch_attribute14                              bank_branch_attribute14
               ,src.bank_branch_attribute15                              bank_branch_attribute15
               ,src.bank_branch_attribute2                               bank_branch_attribute2
               ,src.bank_branch_attribute3                               bank_branch_attribute3
               ,src.bank_branch_attribute4                               bank_branch_attribute4
               ,src.bank_branch_attribute5                               bank_branch_attribute5
               ,src.bank_branch_attribute6                               bank_branch_attribute6
               ,src.bank_branch_attribute7                               bank_branch_attribute7
               ,src.bank_branch_attribute8                               bank_branch_attribute8
               ,src.bank_branch_attribute9                               bank_branch_attribute9
               ,src.bank_number                                          bank_number
               ,src.bank_branch_address4                                 bank_branch_address4
               ,src.bank_branch_county                                   bank_branch_county
               ,src.bank_branch_eft_user_number                          bank_branch_eft_user_number
               ,src.bank_account_check_digits                            bank_account_check_digits
               ,src.global_attribute_category                            global_attribute_category
               ,src.global_attribute1                                    global_attribute1
               ,src.global_attribute2                                    global_attribute2
               ,src.global_attribute3                                    global_attribute3
               ,src.global_attribute4                                    global_attribute4
               ,src.global_attribute5                                    global_attribute5
               ,src.global_attribute6                                    global_attribute6
               ,src.global_attribute7                                    global_attribute7
               ,src.global_attribute8                                    global_attribute8
               ,src.global_attribute9                                    global_attribute9
               ,src.global_attribute10                                   global_attribute10
               ,src.global_attribute11                                   global_attribute11
               ,src.global_attribute12                                   global_attribute12
               ,src.global_attribute13                                   global_attribute13
               ,src.global_attribute14                                   global_attribute14
               ,src.global_attribute15                                   global_attribute15
               ,src.global_attribute16                                   global_attribute16
               ,src.global_attribute17                                   global_attribute17
               ,src.global_attribute18                                   global_attribute18
               ,src.global_attribute19                                   global_attribute19
               ,src.global_attribute20                                   global_attribute20
               ,src.org_id                                               org_id
               ,src.bank_home_country                                    bank_home_country
               ,src.localinstr                                           localinstr
               ,src.service_level                                        service_level
               ,src.purpose_code                                         purpose_code
               ,src.bank_charge_bearer_code                              bank_charge_bearer_code
               ,src.debit_advice_delivery_method                         debit_advice_delivery_method
--               ,case when src.debit_advice_email is not null then
--                nvl(fin_utilities_pkg.gc_default_email, src.debit_advice_email)
--                end                                                      debit_advice_email
               ,src.debit_advice_fax                                     debit_advice_fax
               ,src.eft_swift_code                                       eft_swift_code
               ,src.country_code                                         country_code
               ,src.foreign_payment_use_flag                             foreign_payment_use_flag
               ,src.primary_acct_owner_flag                              primary_acct_owner_flag
               ,src.bank_account_name_alt                                bank_account_name_alt
               ,src.bank_account_type                                    bank_account_type
               ,src.account_suffix                                       account_suffix
               ,src.agency_location_code                                 agency_location_code
               ,src.iban                                                 iban
               ,null                                                     load_request_id
               ,src.party_orig_system_reference                                             party_orig_system_reference
        from
        (
            select  distinct null                                                                cust_orig_system
                   ,hca.account_number                                                  cust_orig_system_reference
                   ,null                                                                cust_site_orig_system
                   ,null                                                                cust_site_orig_sys_ref
                   ,nvl(iebav.bank_account_name, iebav.primary_acct_owner_name)         bank_account_name
                   ,decode(ipiua.order_of_preference, 1, 'Y', 'N')                      primary_flag
                   ,nvl(ipiua.start_date, sysdate)                                      start_date
                   ,ipiua.end_date                                                      end_date
                   ,ieba.attribute_category                                             attribute_category
                   ,ieba.attribute1                                                     attribute1
                   ,ieba.attribute2                                                     attribute2
                   ,ieba.attribute3                                                     attribute3
                   ,ieba.attribute4                                                     attribute4
                   ,ieba.attribute5                                                     attribute5
                   ,ieba.attribute6                                                     attribute6
                   ,ieba.attribute7                                                     attribute7
                   ,ieba.attribute8                                                     attribute8
                   ,ieba.attribute9                                                     attribute9
                   ,ieba.attribute10                                                    attribute10
                   ,ieba.attribute11                                                    attribute11
                   ,ieba.attribute12                                                    attribute12
                   ,ieba.attribute13                                                    attribute13
                   ,ieba.attribute14                                                    attribute14
                   ,ieba.attribute15                                                    attribute15
                   ,ieba.bank_account_num                                               bank_account_num
                   ,ieba.currency_code                                                  bank_account_currency_code
                   ,ieba.end_date                                                       bank_account_inactive_date
                   ,ieba.description                                                    bank_account_description
                   ,ieb.bank_name                                                       bank_name
                   ,iebb.bank_branch_name                                               bank_branch_name
                   ,iebb.branch_number                                                  bank_branch_number
                   ,iebb.description                                                    bank_branch_description
                   ,iebb.address_line1                                                  bank_branch_address1
                   ,iebb.address_line2                                                  bank_branch_address2
                   ,iebb.address_line3                                                  bank_branch_address3
                   ,iebb.city                                                           bank_branch_city
                   ,iebb.state                                                          bank_branch_state
                   ,iebb.zip                                                            bank_branch_zip
                   ,iebb.province                                                       bank_branch_province
                   ,iebb.country                                                        bank_branch_country
                   ,null                                                                bank_branch_area_code
                   ,null                                                                bank_branch_phone
                   ,ieba.attribute_category                                             bank_account_att_category
                   ,ieba.attribute1                                                     bank_account_attribute1
                   ,ieba.attribute10                                                    bank_account_attribute10
                   ,ieba.attribute11                                                    bank_account_attribute11
                   ,ieba.attribute12                                                    bank_account_attribute12
                   ,ieba.attribute13                                                    bank_account_attribute13
                   ,ieba.attribute14                                                    bank_account_attribute14
                   ,ieba.attribute15                                                    bank_account_attribute15
                   ,ieba.attribute2                                                     bank_account_attribute2
                   ,ieba.attribute3                                                     bank_account_attribute3
                   ,ieba.attribute4                                                     bank_account_attribute4
                   ,ieba.attribute5                                                     bank_account_attribute5
                   ,ieba.attribute6                                                     bank_account_attribute6
                   ,ieba.attribute7                                                     bank_account_attribute7
                   ,ieba.attribute8                                                     bank_account_attribute8
                   ,ieba.attribute9                                                     bank_account_attribute9
                   ,null                                                                bank_branch_att_category
                   ,null                                                                bank_branch_attribute1
                   ,null                                                                bank_branch_attribute10
                   ,null                                                                bank_branch_attribute11
                   ,null                                                                bank_branch_attribute12
                   ,null                                                                bank_branch_attribute13
                   ,null                                                                bank_branch_attribute14
                   ,null                                                                bank_branch_attribute15
                   ,null                                                                bank_branch_attribute2
                   ,null                                                                bank_branch_attribute3
                   ,null                                                                bank_branch_attribute4
                   ,null                                                                bank_branch_attribute5
                   ,null                                                                bank_branch_attribute6
                   ,null                                                                bank_branch_attribute7
                   ,null                                                                bank_branch_attribute8
                   ,null                                                                bank_branch_attribute9
                   ,ieb.bank_number                                                     bank_number
                   ,iebb.address_line4                                                  bank_branch_address4
                   ,iebb.country                                                        bank_branch_county
                   ,iebb.eft_user_number                                                bank_branch_eft_user_number
                   ,ieba.check_digits                                                   bank_account_check_digits
                   ,null                                                                global_attribute_category
                   ,null                                                                global_attribute1
                   ,null                                                                global_attribute2
                   ,null                                                                global_attribute3
                   ,null                                                                global_attribute4
                   ,null                                                                global_attribute5
                   ,null                                                                global_attribute6
                   ,null                                                                global_attribute7
                   ,null                                                                global_attribute8
                   ,null                                                                global_attribute9
                   ,null                                                                global_attribute10
                   ,null                                                                global_attribute11
                   ,null                                                                global_attribute12
                   ,null                                                                global_attribute13
                   ,null                                                                global_attribute14
                   ,null                                                                global_attribute15
                   ,null                                                                global_attribute16
                   ,null                                                                global_attribute17
                   ,null                                                                global_attribute18
                   ,null                                                                global_attribute19
                   ,null                                                                global_attribute20
                   ,null /*fin_utilities_pkg.gc_default_org_id */                       org_id
                   ,ieb.home_country                                                    bank_home_country
                   ,null                                                                localinstr
                   ,null                                                                service_level
                   ,null                                                                purpose_code
                   ,null                                                                bank_charge_bearer_code
                   ,null                                                                debit_advice_delivery_method
                   ,null                                                                debit_advice_email
                   ,null                                                                debit_advice_fax
                   ,iebb.eft_swift_code                                                 eft_swift_code
                   ,ieba.country_code                                                   country_code
                   ,ieba.foreign_payment_use_flag                                       foreign_payment_use_flag
                   ,nvl(iao.primary_flag, 'N')                                          primary_acct_owner_flag
                   ,ieba.bank_account_name_alt                                          bank_account_name_alt
                   ,ieba.bank_account_type                                              bank_account_type
                   ,ieba.account_suffix                                                 account_suffix
                   ,ieba.agency_location_code                                           agency_location_code
                   ,ieba.iban                                                           iban
                  ,selection.party_id                                             party_orig_system_reference
            from  (select distinct
                          account_party_id party_id
                         ,cust_account_id 
                   from XXMX_CUSTOMER_SCOPE_TEMP_STG)               selection
                   ,apps.hz_cust_accounts@MXDM_NVIS_EXTRACT          hca
                  ,apps.hz_customer_profiles@MXDM_NVIS_EXTRACT      hcp
                  ,apps.hz_cust_profile_classes@MXDM_NVIS_EXTRACT   hcpc
                  ,apps.iby_external_payers_all@MXDM_NVIS_EXTRACT   iepa
                  ,apps.iby_pmt_instr_uses_all@MXDM_NVIS_EXTRACT    ipiua
                  ,apps.iby_account_owners@MXDM_NVIS_EXTRACT        iao
                  ,apps.iby_ext_bank_accounts@MXDM_NVIS_EXTRACT     ieba
                  ,apps.iby_ext_bank_accounts_v@MXDM_NVIS_EXTRACT   iebav
                  ,apps.iby_ext_banks_v@MXDM_NVIS_EXTRACT           ieb
                  ,apps.iby_ext_bank_branches_v@MXDM_NVIS_EXTRACT   iebb
            where  selection.cust_account_id = hca.cust_account_id
            and    selection.party_id        = iepa.party_id
            and    hca.cust_account_id       = iepa.cust_account_id
            and    iepa.acct_site_use_id    is null
            and    hca.cust_account_id       = hcp.cust_account_id
            and    hcp.site_use_id          is null
            and    hcp.profile_class_id      = hcpc.profile_class_id
            and    iepa.ext_payer_id         = ipiua.ext_pmt_party_id
            and    ipiua.instrument_id       = ieba.ext_bank_account_id
            and    ipiua.instrument_type     = 'BANKACCOUNT'
            and    iepa.party_id             = iao.account_owner_party_id
            and    ieba.ext_bank_account_id  = iao.ext_bank_account_id
            and    iebav.ext_bank_account_id = ieba.ext_bank_account_id
            and    ieba.bank_id              = ieb.bank_party_id
            and    ieba.branch_id            = iebb.branch_party_id
            and nvl(ipiua.end_date,sysdate+1) >= trunc(sysdate)  -- added 12/10/2021 - C Lewis/S Travhern request
            and nvl(iao.end_date,sysdate+1) >= trunc(sysdate)    -- added 12/10/2021 - C Lewis/S Travhern request            
            and nvl(ieba.end_date,sysdate+1) >= trunc(sysdate)   -- added 12/10/2021 - C Lewis/S Travhern request             
            union
            select  distinct null                                                                cust_orig_system
                   ,hca.account_number                                                  cust_orig_system_reference
                   ,null                                                                cust_site_orig_system
                   ,selection.cust_account_id||'-'||selection.cust_acct_site_id         cust_site_orig_sys_ref
                   ,nvl(iebav.bank_account_name, iebav.primary_acct_owner_name)         bank_account_name
                   ,decode(ipiua.order_of_preference, 1, 'Y', 'N')                      primary_flag
                   ,nvl(ipiua.start_date, sysdate)                                      start_date
                   ,ipiua.end_date                                                      end_date
                   ,ieba.attribute_category                                             attribute_category
                   ,ieba.attribute1                                                     attribute1
                   ,ieba.attribute2                                                     attribute2
                   ,ieba.attribute3                                                     attribute3
                   ,ieba.attribute4                                                     attribute4
                   ,ieba.attribute5                                                     attribute5
                   ,ieba.attribute6                                                     attribute6
                   ,ieba.attribute7                                                     attribute7
                   ,ieba.attribute8                                                     attribute8
                   ,ieba.attribute9                                                     attribute9
                   ,ieba.attribute10                                                    attribute10
                   ,ieba.attribute11                                                    attribute11
                   ,ieba.attribute12                                                    attribute12
                   ,ieba.attribute13                                                    attribute13
                   ,ieba.attribute14                                                    attribute14
                   ,ieba.attribute15                                                    attribute15
                   ,ieba.bank_account_num                                               bank_account_num
                   ,ieba.currency_code                                                  bank_account_currency_code
                   ,ieba.end_date                                                       bank_account_inactive_date
                   ,ieba.description                                                    bank_account_description
                   ,ieb.bank_name                                                       bank_name
                   ,iebb.bank_branch_name                                               bank_branch_name
                   ,iebb.branch_number                                                  bank_branch_number
                   ,iebb.description                                                    bank_branch_description
                   ,iebb.address_line1                                                  bank_branch_address1
                   ,iebb.address_line2                                                  bank_branch_address2
                   ,iebb.address_line3                                                  bank_branch_address3
                   ,iebb.city                                                           bank_branch_city
                   ,iebb.state                                                          bank_branch_state
                   ,iebb.zip                                                            bank_branch_zip
                   ,iebb.province                                                       bank_branch_province
                   ,iebb.country                                                        bank_branch_country
                   ,null                                                                bank_branch_area_code
                   ,null                                                                bank_branch_phone
                   ,ieba.attribute_category                                             bank_account_att_category
                   ,ieba.attribute1                                                     bank_account_attribute1
                   ,ieba.attribute10                                                    bank_account_attribute10
                   ,ieba.attribute11                                                    bank_account_attribute11
                   ,ieba.attribute12                                                    bank_account_attribute12
                   ,ieba.attribute13                                                    bank_account_attribute13
                   ,ieba.attribute14                                                    bank_account_attribute14
                   ,ieba.attribute15                                                    bank_account_attribute15
                   ,ieba.attribute2                                                     bank_account_attribute2
                   ,ieba.attribute3                                                     bank_account_attribute3
                   ,ieba.attribute4                                                     bank_account_attribute4
                   ,ieba.attribute5                                                     bank_account_attribute5
                   ,ieba.attribute6                                                     bank_account_attribute6
                   ,ieba.attribute7                                                     bank_account_attribute7
                   ,ieba.attribute8                                                     bank_account_attribute8
                   ,ieba.attribute9                                                     bank_account_attribute9
                   ,null                                                                bank_branch_att_category
                   ,null                                                                bank_branch_attribute1
                   ,null                                                                bank_branch_attribute10
                   ,null                                                                bank_branch_attribute11
                   ,null                                                                bank_branch_attribute12
                   ,null                                                                bank_branch_attribute13
                   ,null                                                                bank_branch_attribute14
                   ,null                                                                bank_branch_attribute15
                   ,null                                                                bank_branch_attribute2
                   ,null                                                                bank_branch_attribute3
                   ,null                                                                bank_branch_attribute4
                   ,null                                                                bank_branch_attribute5
                   ,null                                                                bank_branch_attribute6
                   ,null                                                                bank_branch_attribute7
                   ,null                                                                bank_branch_attribute8
                   ,null                                                                bank_branch_attribute9
                   ,ieb.bank_number                                                     bank_number
                   ,iebb.address_line4                                                  bank_branch_address4
                   ,iebb.country                                                        bank_branch_county
                   ,iebb.eft_user_number                                                bank_branch_eft_user_number
                   ,ieba.check_digits                                                   bank_account_check_digits
                   ,null                                                                global_attribute_category
                   ,null                                                                global_attribute1
                   ,null                                                                global_attribute2
                   ,null                                                                global_attribute3
                   ,null                                                                global_attribute4
                   ,null                                                                global_attribute5
                   ,null                                                                global_attribute6
                   ,null                                                                global_attribute7
                   ,null                                                                global_attribute8
                   ,null                                                                global_attribute9
                   ,null                                                                global_attribute10
                   ,null                                                                global_attribute11
                   ,null                                                                global_attribute12
                   ,null                                                                global_attribute13
                   ,null                                                                global_attribute14
                   ,null                                                                global_attribute15
                   ,null                                                                global_attribute16
                   ,null                                                                global_attribute17
                   ,null                                                                global_attribute18
                   ,null                                                                global_attribute19
                   ,null                                                                global_attribute20
                   ,null /*fin_utilities_pkg.gc_default_org_id*/                        org_id
                   ,ieb.home_country                                                    bank_home_country
                   ,null                                                                localinstr
                   ,null                                                                service_level
                   ,null                                                                purpose_code
                   ,null                                                                bank_charge_bearer_code
                   ,null                                                                debit_advice_delivery_method
                   ,null                                                                debit_advice_email
                   ,null                                                                debit_advice_fax
                   ,iebb.eft_swift_code                                                 eft_swift_code
                   ,ieba.country_code                                                   country_code
                   ,ieba.foreign_payment_use_flag                                       foreign_payment_use_flag
                   ,nvl(iao.primary_flag, 'N')                                          primary_acct_owner_flag
                   ,ieba.bank_account_name_alt                                          bank_account_name_alt
                   ,ieba.bank_account_type                                              bank_account_type
                   ,ieba.account_suffix                                                 account_suffix
                   ,ieba.agency_location_code                                           agency_location_code
                   ,ieba.iban                                                           iban
                  ,selection.party_id                                             party_orig_system_reference
            from  (select distinct
                       account_party_id party_id
                          ,party_site_id
                         ,cust_account_id
                         ,cust_acct_site_id
                         ,org_id
                   from XXMX_CUSTOMER_SCOPE_TEMP_STG)               selection
                  ,apps.hz_cust_accounts@MXDM_NVIS_EXTRACT          hca
                  ,apps.hz_cust_acct_sites_all@MXDM_NVIS_EXTRACT    hcasa
                  ,apps.hz_cust_site_uses_all@MXDM_NVIS_EXTRACT     hcsua
                  ,apps.iby_external_payers_all@MXDM_NVIS_EXTRACT   iepa
                  ,apps.iby_pmt_instr_uses_all@MXDM_NVIS_EXTRACT    ipiua
                  ,apps.iby_account_owners@MXDM_NVIS_EXTRACT        iao
                  ,apps.iby_ext_bank_accounts@MXDM_NVIS_EXTRACT     ieba
                  ,apps.iby_ext_bank_accounts_v@MXDM_NVIS_EXTRACT   iebav
                  ,apps.iby_ext_banks_v@MXDM_NVIS_EXTRACT           ieb
                  ,apps.iby_ext_bank_branches_v@MXDM_NVIS_EXTRACT   iebb
                  ,apps.hr_all_organization_units@MXDM_NVIS_EXTRACT haou
            where  1=1
            and    hca.cust_account_id         = iepa.cust_account_id
            and    selection.cust_account_id   = hca.cust_account_id
            and    hcasa.cust_account_id       = hca.cust_account_id
            and    selection.org_id            = hcasa.org_id
            and    selection.cust_acct_site_id = hcasa.cust_acct_site_id
            and    hcsua.cust_acct_site_id     = hcasa.cust_acct_site_id
            and    hcsua.org_id                = hcasa.org_id
            and    hcsua.site_use_id           = iepa.acct_site_use_id             -- Added to stop banks migrating with inactive Bill To sites
            --and    hcsua.site_use_code     NOT IN ('BOL','ACK','INV','DRAWEE')     -- 
            and    hcsua.status = 'A'
            and    iepa.ext_payer_id           = ipiua.ext_pmt_party_id
            and    ipiua.instrument_id         = ieba.ext_bank_account_id
            and    ipiua.instrument_type       = 'BANKACCOUNT'
            and    iepa.party_id               = iao.account_owner_party_id
            and    ieba.ext_bank_account_id    = iao.ext_bank_account_id
            and    iebav.ext_bank_account_id   = ieba.ext_bank_account_id
            and    ieba.bank_id                = ieb.bank_party_id
            and    ieba.branch_id              = iebb.branch_party_id
            and    haou.organization_id        = hcasa.org_id
            and nvl(ipiua.end_date,sysdate+1) >= trunc(sysdate)  -- added 12/10/2021 - C Lewis/S Travhern request
            and nvl(iao.end_date,sysdate+1) >= trunc(sysdate)    -- added 12/10/2021 - C Lewis/S Travhern request            
            and nvl(ieba.end_date,sysdate+1) >= trunc(sysdate)   -- added 12/10/2021 - C Lewis/S Travhern request             
        ) src;
              --
              --** END CURSOR **
          --
          --********************
          --** Type Declarations
          --********************
          --
          TYPE ar_cust_banks_tt IS TABLE OF ar_cust_banks_cur%ROWTYPE INDEX BY BINARY_INTEGER;
          --
          --************************
          --** Constant Declarations
          --************************
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'ar_cust_banks_stg';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          ct_StgTable                     CONSTANT  xxmx_migration_metadata.stg_table%TYPE          := 'xxmx_ar_cust_banks_stg';
          --
          --************************
          --** Variable Declarations
          --************************
          --
          --
          --****************************
          --** Record Table Declarations
          --****************************
          --
          --
          --
          --****************************
          --** PL/SQL Table Declarations
          --****************************
          --
          ar_cust_banks_tbl ar_cust_banks_tt;
          --
          --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator :='0010';
          --
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /*
          ** Delete any MODULE messages from previous executions
          ** for the Business Entity and Business Entity Level
          */
          --
          --** ISV 21/10/2020 - Modified all Utilities Package Procedure/Function Calls to pass new "gcv_BusinessEntity" global constant
          --**                  to the "pt_i_BusinessEntity" parameter.
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
           END IF;
           --
          gvv_ProgressIndicator :='0020';
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          /** Delete any DATA messages from previous executions
          ** for the Business Entity and Business Entity Level.
          **
          ** There should not be any DATA messages issued from
          ** within Extract procedures so this is here as an
          ** example that can be copied into Transform/enrichment
          ** procedures as those procedures SHOULD be issuing
          ** data messages as part of any validation they perform.
          */
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => NULL                 -- This is NULL so messages for all previous runs are deleted.
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'DATA'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator :='0030';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** Retrieve the Migration Set Name
          --
          gvv_ProgressIndicator :='0040';
          --
          --
          gvt_MigrationSetName := xxmx_utilities_pkg.get_migration_set_name(pt_i_MigrationSetID);
          --
          --
          --** If the Migration Set Name is NULL then the Migration has not been initialized.
          --
          IF   gvt_MigrationSetName IS NOT NULL
          THEN
               --
               gvv_ProgressIndicator := '0050';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Extracting "'
                                                 ||pt_i_SubEntity
                                                 ||'":'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --
               --** The Migration Set has been initialized so now initialize the detail record
               --** for the current entity.
               --
               --** ISV 21/10/2020 - Removed Sequence Number parameters as the procedure will now determine the correct values from the metadata
               --**                  table based on the Application Suite, Application and Business Entity parameters.
               --**
               --**                  Removed "entity" from procedure_name.
               --
               --** DSF 30/10/2020 - "pt_i_StagingTable" no longer needs to be passed as a parameter from the STG_MAIN procedure
               --**                  as the table name will never change so replace with new constant "ct_StgTable".
               --
               --**                  We will still keep the table name in the Metadata table as that can be used for reporting
               --**                  purposes.
               --
               xxmx_utilities_pkg.init_migration_details
                    (
                     pt_i_ApplicationSuite       => gct_ApplicationSuite
                    ,pt_i_Application            => gct_Application
                    ,pt_i_BusinessEntity         => gcv_BusinessEntity
                    ,pt_i_SubEntity              => pt_i_SubEntity
                    ,pt_i_MigrationSetID         => pt_i_MigrationSetID
                    ,pt_i_StagingTable           => ct_StgTable
                    ,pt_i_ExtractStartDate       => SYSDATE
                    );
               --
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Staging Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details initialised.'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_ProgressIndicator :='0060';
                --
               --** Extract the AR Customer and insert into the staging table.
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extracting data into "'
                                                 ||ct_StgTable
                                                 ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** ISV 21/10/2020 - The staging table is in the xxmx_stg schema but should not need to be prefixed as there should
               --**                  by a Synonym in the xxmx_core schema to that table.
               --
               open ar_cust_banks_cur;
               --
               LOOP
                    --
                    gvv_ProgressIndicator := '0070';
                    --
                    FETCH        ar_cust_banks_cur
                    BULK COLLECT
                    INTO         ar_cust_banks_tbl
                    LIMIT        xxmx_utilities_pkg.gcn_BulkCollectLimit;
                    --
--                    xxmx_utilities_pkg.log_module_message
--                    (
--                     pt_i_ApplicationSuite    => gct_ApplicationSuite
--                    ,pt_i_Application         => gct_Application
--                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
--                    ,pt_i_SubEntity           => pt_i_SubEntity
--                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
--                    ,pt_i_Phase               => ct_Phase
--                    ,pt_i_PackageName         => gcv_PackageName
--                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
--                    ,pt_i_Severity            => 'NOTIFICATION'
--                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
--                    ,pt_i_ModuleMessage       => '  - Fetching ' || ar_cust_banks_tbl.count ||
--                                                 ' rows to "'
--                                                 ||ct_StgTable
--                                                 ||'".'
--                    ,pt_i_OracleError         => NULL
--                    );
                    EXIT WHEN ar_cust_banks_tbl.count=0;
                     --
                    gvv_ProgressIndicator :='0070';
                    --
                    FORALL i in 1..ar_cust_banks_tbl.count
                    INSERT
                    INTO xxmx_ar_cust_banks_stg
                           (
                             migration_set_id
                            ,migration_set_name
                            ,migration_status
                            ,cust_orig_system
                            ,cust_orig_system_reference
                            ,cust_site_orig_system
                            ,cust_site_orig_sys_ref
                            ,bank_account_name
                            ,primary_flag
                            ,start_date
                            ,end_date
                            ,attribute_category
                            ,attribute1
                            ,attribute2
                            ,attribute3
                            ,attribute4
                            ,attribute5
                            ,attribute6
                            ,attribute7
                            ,attribute8
                            ,attribute9
                            ,attribute10
                            ,attribute11
                            ,attribute12
                            ,attribute13
                            ,attribute14
                            ,attribute15
                            ,bank_account_num
                            ,bank_account_currency_code
                            ,bank_account_inactive_date
                            ,bank_account_description
                            ,bank_name
                            ,bank_branch_name
                            ,bank_num
                            ,bank_branch_description
                            ,bank_branch_address1
                            ,bank_branch_address2
                            ,bank_branch_address3
                            ,bank_branch_city
                            ,bank_branch_state
                            ,bank_branch_zip
                            ,bank_branch_province
                            ,bank_branch_country
                            ,bank_branch_area_code
                            ,bank_branch_phone
                            ,bank_account_att_category
                            ,bank_account_attribute1
                            ,bank_account_attribute10
                            ,bank_account_attribute11
                            ,bank_account_attribute12
                            ,bank_account_attribute13
                            ,bank_account_attribute14
                            ,bank_account_attribute15
                            ,bank_account_attribute2
                            ,bank_account_attribute3
                            ,bank_account_attribute4
                            ,bank_account_attribute5
                            ,bank_account_attribute6
                            ,bank_account_attribute7
                            ,bank_account_attribute8
                            ,bank_account_attribute9
                            ,bank_branch_att_category
                            ,bank_branch_attribute1
                            ,bank_branch_attribute10
                            ,bank_branch_attribute11
                            ,bank_branch_attribute12
                            ,bank_branch_attribute13
                            ,bank_branch_attribute14
                            ,bank_branch_attribute15
                            ,bank_branch_attribute2
                            ,bank_branch_attribute3
                            ,bank_branch_attribute4
                            ,bank_branch_attribute5
                            ,bank_branch_attribute6
                            ,bank_branch_attribute7
                            ,bank_branch_attribute8
                            ,bank_branch_attribute9
                            ,bank_number
                            ,bank_branch_address4
                            ,bank_branch_county
                            ,bank_branch_eft_user_number
                            ,bank_account_check_digits
                            ,global_attribute_category
                            ,global_attribute1
                            ,global_attribute2
                            ,global_attribute3
                            ,global_attribute4
                            ,global_attribute5
                            ,global_attribute6
                            ,global_attribute7
                            ,global_attribute8
                            ,global_attribute9
                            ,global_attribute10
                            ,global_attribute11
                            ,global_attribute12
                            ,global_attribute13
                            ,global_attribute14
                            ,global_attribute15
                            ,global_attribute16
                            ,global_attribute17
                            ,global_attribute18
                            ,global_attribute19
                            ,global_attribute20
                            ,org_id
                            ,bank_home_country
                            ,localinstr
                            ,service_level
                            ,purpose_code
                            ,bank_charge_bearer_code
                            ,debit_advice_delivery_method
--                            ,debit_advice_email
                            ,debit_advice_fax
                            ,eft_swift_code
                            ,country_code
                            ,foreign_payment_use_flag
                            ,primary_acct_owner_flag
                            ,bank_account_name_alt
                            ,bank_account_type
                            ,account_suffix
                            ,agency_location_code
                            ,iban
                            ,load_request_id
                            ,party_orig_system_reference
                          --,creation_date
                          --,created_by
                          --,last_update_date
                          --,last_updated_by
                          ) values (
                             pt_i_MigrationSetID                               --MIGRATION_SET_ID
                            ,gvt_MigrationSetName                               --migration_set_name
                            ,'EXTRACTED'                                       --MIGRATION_STATUS
                            ,ar_cust_banks_tbl(i).cust_orig_system
                            ,ar_cust_banks_tbl(i).cust_orig_system_reference
                            ,ar_cust_banks_tbl(i).cust_site_orig_system
                            ,ar_cust_banks_tbl(i).cust_site_orig_sys_ref
                            ,ar_cust_banks_tbl(i).bank_account_name
                            ,ar_cust_banks_tbl(i).primary_flag
                            ,ar_cust_banks_tbl(i).start_date
                            ,ar_cust_banks_tbl(i).end_date
                            ,ar_cust_banks_tbl(i).attribute_category
                            ,ar_cust_banks_tbl(i).attribute1
                            ,ar_cust_banks_tbl(i).attribute2
                            ,ar_cust_banks_tbl(i).attribute3
                            ,ar_cust_banks_tbl(i).attribute4
                            ,ar_cust_banks_tbl(i).attribute5
                            ,ar_cust_banks_tbl(i).attribute6
                            ,ar_cust_banks_tbl(i).attribute7
                            ,ar_cust_banks_tbl(i).attribute8
                            ,ar_cust_banks_tbl(i).attribute9
                            ,ar_cust_banks_tbl(i).attribute10
                            ,ar_cust_banks_tbl(i).attribute11
                            ,ar_cust_banks_tbl(i).attribute12
                            ,ar_cust_banks_tbl(i).attribute13
                            ,ar_cust_banks_tbl(i).attribute14
                            ,ar_cust_banks_tbl(i).attribute15
                            ,ar_cust_banks_tbl(i).bank_account_num
                            ,ar_cust_banks_tbl(i).bank_account_currency_code
                            ,ar_cust_banks_tbl(i).bank_account_inactive_date
                            ,ar_cust_banks_tbl(i).bank_account_description
                            ,ar_cust_banks_tbl(i).bank_name
                            ,ar_cust_banks_tbl(i).bank_branch_name
                            ,ar_cust_banks_tbl(i).bank_branch_number
                            ,ar_cust_banks_tbl(i).bank_branch_description
                            ,ar_cust_banks_tbl(i).bank_branch_address1
                            ,ar_cust_banks_tbl(i).bank_branch_address2
                            ,ar_cust_banks_tbl(i).bank_branch_address3
                            ,ar_cust_banks_tbl(i).bank_branch_city
                            ,ar_cust_banks_tbl(i).bank_branch_state
                            ,ar_cust_banks_tbl(i).bank_branch_zip
                            ,ar_cust_banks_tbl(i).bank_branch_province
                            ,ar_cust_banks_tbl(i).bank_branch_country
                            ,ar_cust_banks_tbl(i).bank_branch_area_code
                            ,ar_cust_banks_tbl(i).bank_branch_phone
                            ,ar_cust_banks_tbl(i).bank_account_att_category
                            ,ar_cust_banks_tbl(i).bank_account_attribute1
                            ,ar_cust_banks_tbl(i).bank_account_attribute10
                            ,ar_cust_banks_tbl(i).bank_account_attribute11
                            ,ar_cust_banks_tbl(i).bank_account_attribute12
                            ,ar_cust_banks_tbl(i).bank_account_attribute13
                            ,ar_cust_banks_tbl(i).bank_account_attribute14
                            ,ar_cust_banks_tbl(i).bank_account_attribute15
                            ,ar_cust_banks_tbl(i).bank_account_attribute2
                            ,ar_cust_banks_tbl(i).bank_account_attribute3
                            ,ar_cust_banks_tbl(i).bank_account_attribute4
                            ,ar_cust_banks_tbl(i).bank_account_attribute5
                            ,ar_cust_banks_tbl(i).bank_account_attribute6
                            ,ar_cust_banks_tbl(i).bank_account_attribute7
                            ,ar_cust_banks_tbl(i).bank_account_attribute8
                            ,ar_cust_banks_tbl(i).bank_account_attribute9
                            ,ar_cust_banks_tbl(i).bank_branch_att_category
                            ,ar_cust_banks_tbl(i).bank_branch_attribute1
                            ,ar_cust_banks_tbl(i).bank_branch_attribute10
                            ,ar_cust_banks_tbl(i).bank_branch_attribute11
                            ,ar_cust_banks_tbl(i).bank_branch_attribute12
                            ,ar_cust_banks_tbl(i).bank_branch_attribute13
                            ,ar_cust_banks_tbl(i).bank_branch_attribute14
                            ,ar_cust_banks_tbl(i).bank_branch_attribute15
                            ,ar_cust_banks_tbl(i).bank_branch_attribute2
                            ,ar_cust_banks_tbl(i).bank_branch_attribute3
                            ,ar_cust_banks_tbl(i).bank_branch_attribute4
                            ,ar_cust_banks_tbl(i).bank_branch_attribute5
                            ,ar_cust_banks_tbl(i).bank_branch_attribute6
                            ,ar_cust_banks_tbl(i).bank_branch_attribute7
                            ,ar_cust_banks_tbl(i).bank_branch_attribute8
                            ,ar_cust_banks_tbl(i).bank_branch_attribute9
                            ,ar_cust_banks_tbl(i).bank_number
                            ,ar_cust_banks_tbl(i).bank_branch_address4
                            ,ar_cust_banks_tbl(i).bank_branch_county
                            ,ar_cust_banks_tbl(i).bank_branch_eft_user_number
                            ,ar_cust_banks_tbl(i).bank_account_check_digits
                            ,ar_cust_banks_tbl(i).global_attribute_category
                            ,ar_cust_banks_tbl(i).global_attribute1
                            ,ar_cust_banks_tbl(i).global_attribute2
                            ,ar_cust_banks_tbl(i).global_attribute3
                            ,ar_cust_banks_tbl(i).global_attribute4
                            ,ar_cust_banks_tbl(i).global_attribute5
                            ,ar_cust_banks_tbl(i).global_attribute6
                            ,ar_cust_banks_tbl(i).global_attribute7
                            ,ar_cust_banks_tbl(i).global_attribute8
                            ,ar_cust_banks_tbl(i).global_attribute9
                            ,ar_cust_banks_tbl(i).global_attribute10
                            ,ar_cust_banks_tbl(i).global_attribute11
                            ,ar_cust_banks_tbl(i).global_attribute12
                            ,ar_cust_banks_tbl(i).global_attribute13
                            ,ar_cust_banks_tbl(i).global_attribute14
                            ,ar_cust_banks_tbl(i).global_attribute15
                            ,ar_cust_banks_tbl(i).global_attribute16
                            ,ar_cust_banks_tbl(i).global_attribute17
                            ,ar_cust_banks_tbl(i).global_attribute18
                            ,ar_cust_banks_tbl(i).global_attribute19
                            ,ar_cust_banks_tbl(i).global_attribute20
                            ,ar_cust_banks_tbl(i).org_id
                            ,ar_cust_banks_tbl(i).bank_home_country
                            ,ar_cust_banks_tbl(i).localinstr
                            ,ar_cust_banks_tbl(i).service_level
                            ,ar_cust_banks_tbl(i).purpose_code
                            ,ar_cust_banks_tbl(i).bank_charge_bearer_code
                            ,ar_cust_banks_tbl(i).debit_advice_delivery_method
--                            ,ar_cust_banks_tbl(i).debit_advice_email
                            ,ar_cust_banks_tbl(i).debit_advice_fax
                            ,ar_cust_banks_tbl(i).eft_swift_code
                            ,ar_cust_banks_tbl(i).country_code
                            ,ar_cust_banks_tbl(i).foreign_payment_use_flag
                            ,ar_cust_banks_tbl(i).primary_acct_owner_flag
                            ,ar_cust_banks_tbl(i).bank_account_name_alt
                            ,ar_cust_banks_tbl(i).bank_account_type
                            ,ar_cust_banks_tbl(i).account_suffix
                            ,ar_cust_banks_tbl(i).agency_location_code
                            ,ar_cust_banks_tbl(i).iban
                            ,ar_cust_banks_tbl(i).load_request_id
                            ,ar_cust_banks_tbl(i).party_orig_system_reference
                          );                         --
                    --** END FORALL
                    --
               END LOOP;
               --
               gvv_ProgressIndicator :='0090';
               --
               COMMIT;
               --
               gvv_ProgressIndicator :='0100';
               --
                CLOSE ar_cust_banks_cur;
               --
               /*
               ** Obtain the count of rows inserted.  We cannot use SQL$ROWCOUNT here because of the LIMIT
               ** clause on the BULK COLLECT statement.  The rowcount will be reset each time the limit
               ** is reached.
               */
               --
               --
               --** ISV 21/10/2020 - Replace "pt_i_ClientSchemaName" (no longer passed into the extract procedures) with new constant "gct_StgSchema".
               --**                  Replace "pt_i_StagingTable" (no longer passed into the extract procedures) with new constant "ct_StgTable"
               --
               gvn_RowCount := xxmx_utilities_pkg.get_row_count
                                    (
                                     gct_StgSchema
                                    ,ct_StgTable
                                    ,pt_i_MigrationSetID
                                    );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Extraction complete. ' || gvn_RowCount || ' rows inserted'
                    ,pt_i_OracleError         => NULL
                    );
               --
               --** Update the migration details (Migration status will be automatically determined
               --** in the called procedure dependant on the Phase and if an Error Message has been
               --** passed).
               --
               gvv_ProgressIndicator :='0110';
               --
                   xxmx_utilities_pkg.upd_migration_details
                        (
                     pt_i_MigrationSetID          => pt_i_MigrationSetID
                    ,pt_i_BusinessEntity          => gcv_BusinessEntity
                    ,pt_i_SubEntity               => pt_i_SubEntity
                    ,pt_i_Phase                   => ct_Phase
                    ,pt_i_ExtractCompletionDate   => SYSDATE
                    ,pt_i_ExtractRowCount         => gvn_RowCount
                    ,pt_i_TransformTable          => NULL
                    ,pt_i_TransformStartDate      => NULL
                    ,pt_i_TransformCompletionDate => NULL
                    ,pt_i_ExportFileName          => NULL
                    ,pt_i_ExportStartDate         => NULL
                    ,pt_i_ExportCompletionDate    => NULL
                    ,pt_i_ExportRowCount          => NULL
                    ,pt_i_ErrorFlag               => NULL
                        );
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => pt_i_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Migration Table "'
                                                 ||ct_StgTable
                                                 ||'" reporting details updated.'
                    ,pt_i_OracleError         => NULL
                    );
               --
          ELSE
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- Migration Set not initialized.';
               --
               RAISE e_ModuleError;
               --
          END IF;
         --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => pt_i_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
           EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    if ar_cust_banks_cur%ISOPEN
                    THEN
                        CLOSE ar_cust_banks_cur;
                    END IF;
                    ROLLBACK;
                    --
                   xxmx_utilities_pkg.log_module_message
                        (
                         pt_i_ApplicationSuite    => gct_ApplicationSuite
                        ,pt_i_Application         => gct_Application
                        ,pt_i_BusinessEntity      => gcv_BusinessEntity
                        ,pt_i_SubEntity           => pt_i_SubEntity
                        ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                        ,pt_i_Phase               => ct_Phase
                        ,pt_i_PackageName         => gcv_PackageName
                        ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                        ,pt_i_Severity            => gvt_Severity
                        ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                        ,pt_i_ModuleMessage       => gvt_ModuleMessage
                        ,pt_i_OracleError         => NULL
                        );
                    --
                     RAISE;
                    --
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    if ar_cust_banks_cur%ISOPEN
                    THEN
                        CLOSE ar_cust_banks_cur;
                    END IF;
                    ROLLBACK;
                     --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                             ,1
                                             ,4000
                                             );
                    --
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => pt_i_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted at after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
          --
     END ar_cust_banks_stg;
         --
         --
     --**********************
     --** PROCEDURE: stg_main
     --**********************
     --
     --** DSF 26/10/2020 - Removed Business Entity Parameter as it is now a global constant for the package as this will never change.
     --
     PROCEDURE stg_main
                    (
                     pt_i_ClientCode                 IN      xxmx_client_config_parameters.client_code%TYPE
                    ,pt_i_MigrationSetName           IN      xxmx_migration_headers.migration_set_name%TYPE
                    )
     IS
          --
          --**********************
          --** Cursor Declarations
          --**********************
          --
          CURSOR StagingMetadata_cur
                      (
                       pt_ApplicationSuite             xxmx_migration_metadata.application_suite%TYPE
                      ,pt_Application                  xxmx_migration_metadata.application%TYPE
                      ,pt_BusinessEntity               xxmx_migration_metadata.business_entity%TYPE
                      )
          IS
               --
               --
               SELECT  xmm.sub_entity_seq
                      ,xmm.sub_entity
                      ,xmm.entity_package_name
                      ,xmm.stg_procedure_name
                      ,xmm.stg_table
               FROM    xxmx_migration_metadata  xmm
               WHERE   1 = 1
               AND     xmm.application_suite = pt_ApplicationSuite
               AND     xmm.application       = pt_Application
               AND     xmm.business_entity   = pt_BusinessEntity
               ORDER BY xmm.sub_entity_seq;
               --
               --
          --** END CURSOR StagingMetadata_cur
          --
          --**********************
          --** Record Declarations
          --**********************
          --
          --
          --************************
          --** Constant Declarations
          --************************
          --
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'stg_main';
          ct_SubEntity                    CONSTANT  xxmx_module_messages.sub_entity%TYPE            := 'ALL';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'EXTRACT';
          --
          --************************
          --** Variable Declarations
          --************************
          --
          vt_ConfigParameter              xxmx_client_config_parameters.config_parameter%TYPE;
          vt_MigrationSetID               xxmx_migration_headers.migration_set_id%TYPE;
          --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
     --** END Declarations **
     --
     BEGIN
          --
          gvv_ProgressIndicator := '0010';
          --
          IF   pt_i_ClientCode       IS NULL
          OR   pt_i_MigrationSetName IS NULL
          THEN
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- "pt_i_ClientCode" and "pt_i_MigrationSetName" parameters are mandatory.';
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ReturnStatus  := '';
           --
          --** ISV 21/10/2020 - Commented out for now as not sure this would remove messages written by other extracts.
          --/*
          /*
          ** Clear Core Module Messages
          */
          --
          --gvv_ReturnStatus  := '';
          ----
          --xxmx_utilities_pkg.clear_messages
          --     (
          --      pt_i_ApplicationSuite => 'XXMX'
          --     ,pt_i_Application      => 'XXMX'
          --     ,pt_i_BusinessEntity   => 'CORE_REPORTING'
          --     ,pt_i_SubEntity        => NULL
          --     ,pt_i_Phase            => 'CORE'
          --     ,pt_i_MessageType      => 'MODULE'
          --     ,pv_o_ReturnStatus     => gvv_ReturnStatus
          --     );
          ----
          --IF   gvv_ReturnStatus = 'F'
          --THEN
          --     --
          --     xxmx_utilities_pkg.log_module_message
          --          (
          --           pt_i_ApplicationSuite  => gct_ApplicationSuite
          --          ,pt_i_Application       => gct_Application
          --          ,pt_i_BusinessEntity    => gcv_BusinessEntity
          --          ,pt_i_SubEntity         => ct_SubEntity
          --          ,pt_i_MigrationSetID    => pt_i_MigrationSetID
          --          ,pt_i_Phase             => ct_Phase
          --          ,pt_i_Severity          => 'ERROR'
          --          ,pt_i_PackageName       => gcv_PackageName
          --          ,pt_i_ProcOrFuncName    => cv_ProcOrFuncName
          --          ,pt_i_ProgressIndicator => gvv_ProgressIndicator
          --          ,pt_i_ModuleMessage     => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
          --          ,pt_i_OracleError       => gvt_ReturnMessage
          --          );
          --     --
          --     RAISE e_ModuleError;
          --     --
          --END IF;

          --
          /*
          ** Clear Customers Module Messages
          */
          --
          gvv_ReturnStatus  := '';
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => ct_SubEntity
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_Severity            => 'ERROR'
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator := '0020';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** ISV 21/10/2020 - Removed Client Schema Name config parameter as schema names will always be "xxmx_stg", "xxmx_xfm" and 
          --/*
          --** Retrieve the Client Config Parameters needed to call subsequent procedures.
          --*/
          ----
          --gvv_ProgressIndicator := '0030';
          --
          --vt_ConfigParameter := 'CLIENT_SCHEMA_NAME';
          ----
          --vt_ClientSchemaName := xxmx_utilities_pkg.get_client_config_value
          --                            (
          --                             pt_i_ClientCode      => pt_i_ClientCode
          --                            ,pt_i_ConfigParameter => vt_ConfigParameter
          --                            );
          ----
          --IF   vt_ClientSchemaName IS NULL
          --THEN
          --     --
          --     --
          --     gvt_Severity      := 'ERROR';
          --     --
          --     gvt_ModuleMessage := '- Client configuration parameter "'
          --                        ||vt_ConfigParameter
          --                        ||'" does not exist in "xxmx_client_config_parameters" table.';
          --     --
          --     RAISE e_ModuleError;
          --     --
          --     --
          --END IF;
          ----
          --xxmx_utilities_pkg.log_module_message
          --     (
          --      pt_i_ApplicationSuite    => gct_ApplicationSuite
          --     ,pt_i_Application         => gct_Application
          --     ,pt_i_BusinessEntity      => gcv_BusinessEntity
          --     ,pt_i_SubEntity => ct_SubEntity
          --     ,pt_i_Phase               => ct_Phase
          --     ,pt_i_Severity            => 'NOTIFICATION'
          --     ,pt_i_PackageName         => gcv_PackageName
          --     ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
          --     ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
          --     ,pt_i_ModuleMessage       => '- '
          --                                ||pt_i_ClientCode
          --                                ||' Client Config Parameter "'
          --                                ||vt_ConfigParameter
          --                                ||'" = '
          --                                ||vt_ClientSchemaName
          --     ,pt_i_OracleError         => NULL
          --     );
          --
          /*
          ** Initialize the Migration Set for the Business Entity retrieving
          ** a new Migration Set ID.
          */
          --
          --** ISV 21/10/2020 - Removed Sequence Number Parameters as "init_migration_set" procedure will determine these
          --                    from the metadata table based on Application Suite, Application and Business Entity parameters.
          --
          gvv_ProgressIndicator := '0040';
          --
          xxmx_utilities_pkg.init_migration_set
               (
                pt_i_ApplicationSuite  => gct_ApplicationSuite
               ,pt_i_Application       => gct_Application
               ,pt_i_BusinessEntity    => gcv_BusinessEntity
               ,pt_i_MigrationSetName  => pt_i_MigrationSetName
               ,pt_o_MigrationSetID    => vt_MigrationSetID
               );
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => vt_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => '- Migration Set "'
                                          ||pt_i_MigrationSetName
                                          ||'" initialized (Generated Migration Set ID = '
                                          ||vt_MigrationSetID
                                          ||').  Processing extracts:'
               ,pt_i_OracleError         => NULL
               );
          --
          -- First for performance reasons create a Temp table to hold details
          -- of all the sites we are to extract data for
          --
   /*      delete from XXMX_CUSTOMER_SCOPE_TEMP_STG;
          --
          INSERT
          INTO   XXMX_CUSTOMER_SCOPE_TEMP_STG
                      (
                       org_id
                      ,cust_account_id
                      ,account_number
                      ,account_party_id
                      ,hca_status
                      ,cust_acct_site_id
                      ,hcasa_status
                      ,party_site_id
                      ,site_party_id
                      ,location_id
                      )
          SELECT       org_id
                      ,cust_account_id
                      ,account_number
                      ,account_party_id
                      ,account_status
                      ,cust_acct_site_id
                      ,cust_acct_site_status
                      ,party_site_id
                      ,site_party_id
                      ,location_id
          FROM          xxmx_customer_scope_v;*/
          --
          xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => ct_SubEntity
                    ,pt_i_MigrationSetID      => vt_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => SQL%ROWCOUNT || ' entries added to Customer Scope Temp Staging'
                    ,pt_i_OracleError         => gvt_ReturnMessage
                    );
          /*
          ** Loop through the Migration Metadata table to retrieve
          ** the Staging Package Name, Procedure Name and table name
          ** for each extract requied for the current Business Entity.
          */
          --
          gvv_ProgressIndicator := '0050';
          --
          FOR  StagingMetadata_rec
          IN   StagingMetadata_cur
                    (
                     gct_ApplicationSuite
                    ,gct_Application
                    ,gcv_BusinessEntity
                    )
          LOOP
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => ct_SubEntity
                    ,pt_i_MigrationSetID      => vt_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '- Calling Procedure "'
                                               ||StagingMetadata_rec.entity_package_name
                                               ||'.'
                                               ||StagingMetadata_rec.stg_procedure_name
                                               ||'".'
                    ,pt_i_OracleError         => NULL
                    );
               --
               gvv_SQLStatement := 'BEGIN '
                                 ||StagingMetadata_rec.entity_package_name
                                 ||'.'
                                 ||StagingMetadata_rec.stg_procedure_name
                                 ||gcv_SQLSpace
                                 ||'(pt_i_MigrationSetID          => '
                                 ||vt_MigrationSetID
                                 ||',pt_i_SubEntity     => '''
                                 ||StagingMetadata_rec.sub_entity||''''
                                 ||'); END;';
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => ct_SubEntity
                    ,pt_i_MigrationSetID      => vt_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => SUBSTR(
                                                        '- Generated SQL Statement: '
                                                      ||gvv_SQLStatement
                                                       ,1
                                                       ,4000
                                                       )
                    ,pt_i_OracleError         => NULL
                    );
               --
               EXECUTE IMMEDIATE gvv_SQLStatement;
               --
          END LOOP;
          --
          gvv_ProgressIndicator := '0060';
          --
          --xxmx_utilities_pkg.close_extract_phase
          --     (
          --      vt_MigrationSetID
          --     );
          --
          COMMIT;
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => vt_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
         --
         gvv_ProgressIndicator :='0070';
         --
         --** DH  16/04/2021 - call custom package for any customisations to be processed.
         --
           xxmx_utilities_pkg.log_module_message
          (
              pt_i_ApplicationSuite    => gct_ApplicationSuite
             ,pt_i_Application         => gct_Application
             ,pt_i_BusinessEntity      => gcv_BusinessEntity
             ,pt_i_SubEntity           => ct_SubEntity
             ,pt_i_MigrationSetID      => vt_MigrationSetID
             ,pt_i_Phase               => ct_Phase
             ,pt_i_PackageName         => gcv_PackageName
             ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
             ,pt_i_Severity            => 'NOTIFICATION'
             ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
             ,pt_i_ModuleMessage       => 'Calling procedure "'
                                          ||'xxmx_ar_customes_cm_pkg'
                                          ||'.'
                                          ||'upd_customer_dffs_stg'
                                          ||'".'
             ,pt_i_OracleError       => NULL
          );
          --
          --
          --xxmx_ar_customers_cm_pkg.customers_cm_stg(vt_MigrationSetID);
          --
          --
          COMMIT;
          --
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => vt_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => 'xxmx_ar_customes_cm_pkg'
               ,pt_i_ProcOrFuncName      => 'upd_customer_dffs_stg'
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||'xxmx_ar_customes_cm_pkg'
                                            ||'.'
                                            ||'upd_customer_dffs_stg'
                                            ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => ct_SubEntity
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_Severity            => gvt_Severity
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => gvt_ModuleMessage
                         ,pt_i_OracleError         => NULL
                         );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                             ,1
                                             ,4000
                                             );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity => ct_SubEntity
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
     END stg_main;
     --
     --
     --*******************
     --** PROCEDURE: purge
     --*******************
     --
     PROCEDURE purge
                    (
                     pt_i_ClientCode                 IN      xxmx_client_config_parameters.client_code%TYPE
                    ,pt_i_MigrationSetID             IN      xxmx_migration_headers.migration_set_id%TYPE
                    )
     IS
          --
          --
          --**********************
          --** Cursor Declarations
          --**********************
          --
          CURSOR PurgingMetadata_cur
                      (
                       pt_ApplicationSuite             xxmx_migration_metadata.application_suite%TYPE
                      ,pt_Application                  xxmx_migration_metadata.application%TYPE
                      ,pt_BusinessEntity               xxmx_migration_metadata.business_entity%TYPE
                      )
          IS
               --
               --
               SELECT  xmm.stg_table
                      ,xmm.xfm_table
               FROM    xxmx_migration_metadata  xmm
               WHERE   1 = 1
               AND     xmm.application_suite = pt_ApplicationSuite
               AND     xmm.application       = pt_Application
               AND     xmm.business_entity   = pt_BusinessEntity
               ORDER BY xmm.sub_entity_seq;
               --
               --
          --** END CURSOR PurgingMetadata_cur
           --
          --**********************
          --** Record Declarations
          --**********************
          --
          --
          --************************
          --** Constant Declarations
          --************************
          --
          cv_ProcOrFuncName               CONSTANT  VARCHAR2(30)                                    := 'purge';
          ct_SubEntity                    CONSTANT  xxmx_module_messages.sub_entity%TYPE            := 'ALL';
          ct_Phase                        CONSTANT  xxmx_module_messages.phase%TYPE                 := 'CORE';
          --
          --************************
          --** Variable Declarations
          --************************
          --
          vt_ConfigParameter              xxmx_client_config_parameters.config_parameter%TYPE;
          --vt_ClientSchemaName             xxmx_client_config_parameters.config_value%TYPE;
          vv_PurgeTableName               VARCHAR2(30);
          --
          --*************************
          --** Exception Declarations
          --*************************
          --
          --** Set gvt_Severity, gvv_ProgressIndicator and gvt_ModuleMessage
          --** before raising this exception.
          --
          e_ModuleError                   EXCEPTION;
          --
          --
     --** END Declarations **
     --
     --
     BEGIN
          --
          gvv_ProgressIndicator := '0010';
          --
          IF   pt_i_ClientCode     IS NULL
          OR   pt_i_MigrationSetID IS NULL
          THEN
               --
               gvt_Severity      := 'ERROR';
               gvt_ModuleMessage := '- "pt_i_ClientCode" and "pt_i_MigrationSetName" parameters are mandatory.';
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ReturnStatus  := '';
          gvt_ReturnMessage := '';
          --
          xxmx_utilities_pkg.clear_messages
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_Phase               => ct_Phase
               ,pt_i_MessageType         => 'MODULE'
               ,pv_o_ReturnStatus        => gvv_ReturnStatus
               );
          --
          IF   gvv_ReturnStatus = 'F'
          THEN
               --
               gvt_Severity      := 'ERROR';
               --
               gvt_ModuleMessage := '- Oracle error in called procedure "xxmx_utilities_pkg.clear_messages".';
               --
               RAISE e_ModuleError;
               --
          END IF;
          --
          gvv_ProgressIndicator := '0020';
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                            ||gcv_PackageName
                                            ||'.'
                                            ||cv_ProcOrFuncName
                                            ||'" initiated.'
               ,pt_i_OracleError         => NULL
               );
          --
          --
          --** ISV 21/10/2020 - Removed Client Schema Name config parameter as schema names will always be "xxmx_stg", "xxmx_xfm" and 
          --/*
          --** Retrieve the Client Config Parameters needed to call subsequent procedures.
          --*/
          ----
          --gvv_ProgressIndicator := '0030';
          --
          --vt_ConfigParameter := 'CLIENT_SCHEMA_NAME';
          ----
          --vt_ClientSchemaName := xxmx_utilities_pkg.get_client_config_value
          --                            (
          --                             pt_i_ClientCode      => pt_i_ClientCode
          --                            ,pt_i_ConfigParameter => vt_ConfigParameter
          --                            );
          ----
          --IF   vt_ClientSchemaName IS NULL
          --THEN
          --     --
          --     --
          --     gvt_Severity      := 'ERROR';
          --     --
          --     gvt_ModuleMessage := '- Client configuration parameter "'
          --                        ||vt_ConfigParameter
          --                        ||'" does not exist in "xxmx_client_config_parameters" table.';
          --     --
          --     RAISE e_ModuleError;
          --     --
          --     --
          --END IF;
          ----
          --xxmx_utilities_pkg.log_module_message
          --     (
          --      pt_i_ApplicationSuite    => gct_ApplicationSuite
          --     ,pt_i_Application         => gct_Application
          --     ,pt_i_BusinessEntity      => gcv_BusinessEntity
          --     ,pt_i_SubEntity           => ct_SubEntity
          --     ,pt_i_MigrationSetID      => pt_i_MigrationSetID
          --     ,pt_i_Phase               => ct_Phase
          --     ,pt_i_Severity            => 'NOTIFICATION'
          --     ,pt_i_PackageName         => gcv_PackageName
          --     ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
          --     ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
          --     ,pt_i_ModuleMessage       => '- '
          --                                  ||pt_i_ClientCode
          --                                  ||' Client Config Parameter "'
          --                                  ||vt_ConfigParameter
          --                                  ||'" = '
          --                                  ||vt_ClientSchemaName
          --     ,pt_i_OracleError         => NULL
          --     );
          --
           xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => '- Purging tables.'
               ,pt_i_OracleError         => NULL
               );
          --
          gvv_ProgressIndicator := '0040';
          --
          /*
          ** Loop through the Migration Metadata table to retrieve
          ** the staging table names to purge for the current Business
          ** Entity.
          */
          --
          gvv_SQLAction := 'DELETE';
          --
          gvv_SQLWhereClause := 'WHERE 1 = 1 '
                              ||'AND   migration_set_id = '
                              ||pt_i_MigrationSetID;
          --
          FOR  PurgingMetadata_rec
          IN   PurgingMetadata_cur
                    (
                     gct_ApplicationSuite
                    ,gct_Application
                    ,gcv_BusinessEntity
                    )
          LOOP
               --
               --** DSF 26/10/2020 - Replace with new constant for Staging Schema.
               --
               gvv_SQLTableClause := 'FROM '
                                   ||gct_StgSchema
                                   ||'.'
                                   ||PurgingMetadata_rec.stg_table;
               --
               gvv_SQLStatement := gvv_SQLAction
                                 ||gcv_SQLSpace
                                 ||gvv_SQLTableClause
                                 ||gcv_SQLSpace
                                 ||gvv_SQLWhereClause;
               --
               EXECUTE IMMEDIATE gvv_SQLStatement;
               --
               gvn_RowCount := SQL%ROWCOUNT;
               --
               xxmx_utilities_pkg.log_module_message
                    (
                     pt_i_ApplicationSuite    => gct_ApplicationSuite
                    ,pt_i_Application         => gct_Application
                    ,pt_i_BusinessEntity      => gcv_BusinessEntity
                    ,pt_i_SubEntity           => ct_SubEntity
                    ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                    ,pt_i_Phase               => ct_Phase
                    ,pt_i_Severity            => 'NOTIFICATION'
                    ,pt_i_PackageName         => gcv_PackageName
                    ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                    ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                    ,pt_i_ModuleMessage       => '  - Records purged from "'
                                                 ||PurgingMetadata_rec.stg_table
                                                 ||'" table: '
                                                 ||gvn_RowCount
                    ,pt_i_OracleError         => NULL
                    );
               --
               --gvv_SQLTableClause := 'FROM '
               --                    ||vt_ClientSchemaName
               --                    ||'.'
               --                    ||PurgingMetadata_rec.xfm_table;
               ----
               --gvv_SQLStatement := gvv_SQLAction
               --                  ||gcv_SQLSpace
               --                  ||gvv_SQLTableClause
               --                  ||gcv_SQLSpace
               --                  ||gvv_SQLWhereClause;
               ----
               --EXECUTE IMMEDIATE gvv_SQLStatement;
               ----
               --gvn_RowCount := SQL%ROWCOUNT;
               ----
               --xxmx_utilities_pkg.log_module_message
               --     (
               --      pt_i_ApplicationSuite    => gct_ApplicationSuite
               --     ,pt_i_Application         => gct_Application
               --     ,pt_i_BusinessEntity      => gcv_BusinessEntity
               --     ,pt_i_SubEntity           => ct_SubEntity
               --     ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               --     ,pt_i_Phase               => ct_Phase
               --     ,pt_i_Severity            => 'NOTIFICATION'
               --     ,pt_i_PackageName         => gcv_PackageName
               --     ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               --     ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               --     ,pt_i_ModuleMessage       => '  - Records purged from "'
               --                                  ||PurgingMetadata_rec.xfm_table
               --                                  ||'" table: '
               --                                  ||gvn_RowCount
               --     ,pt_i_OracleError         => NULL
               --     );
               --
          END LOOP;
          --
          /*
          ** Purge the records for the Business Entity Levels
          ** Levels from the Migration Details table.
          */
          --
          vv_PurgeTableName := 'xxmx_migration_details';
          --
          --** DSF 26/10/2020 - Replace with new constant for Core Schema.
          --
          gvv_SQLTableClause := 'FROM '
                              ||gct_CoreSchema
                              ||'.'
                              ||vv_PurgeTableName;
          --
          gvv_SQLStatement := gvv_SQLAction
                            ||gcv_SQLSpace
                            ||gvv_SQLTableClause
                            ||gcv_SQLSpace
                            ||gvv_SQLWhereClause;
          --
          EXECUTE IMMEDIATE gvv_SQLStatement;
          --
          gvn_RowCount := SQL%ROWCOUNT;
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => '  - Records purged from "'
                                            ||vv_PurgeTableName
                                            ||'" table: '
                                            ||gvn_RowCount
               ,pt_i_OracleError         => NULL
               );
          --
          /*
          ** Purge the records for the Business Entity
          ** from the Migration Headers table.
          */
          --** DSF 261/10/2020 - Replace with new constant for Core Schema.
          --
          vv_PurgeTableName := 'xxmx_migration_headers';
          --
          gvv_SQLTableClause := 'FROM '
                              ||gct_CoreSchema
                              ||'.'
                              ||vv_PurgeTableName;
          --
          gvv_SQLStatement := gvv_SQLAction
                            ||gcv_SQLSpace
                            ||gvv_SQLTableClause
                            ||gcv_SQLSpace
                            ||gvv_SQLWhereClause;
          --
          EXECUTE IMMEDIATE gvv_SQLStatement;
          --
          gvn_RowCount := SQL%ROWCOUNT;
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => '  - Records purged from "'
                                          ||vv_PurgeTableName
                                          ||'" table: '
                                          ||gvn_RowCount
               ,pt_i_OracleError         => NULL
               );
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => '- Purging complete.'
               ,pt_i_OracleError         => NULL
               );
          --
          COMMIT;
          --
          xxmx_utilities_pkg.log_module_message
               (
                pt_i_ApplicationSuite    => gct_ApplicationSuite
               ,pt_i_Application         => gct_Application
               ,pt_i_BusinessEntity      => gcv_BusinessEntity
               ,pt_i_SubEntity           => ct_SubEntity
               ,pt_i_MigrationSetID      => pt_i_MigrationSetID
               ,pt_i_Phase               => ct_Phase
               ,pt_i_Severity            => 'NOTIFICATION'
               ,pt_i_PackageName         => gcv_PackageName
               ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
               ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
               ,pt_i_ModuleMessage       => 'Procedure "'
                                          ||gcv_PackageName
                                          ||'.'
                                          ||cv_ProcOrFuncName
                                          ||'" completed.'
               ,pt_i_OracleError         => NULL
               );
          --
          EXCEPTION
               --
               WHEN e_ModuleError
               THEN
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => ct_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_Severity            => gvt_Severity
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => gvt_ModuleMessage
                         ,pt_i_OracleError         => NULL
                         );
                    --
                    RAISE;
                    --
               --** END e_ModuleError Exception
               --
               WHEN OTHERS
               THEN
                    --
                    ROLLBACK;
                    --
                    gvt_OracleError := SUBSTR(
                                              SQLERRM
                                              ||'** ERROR_BACKTRACE: '
                                              ||dbms_utility.format_error_backtrace
                                             ,1
                                             ,4000
                                             );
                    --
                    xxmx_utilities_pkg.log_module_message
                         (
                          pt_i_ApplicationSuite    => gct_ApplicationSuite
                         ,pt_i_Application         => gct_Application
                         ,pt_i_BusinessEntity      => gcv_BusinessEntity
                         ,pt_i_SubEntity           => ct_SubEntity
                         ,pt_i_MigrationSetID      => pt_i_MigrationSetID
                         ,pt_i_Phase               => ct_Phase
                         ,pt_i_Severity            => 'ERROR'
                         ,pt_i_PackageName         => gcv_PackageName
                         ,pt_i_ProcOrFuncName      => cv_ProcOrFuncName
                         ,pt_i_ProgressIndicator   => gvv_ProgressIndicator
                         ,pt_i_ModuleMessage       => 'Oracle error encounted after Progress Indicator.'
                         ,pt_i_OracleError         => gvt_OracleError
                         );
                    --
                    RAISE;
                    --
               --** END OTHERS Exception
               --
          --** END Exception Handler
          --
     END purge;
     --
    END xxmx_ar_customers_pkg;
    /
SHOW ERRORS PACKAGE BODY xxmx_ar_customers_pkg;
/

    
